"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[16],{19:function(e,t,n){n.d(t,{u7:function(){return Uu},Jj:function(){return Pc},IX:function(){return Tc},my:function(){return hc},xU:function(){return gu},Lz:function(){return Mc},WA:function(){return S},F8:function(){return Fc},$q:function(){return pu},W:function(){return yu},EK:function(){return U},PU:function(){return Gu},l7:function(){return oe},Ky:function(){return he},Xb:function(){return W},Cf:function(){return ic},K9:function(){return T},Me:function(){return Y},yq:function(){return y},Wi:function(){return tc},ET:function(){return th},Ab:function(){return lh},vr:function(){return hh},Fc:function(){return kc},hJ:function(){return fc},B$:function(){return mc},at:function(){return uc},oe:function(){return eh},AK:function(){return ch},TF:function(){return Cc},JU:function(){return gc},ST:function(){return xc},fH:function(){return Nc},Ix:function(){return Dc},Wu:function(){return Mu},Lx:function(){return Lu},qY:function(){return bc},GL:function(){return rh},QT:function(){return ju},kl:function(){return zu},Xk:function(){return Wu},PL:function(){return Hu},UQ:function(){return Yu},zN:function(){return Ju},nP:function(){return dh},b9:function(){return ku},vh:function(){return Au},Pb:function(){return Oc},L$:function(){return Rc},cf:function(){return nh},sc:function(){return sh},Xo:function(){return Nu},IO:function(){return Eu},iE:function(){return yc},Eo:function(){return pc},i3:function(){return ah},Bt:function(){return uh},pl:function(){return Xu},Ub:function(){return m},qK:function(){return vu},TQ:function(){return Ou},e0:function(){return Cu},r7:function(){return Zu},Mx:function(){return Ac},ar:function(){return Su}});var s=n(2238),r=n(8463),i=n(3333),o=n(4444),a=n(3510),c=n(4155);const u="@firebase/firestore";class h{constructor(e){this.uid=e}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(e){return e.uid===this.uid}}h.UNAUTHENTICATED=new h(null),h.GOOGLE_CREDENTIALS=new h("google-credentials-uid"),h.FIRST_PARTY=new h("first-party-uid"),h.MOCK_USER=new h("mock-user");let l="9.6.7";const d=new i.Yd("@firebase/firestore");function f(){return d.logLevel}function m(e){d.setLogLevel(e)}function g(e,...t){if(d.logLevel<=i.in.DEBUG){const n=t.map(w);d.debug(`Firestore (${l}): ${e}`,...n)}}function p(e,...t){if(d.logLevel<=i.in.ERROR){const n=t.map(w);d.error(`Firestore (${l}): ${e}`,...n)}}function y(e,...t){if(d.logLevel<=i.in.WARN){const n=t.map(w);d.warn(`Firestore (${l}): ${e}`,...n)}}function w(e){if("string"==typeof e)return e;try{return t=e,JSON.stringify(t)}catch(t){return e}var t}function v(e="Unexpected state"){const t=`FIRESTORE (${l}) INTERNAL ASSERTION FAILED: `+e;throw p(t),new Error(t)}function I(e,t){e||v()}function T(e,t){e||v()}function E(e,t){return e}const b={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class S extends o.ZR{constructor(e,t){super(e,t),this.code=e,this.message=t,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class x{constructor(){this.promise=new Promise(((e,t)=>{this.resolve=e,this.reject=t}))}}class N{constructor(e,t){this.user=t,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${e}`)}}class _{getToken(){return Promise.resolve(null)}invalidateToken(){}start(e,t){e.enqueueRetryable((()=>t(h.UNAUTHENTICATED)))}shutdown(){}}class k{constructor(e){this.token=e,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(e,t){this.changeListener=t,e.enqueueRetryable((()=>t(this.token.user)))}shutdown(){this.changeListener=null}}class A{constructor(e){this.t=e,this.currentUser=h.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(e,t){let n=this.i;const s=e=>this.i!==n?(n=this.i,t(e)):Promise.resolve();let r=new x;this.o=()=>{this.i++,this.currentUser=this.u(),r.resolve(),r=new x,e.enqueueRetryable((()=>s(this.currentUser)))};const i=()=>{const t=r;e.enqueueRetryable((async()=>{await t.promise,await s(this.currentUser)}))},o=e=>{g("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=e,this.auth.addAuthTokenListener(this.o),i()};this.t.onInit((e=>o(e))),setTimeout((()=>{if(!this.auth){const e=this.t.getImmediate({optional:!0});e?o(e):(g("FirebaseAuthCredentialsProvider","Auth not yet detected"),r.resolve(),r=new x)}}),0),i()}getToken(){const e=this.i,t=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(t).then((t=>this.i!==e?(g("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):t?(I("string"==typeof t.accessToken),new N(t.accessToken,this.currentUser)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.auth.removeAuthTokenListener(this.o)}u(){const e=this.auth&&this.auth.getUid();return I(null===e||"string"==typeof e),new h(e)}}class D{constructor(e,t,n){this.type="FirstParty",this.user=h.FIRST_PARTY,this.headers=new Map,this.headers.set("X-Goog-AuthUser",t);const s=e.auth.getAuthHeaderValueForFirstParty([]);s&&this.headers.set("Authorization",s),n&&this.headers.set("X-Goog-Iam-Authorization-Token",n)}}class C{constructor(e,t,n){this.h=e,this.l=t,this.m=n}getToken(){return Promise.resolve(new D(this.h,this.l,this.m))}start(e,t){e.enqueueRetryable((()=>t(h.FIRST_PARTY)))}shutdown(){}invalidateToken(){}}class O{constructor(e){this.value=e,this.type="AppCheck",this.headers=new Map,e&&e.length>0&&this.headers.set("x-firebase-appcheck",this.value)}}class R{constructor(e){this.g=e,this.forceRefresh=!1,this.appCheck=null,this.p=null}start(e,t){const n=e=>{null!=e.error&&g("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${e.error.message}`);const n=e.token!==this.p;return this.p=e.token,g("FirebaseAppCheckTokenProvider",`Received ${n?"new":"existing"} token.`),n?t(e.token):Promise.resolve()};this.o=t=>{e.enqueueRetryable((()=>n(t)))};const s=e=>{g("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=e,this.appCheck.addTokenListener(this.o)};this.g.onInit((e=>s(e))),setTimeout((()=>{if(!this.appCheck){const e=this.g.getImmediate({optional:!0});e?s(e):g("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}}),0)}getToken(){const e=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(e).then((e=>e?(I("string"==typeof e.token),this.p=e.token,new O(e.token)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.appCheck.removeTokenListener(this.o)}}class L{constructor(e,t){this.previousValue=e,t&&(t.sequenceNumberHandler=e=>this.I(e),this.T=e=>t.writeSequenceNumber(e))}I(e){return this.previousValue=Math.max(e,this.previousValue),this.previousValue}next(){const e=++this.previousValue;return this.T&&this.T(e),e}}function M(e){const t="undefined"!=typeof self&&(self.crypto||self.msCrypto),n=new Uint8Array(e);if(t&&"function"==typeof t.getRandomValues)t.getRandomValues(n);else for(let s=0;s<e;s++)n[s]=Math.floor(256*Math.random());return n}L.A=-1;class P{static R(){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t=Math.floor(256/e.length)*e.length;let n="";for(;n.length<20;){const s=M(40);for(let r=0;r<s.length;++r)n.length<20&&s[r]<t&&(n+=e.charAt(s[r]%e.length))}return n}}function V(e,t){return e<t?-1:e>t?1:0}function F(e,t,n){return e.length===t.length&&e.every(((e,s)=>n(e,t[s])))}function q(e){return e+"\0"}class U{constructor(e,t){if(this.seconds=e,this.nanoseconds=t,t<0)throw new S(b.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(t>=1e9)throw new S(b.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(e<-62135596800)throw new S(b.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e);if(e>=253402300800)throw new S(b.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e)}static now(){return U.fromMillis(Date.now())}static fromDate(e){return U.fromMillis(e.getTime())}static fromMillis(e){const t=Math.floor(e/1e3),n=Math.floor(1e6*(e-1e3*t));return new U(t,n)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(e){return this.seconds===e.seconds?V(this.nanoseconds,e.nanoseconds):V(this.seconds,e.seconds)}isEqual(e){return e.seconds===this.seconds&&e.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){const e=this.seconds- -62135596800;return String(e).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class B{constructor(e){this.timestamp=e}static fromTimestamp(e){return new B(e)}static min(){return new B(new U(0,0))}compareTo(e){return this.timestamp._compareTo(e.timestamp)}isEqual(e){return this.timestamp.isEqual(e.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}function K(e){let t=0;for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t++;return t}function G(e,t){for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t(n,e[n])}function $(e){for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}class j{constructor(e,t,n){void 0===t?t=0:t>e.length&&v(),void 0===n?n=e.length-t:n>e.length-t&&v(),this.segments=e,this.offset=t,this.len=n}get length(){return this.len}isEqual(e){return 0===j.comparator(this,e)}child(e){const t=this.segments.slice(this.offset,this.limit());return e instanceof j?e.forEach((e=>{t.push(e)})):t.push(e),this.construct(t)}limit(){return this.offset+this.length}popFirst(e){return e=void 0===e?1:e,this.construct(this.segments,this.offset+e,this.length-e)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(e){return this.segments[this.offset+e]}isEmpty(){return 0===this.length}isPrefixOf(e){if(e.length<this.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}isImmediateParentOf(e){if(this.length+1!==e.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}forEach(e){for(let t=this.offset,n=this.limit();t<n;t++)e(this.segments[t])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(e,t){const n=Math.min(e.length,t.length);for(let s=0;s<n;s++){const n=e.get(s),r=t.get(s);if(n<r)return-1;if(n>r)return 1}return e.length<t.length?-1:e.length>t.length?1:0}}class Q extends j{construct(e,t,n){return new Q(e,t,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}static fromString(...e){const t=[];for(const n of e){if(n.indexOf("//")>=0)throw new S(b.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);t.push(...n.split("/").filter((e=>e.length>0)))}return new Q(t)}static emptyPath(){return new Q([])}}const z=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class W extends j{construct(e,t,n){return new W(e,t,n)}static isValidIdentifier(e){return z.test(e)}canonicalString(){return this.toArray().map((e=>(e=e.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),W.isValidIdentifier(e)||(e="`"+e+"`"),e))).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&"__name__"===this.get(0)}static keyField(){return new W(["__name__"])}static fromServerFormat(e){const t=[];let n="",s=0;const r=()=>{if(0===n.length)throw new S(b.INVALID_ARGUMENT,`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);t.push(n),n=""};let i=!1;for(;s<e.length;){const t=e[s];if("\\"===t){if(s+1===e.length)throw new S(b.INVALID_ARGUMENT,"Path has trailing escape character: "+e);const t=e[s+1];if("\\"!==t&&"."!==t&&"`"!==t)throw new S(b.INVALID_ARGUMENT,"Path has invalid escape sequence: "+e);n+=t,s+=2}else"`"===t?(i=!i,s++):"."!==t||i?(n+=t,s++):(r(),s++)}if(r(),i)throw new S(b.INVALID_ARGUMENT,"Unterminated ` in path: "+e);return new W(t)}static emptyPath(){return new W([])}}class H{constructor(e){this.fields=e,e.sort(W.comparator)}covers(e){for(const t of this.fields)if(t.isPrefixOf(e))return!0;return!1}isEqual(e){return F(this.fields,e.fields,((e,t)=>e.isEqual(t)))}}function Y(){return"undefined"!=typeof atob}class J{constructor(e){this.binaryString=e}static fromBase64String(e){const t=atob(e);return new J(t)}static fromUint8Array(e){const t=function(e){let t="";for(let n=0;n<e.length;++n)t+=String.fromCharCode(e[n]);return t}(e);return new J(t)}[Symbol.iterator](){let e=0;return{next:()=>e<this.binaryString.length?{value:this.binaryString.charCodeAt(e++),done:!1}:{value:void 0,done:!0}}}toBase64(){return e=this.binaryString,btoa(e);var e}toUint8Array(){return function(e){const t=new Uint8Array(e.length);for(let n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(e){return V(this.binaryString,e.binaryString)}isEqual(e){return this.binaryString===e.binaryString}}J.EMPTY_BYTE_STRING=new J("");const X=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function Z(e){if(I(!!e),"string"==typeof e){let t=0;const n=X.exec(e);if(I(!!n),n[1]){let e=n[1];e=(e+"000000000").substr(0,9),t=Number(e)}const s=new Date(e);return{seconds:Math.floor(s.getTime()/1e3),nanos:t}}return{seconds:ee(e.seconds),nanos:ee(e.nanos)}}function ee(e){return"number"==typeof e?e:"string"==typeof e?Number(e):0}function te(e){return"string"==typeof e?J.fromBase64String(e):J.fromUint8Array(e)}function ne(e){var t,n;return"server_timestamp"===(null===(n=((null===(t=null==e?void 0:e.mapValue)||void 0===t?void 0:t.fields)||{}).__type__)||void 0===n?void 0:n.stringValue)}function se(e){const t=e.mapValue.fields.__previous_value__;return ne(t)?se(t):t}function re(e){const t=Z(e.mapValue.fields.__local_write_time__.timestampValue);return new U(t.seconds,t.nanos)}class ie{constructor(e,t,n,s,r,i,o,a){this.databaseId=e,this.appId=t,this.persistenceKey=n,this.host=s,this.ssl=r,this.forceLongPolling=i,this.autoDetectLongPolling=o,this.useFetchStreams=a}}class oe{constructor(e,t){this.projectId=e,this.database=t||"(default)"}static empty(){return new oe("","")}get isDefaultDatabase(){return"(default)"===this.database}isEqual(e){return e instanceof oe&&e.projectId===this.projectId&&e.database===this.database}}function ae(e){return null==e}function ce(e){return 0===e&&1/e==-1/0}function ue(e){return"number"==typeof e&&Number.isInteger(e)&&!ce(e)&&e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER}class he{constructor(e){this.path=e}static fromPath(e){return new he(Q.fromString(e))}static fromName(e){return new he(Q.fromString(e).popFirst(5))}static empty(){return new he(Q.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(e){return this.path.length>=2&&this.path.get(this.path.length-2)===e}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(e){return null!==e&&0===Q.comparator(this.path,e.path)}toString(){return this.path.toString()}static comparator(e,t){return Q.comparator(e.path,t.path)}static isDocumentKey(e){return e.length%2==0}static fromSegments(e){return new he(new Q(e.slice()))}}const le={mapValue:{fields:{__type__:{stringValue:"__max___"}}}};function de(e){return"nullValue"in e?0:"booleanValue"in e?1:"integerValue"in e||"doubleValue"in e?2:"timestampValue"in e?3:"stringValue"in e?5:"bytesValue"in e?6:"referenceValue"in e?7:"geoPointValue"in e?8:"arrayValue"in e?9:"mapValue"in e?ne(e)?4:10:v()}function fe(e,t){if(e===t)return!0;const n=de(e);if(n!==de(t))return!1;switch(n){case 0:return!0;case 1:return e.booleanValue===t.booleanValue;case 4:return re(e).isEqual(re(t));case 3:return function(e,t){if("string"==typeof e.timestampValue&&"string"==typeof t.timestampValue&&e.timestampValue.length===t.timestampValue.length)return e.timestampValue===t.timestampValue;const n=Z(e.timestampValue),s=Z(t.timestampValue);return n.seconds===s.seconds&&n.nanos===s.nanos}(e,t);case 5:return e.stringValue===t.stringValue;case 6:return function(e,t){return te(e.bytesValue).isEqual(te(t.bytesValue))}(e,t);case 7:return e.referenceValue===t.referenceValue;case 8:return function(e,t){return ee(e.geoPointValue.latitude)===ee(t.geoPointValue.latitude)&&ee(e.geoPointValue.longitude)===ee(t.geoPointValue.longitude)}(e,t);case 2:return function(e,t){if("integerValue"in e&&"integerValue"in t)return ee(e.integerValue)===ee(t.integerValue);if("doubleValue"in e&&"doubleValue"in t){const n=ee(e.doubleValue),s=ee(t.doubleValue);return n===s?ce(n)===ce(s):isNaN(n)&&isNaN(s)}return!1}(e,t);case 9:return F(e.arrayValue.values||[],t.arrayValue.values||[],fe);case 10:return function(e,t){const n=e.mapValue.fields||{},s=t.mapValue.fields||{};if(K(n)!==K(s))return!1;for(const r in n)if(n.hasOwnProperty(r)&&(void 0===s[r]||!fe(n[r],s[r])))return!1;return!0}(e,t);default:return v()}}function me(e,t){return void 0!==(e.values||[]).find((e=>fe(e,t)))}function ge(e,t){if(e===t)return 0;const n=de(e),s=de(t);if(n!==s)return V(n,s);switch(n){case 0:return 0;case 1:return V(e.booleanValue,t.booleanValue);case 2:return function(e,t){const n=ee(e.integerValue||e.doubleValue),s=ee(t.integerValue||t.doubleValue);return n<s?-1:n>s?1:n===s?0:isNaN(n)?isNaN(s)?0:-1:1}(e,t);case 3:return pe(e.timestampValue,t.timestampValue);case 4:return pe(re(e),re(t));case 5:return V(e.stringValue,t.stringValue);case 6:return function(e,t){const n=te(e),s=te(t);return n.compareTo(s)}(e.bytesValue,t.bytesValue);case 7:return function(e,t){const n=e.split("/"),s=t.split("/");for(let r=0;r<n.length&&r<s.length;r++){const e=V(n[r],s[r]);if(0!==e)return e}return V(n.length,s.length)}(e.referenceValue,t.referenceValue);case 8:return function(e,t){const n=V(ee(e.latitude),ee(t.latitude));return 0!==n?n:V(ee(e.longitude),ee(t.longitude))}(e.geoPointValue,t.geoPointValue);case 9:return function(e,t){const n=e.values||[],s=t.values||[];for(let r=0;r<n.length&&r<s.length;++r){const e=ge(n[r],s[r]);if(e)return e}return V(n.length,s.length)}(e.arrayValue,t.arrayValue);case 10:return function(e,t){const n=e.fields||{},s=Object.keys(n),r=t.fields||{},i=Object.keys(r);s.sort(),i.sort();for(let o=0;o<s.length&&o<i.length;++o){const e=V(s[o],i[o]);if(0!==e)return e;const t=ge(n[s[o]],r[i[o]]);if(0!==t)return t}return V(s.length,i.length)}(e.mapValue,t.mapValue);default:throw v()}}function pe(e,t){if("string"==typeof e&&"string"==typeof t&&e.length===t.length)return V(e,t);const n=Z(e),s=Z(t),r=V(n.seconds,s.seconds);return 0!==r?r:V(n.nanos,s.nanos)}function ye(e){return we(e)}function we(e){return"nullValue"in e?"null":"booleanValue"in e?""+e.booleanValue:"integerValue"in e?""+e.integerValue:"doubleValue"in e?""+e.doubleValue:"timestampValue"in e?function(e){const t=Z(e);return`time(${t.seconds},${t.nanos})`}(e.timestampValue):"stringValue"in e?e.stringValue:"bytesValue"in e?te(e.bytesValue).toBase64():"referenceValue"in e?(n=e.referenceValue,he.fromName(n).toString()):"geoPointValue"in e?`geo(${(t=e.geoPointValue).latitude},${t.longitude})`:"arrayValue"in e?function(e){let t="[",n=!0;for(const s of e.values||[])n?n=!1:t+=",",t+=we(s);return t+"]"}(e.arrayValue):"mapValue"in e?function(e){const t=Object.keys(e.fields||{}).sort();let n="{",s=!0;for(const r of t)s?s=!1:n+=",",n+=`${r}:${we(e.fields[r])}`;return n+"}"}(e.mapValue):v();var t,n}function ve(e,t){return{referenceValue:`projects/${e.projectId}/databases/${e.database}/documents/${t.path.canonicalString()}`}}function Ie(e){return!!e&&"integerValue"in e}function Te(e){return!!e&&"arrayValue"in e}function Ee(e){return!!e&&"nullValue"in e}function be(e){return!!e&&"doubleValue"in e&&isNaN(Number(e.doubleValue))}function Se(e){return!!e&&"mapValue"in e}function xe(e){if(e.geoPointValue)return{geoPointValue:Object.assign({},e.geoPointValue)};if(e.timestampValue&&"object"==typeof e.timestampValue)return{timestampValue:Object.assign({},e.timestampValue)};if(e.mapValue){const t={mapValue:{fields:{}}};return G(e.mapValue.fields,((e,n)=>t.mapValue.fields[e]=xe(n))),t}if(e.arrayValue){const t={arrayValue:{values:[]}};for(let n=0;n<(e.arrayValue.values||[]).length;++n)t.arrayValue.values[n]=xe(e.arrayValue.values[n]);return t}return Object.assign({},e)}class Ne{constructor(e){this.value=e}static empty(){return new Ne({mapValue:{}})}field(e){if(e.isEmpty())return this.value;{let t=this.value;for(let n=0;n<e.length-1;++n)if(t=(t.mapValue.fields||{})[e.get(n)],!Se(t))return null;return t=(t.mapValue.fields||{})[e.lastSegment()],t||null}}set(e,t){this.getFieldsMap(e.popLast())[e.lastSegment()]=xe(t)}setAll(e){let t=W.emptyPath(),n={},s=[];e.forEach(((e,r)=>{if(!t.isImmediateParentOf(r)){const e=this.getFieldsMap(t);this.applyChanges(e,n,s),n={},s=[],t=r.popLast()}e?n[r.lastSegment()]=xe(e):s.push(r.lastSegment())}));const r=this.getFieldsMap(t);this.applyChanges(r,n,s)}delete(e){const t=this.field(e.popLast());Se(t)&&t.mapValue.fields&&delete t.mapValue.fields[e.lastSegment()]}isEqual(e){return fe(this.value,e.value)}getFieldsMap(e){let t=this.value;t.mapValue.fields||(t.mapValue={fields:{}});for(let n=0;n<e.length;++n){let s=t.mapValue.fields[e.get(n)];Se(s)&&s.mapValue.fields||(s={mapValue:{fields:{}}},t.mapValue.fields[e.get(n)]=s),t=s}return t.mapValue.fields}applyChanges(e,t,n){G(t,((t,n)=>e[t]=n));for(const s of n)delete e[s]}clone(){return new Ne(xe(this.value))}}function _e(e){const t=[];return G(e.fields,((e,n)=>{const s=new W([e]);if(Se(n)){const e=_e(n.mapValue).fields;if(0===e.length)t.push(s);else for(const n of e)t.push(s.child(n))}else t.push(s)})),new H(t)}class ke{constructor(e,t,n,s,r,i){this.key=e,this.documentType=t,this.version=n,this.readTime=s,this.data=r,this.documentState=i}static newInvalidDocument(e){return new ke(e,0,B.min(),B.min(),Ne.empty(),0)}static newFoundDocument(e,t,n){return new ke(e,1,t,B.min(),n,0)}static newNoDocument(e,t){return new ke(e,2,t,B.min(),Ne.empty(),0)}static newUnknownDocument(e,t){return new ke(e,3,t,B.min(),Ne.empty(),2)}convertToFoundDocument(e,t){return this.version=e,this.documentType=1,this.data=t,this.documentState=0,this}convertToNoDocument(e){return this.version=e,this.documentType=2,this.data=Ne.empty(),this.documentState=0,this}convertToUnknownDocument(e){return this.version=e,this.documentType=3,this.data=Ne.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this}setReadTime(e){return this.readTime=e,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(e){return e instanceof ke&&this.key.isEqual(e.key)&&this.version.isEqual(e.version)&&this.documentType===e.documentType&&this.documentState===e.documentState&&this.data.isEqual(e.data)}mutableCopy(){return new ke(this.key,this.documentType,this.version,this.readTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class Ae{constructor(e,t,n,s){this.indexId=e,this.collectionGroup=t,this.fields=n,this.indexState=s}}Ae.UNKNOWN_ID=-1;class De{constructor(e,t){this.fieldPath=e,this.kind=t}}class Ce{constructor(e,t){this.sequenceNumber=e,this.offset=t}static empty(){return new Ce(0,Oe.min())}}class Oe{constructor(e,t,n){this.readTime=e,this.documentKey=t,this.largestBatchId=n}static min(){return new Oe(B.min(),he.empty(),-1)}}class Re{constructor(e,t=null,n=[],s=[],r=null,i=null,o=null){this.path=e,this.collectionGroup=t,this.orderBy=n,this.filters=s,this.limit=r,this.startAt=i,this.endAt=o,this.P=null}}function Le(e,t=null,n=[],s=[],r=null,i=null,o=null){return new Re(e,t,n,s,r,i,o)}function Me(e){const t=E(e);if(null===t.P){let e=t.path.canonicalString();null!==t.collectionGroup&&(e+="|cg:"+t.collectionGroup),e+="|f:",e+=t.filters.map((e=>{return(t=e).field.canonicalString()+t.op.toString()+ye(t.value);var t})).join(","),e+="|ob:",e+=t.orderBy.map((e=>function(e){return e.field.canonicalString()+e.dir}(e))).join(","),ae(t.limit)||(e+="|l:",e+=t.limit),t.startAt&&(e+="|lb:",e+=t.startAt.inclusive?"b:":"a:",e+=t.startAt.position.map((e=>ye(e))).join(",")),t.endAt&&(e+="|ub:",e+=t.endAt.inclusive?"a:":"b:",e+=t.endAt.position.map((e=>ye(e))).join(",")),t.P=e}return t.P}function Pe(e,t){if(e.limit!==t.limit)return!1;if(e.orderBy.length!==t.orderBy.length)return!1;for(let r=0;r<e.orderBy.length;r++)if(!He(e.orderBy[r],t.orderBy[r]))return!1;if(e.filters.length!==t.filters.length)return!1;for(let r=0;r<e.filters.length;r++)if(n=e.filters[r],s=t.filters[r],n.op!==s.op||!n.field.isEqual(s.field)||!fe(n.value,s.value))return!1;var n,s;return e.collectionGroup===t.collectionGroup&&!!e.path.isEqual(t.path)&&!!Je(e.startAt,t.startAt)&&Je(e.endAt,t.endAt)}function Ve(e){return he.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}class Fe extends class{}{constructor(e,t,n){super(),this.field=e,this.op=t,this.value=n}static create(e,t,n){return e.isKeyField()?"in"===t||"not-in"===t?this.v(e,t,n):new qe(e,t,n):"array-contains"===t?new Ge(e,n):"in"===t?new $e(e,n):"not-in"===t?new je(e,n):"array-contains-any"===t?new Qe(e,n):new Fe(e,t,n)}static v(e,t,n){return"in"===t?new Ue(e,n):new Be(e,n)}matches(e){const t=e.data.field(this.field);return"!="===this.op?null!==t&&this.V(ge(t,this.value)):null!==t&&de(this.value)===de(t)&&this.V(ge(t,this.value))}V(e){switch(this.op){case"<":return e<0;case"<=":return e<=0;case"==":return 0===e;case"!=":return 0!==e;case">":return e>0;case">=":return e>=0;default:return v()}}S(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}}class qe extends Fe{constructor(e,t,n){super(e,t,n),this.key=he.fromName(n.referenceValue)}matches(e){const t=he.comparator(e.key,this.key);return this.V(t)}}class Ue extends Fe{constructor(e,t){super(e,"in",t),this.keys=Ke("in",t)}matches(e){return this.keys.some((t=>t.isEqual(e.key)))}}class Be extends Fe{constructor(e,t){super(e,"not-in",t),this.keys=Ke("not-in",t)}matches(e){return!this.keys.some((t=>t.isEqual(e.key)))}}function Ke(e,t){var n;return((null===(n=t.arrayValue)||void 0===n?void 0:n.values)||[]).map((e=>he.fromName(e.referenceValue)))}class Ge extends Fe{constructor(e,t){super(e,"array-contains",t)}matches(e){const t=e.data.field(this.field);return Te(t)&&me(t.arrayValue,this.value)}}class $e extends Fe{constructor(e,t){super(e,"in",t)}matches(e){const t=e.data.field(this.field);return null!==t&&me(this.value.arrayValue,t)}}class je extends Fe{constructor(e,t){super(e,"not-in",t)}matches(e){if(me(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;const t=e.data.field(this.field);return null!==t&&!me(this.value.arrayValue,t)}}class Qe extends Fe{constructor(e,t){super(e,"array-contains-any",t)}matches(e){const t=e.data.field(this.field);return!(!Te(t)||!t.arrayValue.values)&&t.arrayValue.values.some((e=>me(this.value.arrayValue,e)))}}class ze{constructor(e,t){this.position=e,this.inclusive=t}}class We{constructor(e,t="asc"){this.field=e,this.dir=t}}function He(e,t){return e.dir===t.dir&&e.field.isEqual(t.field)}function Ye(e,t,n){let s=0;for(let r=0;r<e.position.length;r++){const i=t[r],o=e.position[r];if(s=i.field.isKeyField()?he.comparator(he.fromName(o.referenceValue),n.key):ge(o,n.data.field(i.field)),"desc"===i.dir&&(s*=-1),0!==s)break}return s}function Je(e,t){if(null===e)return null===t;if(null===t)return!1;if(e.inclusive!==t.inclusive||e.position.length!==t.position.length)return!1;for(let n=0;n<e.position.length;n++)if(!fe(e.position[n],t.position[n]))return!1;return!0}class Xe{constructor(e,t=null,n=[],s=[],r=null,i="F",o=null,a=null){this.path=e,this.collectionGroup=t,this.explicitOrderBy=n,this.filters=s,this.limit=r,this.limitType=i,this.startAt=o,this.endAt=a,this.D=null,this.C=null,this.startAt,this.endAt}}function Ze(e,t,n,s,r,i,o,a){return new Xe(e,t,n,s,r,i,o,a)}function et(e){return new Xe(e)}function tt(e){return!ae(e.limit)&&"F"===e.limitType}function nt(e){return!ae(e.limit)&&"L"===e.limitType}function st(e){return e.explicitOrderBy.length>0?e.explicitOrderBy[0].field:null}function rt(e){for(const t of e.filters)if(t.S())return t.field;return null}function it(e){return null!==e.collectionGroup}function ot(e){const t=E(e);if(null===t.D){t.D=[];const e=rt(t),n=st(t);if(null!==e&&null===n)e.isKeyField()||t.D.push(new We(e)),t.D.push(new We(W.keyField(),"asc"));else{let e=!1;for(const n of t.explicitOrderBy)t.D.push(n),n.field.isKeyField()&&(e=!0);if(!e){const e=t.explicitOrderBy.length>0?t.explicitOrderBy[t.explicitOrderBy.length-1].dir:"asc";t.D.push(new We(W.keyField(),e))}}}return t.D}function at(e){const t=E(e);if(!t.C)if("F"===t.limitType)t.C=Le(t.path,t.collectionGroup,ot(t),t.filters,t.limit,t.startAt,t.endAt);else{const e=[];for(const r of ot(t)){const t="desc"===r.dir?"asc":"desc";e.push(new We(r.field,t))}const n=t.endAt?new ze(t.endAt.position,!t.endAt.inclusive):null,s=t.startAt?new ze(t.startAt.position,!t.startAt.inclusive):null;t.C=Le(t.path,t.collectionGroup,e,t.filters,t.limit,n,s)}return t.C}function ct(e,t,n){return new Xe(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),t,n,e.startAt,e.endAt)}function ut(e,t){return Pe(at(e),at(t))&&e.limitType===t.limitType}function ht(e){return`${Me(at(e))}|lt:${e.limitType}`}function lt(e){return`Query(target=${function(e){let t=e.path.canonicalString();return null!==e.collectionGroup&&(t+=" collectionGroup="+e.collectionGroup),e.filters.length>0&&(t+=`, filters: [${e.filters.map((e=>{return`${(t=e).field.canonicalString()} ${t.op} ${ye(t.value)}`;var t})).join(", ")}]`),ae(e.limit)||(t+=", limit: "+e.limit),e.orderBy.length>0&&(t+=`, orderBy: [${e.orderBy.map((e=>function(e){return`${e.field.canonicalString()} (${e.dir})`}(e))).join(", ")}]`),e.startAt&&(t+=", startAt: ",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map((e=>ye(e))).join(",")),e.endAt&&(t+=", endAt: ",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map((e=>ye(e))).join(",")),`Target(${t})`}(at(e))}; limitType=${e.limitType})`}function dt(e,t){return t.isFoundDocument()&&function(e,t){const n=t.key.path;return null!==e.collectionGroup?t.key.hasCollectionId(e.collectionGroup)&&e.path.isPrefixOf(n):he.isDocumentKey(e.path)?e.path.isEqual(n):e.path.isImmediateParentOf(n)}(e,t)&&function(e,t){for(const n of e.explicitOrderBy)if(!n.field.isKeyField()&&null===t.data.field(n.field))return!1;return!0}(e,t)&&function(e,t){for(const n of e.filters)if(!n.matches(t))return!1;return!0}(e,t)&&function(e,t){return!(e.startAt&&!function(e,t,n){const s=Ye(e,t,n);return e.inclusive?s<=0:s<0}(e.startAt,ot(e),t))&&!(e.endAt&&!function(e,t,n){const s=Ye(e,t,n);return e.inclusive?s>=0:s>0}(e.endAt,ot(e),t))}(e,t)}function ft(e){return(t,n)=>{let s=!1;for(const r of ot(e)){const e=mt(r,t,n);if(0!==e)return e;s=s||r.field.isKeyField()}return 0}}function mt(e,t,n){const s=e.field.isKeyField()?he.comparator(t.key,n.key):function(e,t,n){const s=t.data.field(e),r=n.data.field(e);return null!==s&&null!==r?ge(s,r):v()}(e.field,t,n);switch(e.dir){case"asc":return s;case"desc":return-1*s;default:return v()}}function gt(e,t){if(e.N){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:ce(t)?"-0":t}}function pt(e){return{integerValue:""+e}}function yt(e,t){return ue(t)?pt(t):gt(e,t)}class wt{constructor(){this._=void 0}}function vt(e,t,n){return e instanceof Et?function(e,t){const n={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:e.seconds,nanos:e.nanoseconds}}}};return t&&(n.fields.__previous_value__=t),{mapValue:n}}(n,t):e instanceof bt?St(e,t):e instanceof xt?Nt(e,t):function(e,t){const n=Tt(e,t),s=kt(n)+kt(e.k);return Ie(n)&&Ie(e.k)?pt(s):gt(e.O,s)}(e,t)}function It(e,t,n){return e instanceof bt?St(e,t):e instanceof xt?Nt(e,t):n}function Tt(e,t){return e instanceof _t?Ie(n=t)||function(e){return!!e&&"doubleValue"in e}(n)?t:{integerValue:0}:null;var n}class Et extends wt{}class bt extends wt{constructor(e){super(),this.elements=e}}function St(e,t){const n=At(t);for(const s of e.elements)n.some((e=>fe(e,s)))||n.push(s);return{arrayValue:{values:n}}}class xt extends wt{constructor(e){super(),this.elements=e}}function Nt(e,t){let n=At(t);for(const s of e.elements)n=n.filter((e=>!fe(e,s)));return{arrayValue:{values:n}}}class _t extends wt{constructor(e,t){super(),this.O=e,this.k=t}}function kt(e){return ee(e.integerValue||e.doubleValue)}function At(e){return Te(e)&&e.arrayValue.values?e.arrayValue.values.slice():[]}class Dt{constructor(e,t){this.field=e,this.transform=t}}class Ct{constructor(e,t){this.version=e,this.transformResults=t}}class Ot{constructor(e,t){this.updateTime=e,this.exists=t}static none(){return new Ot}static exists(e){return new Ot(void 0,e)}static updateTime(e){return new Ot(e)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(e){return this.exists===e.exists&&(this.updateTime?!!e.updateTime&&this.updateTime.isEqual(e.updateTime):!e.updateTime)}}function Rt(e,t){return void 0!==e.updateTime?t.isFoundDocument()&&t.version.isEqual(e.updateTime):void 0===e.exists||e.exists===t.isFoundDocument()}class Lt{}function Mt(e,t,n){e instanceof Ut?function(e,t,n){const s=e.value.clone(),r=Gt(e.fieldTransforms,t,n.transformResults);s.setAll(r),t.convertToFoundDocument(n.version,s).setHasCommittedMutations()}(e,t,n):e instanceof Bt?function(e,t,n){if(!Rt(e.precondition,t))return void t.convertToUnknownDocument(n.version);const s=Gt(e.fieldTransforms,t,n.transformResults),r=t.data;r.setAll(Kt(e)),r.setAll(s),t.convertToFoundDocument(n.version,r).setHasCommittedMutations()}(e,t,n):function(e,t,n){t.convertToNoDocument(n.version).setHasCommittedMutations()}(0,t,n)}function Pt(e,t,n){e instanceof Ut?function(e,t,n){if(!Rt(e.precondition,t))return;const s=e.value.clone(),r=$t(e.fieldTransforms,n,t);s.setAll(r),t.convertToFoundDocument(qt(t),s).setHasLocalMutations()}(e,t,n):e instanceof Bt?function(e,t,n){if(!Rt(e.precondition,t))return;const s=$t(e.fieldTransforms,n,t),r=t.data;r.setAll(Kt(e)),r.setAll(s),t.convertToFoundDocument(qt(t),r).setHasLocalMutations()}(e,t,n):function(e,t){Rt(e.precondition,t)&&t.convertToNoDocument(B.min())}(e,t)}function Vt(e,t){let n=null;for(const s of e.fieldTransforms){const e=t.data.field(s.field),r=Tt(s.transform,e||null);null!=r&&(null==n&&(n=Ne.empty()),n.set(s.field,r))}return n||null}function Ft(e,t){return e.type===t.type&&!!e.key.isEqual(t.key)&&!!e.precondition.isEqual(t.precondition)&&!!function(e,t){return void 0===e&&void 0===t||!(!e||!t)&&F(e,t,((e,t)=>function(e,t){return e.field.isEqual(t.field)&&function(e,t){return e instanceof bt&&t instanceof bt||e instanceof xt&&t instanceof xt?F(e.elements,t.elements,fe):e instanceof _t&&t instanceof _t?fe(e.k,t.k):e instanceof Et&&t instanceof Et}(e.transform,t.transform)}(e,t)))}(e.fieldTransforms,t.fieldTransforms)&&(0===e.type?e.value.isEqual(t.value):1!==e.type||e.data.isEqual(t.data)&&e.fieldMask.isEqual(t.fieldMask))}function qt(e){return e.isFoundDocument()?e.version:B.min()}class Ut extends Lt{constructor(e,t,n,s=[]){super(),this.key=e,this.value=t,this.precondition=n,this.fieldTransforms=s,this.type=0}}class Bt extends Lt{constructor(e,t,n,s,r=[]){super(),this.key=e,this.data=t,this.fieldMask=n,this.precondition=s,this.fieldTransforms=r,this.type=1}}function Kt(e){const t=new Map;return e.fieldMask.fields.forEach((n=>{if(!n.isEmpty()){const s=e.data.field(n);t.set(n,s)}})),t}function Gt(e,t,n){const s=new Map;I(e.length===n.length);for(let r=0;r<n.length;r++){const i=e[r],o=i.transform,a=t.data.field(i.field);s.set(i.field,It(o,a,n[r]))}return s}function $t(e,t,n){const s=new Map;for(const r of e){const e=r.transform,i=n.data.field(r.field);s.set(r.field,vt(e,i,t))}return s}class jt extends Lt{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=2,this.fieldTransforms=[]}}class Qt extends Lt{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=3,this.fieldTransforms=[]}}class zt{constructor(e){this.count=e}}var Wt,Ht;function Yt(e){switch(e){default:return v();case b.CANCELLED:case b.UNKNOWN:case b.DEADLINE_EXCEEDED:case b.RESOURCE_EXHAUSTED:case b.INTERNAL:case b.UNAVAILABLE:case b.UNAUTHENTICATED:return!1;case b.INVALID_ARGUMENT:case b.NOT_FOUND:case b.ALREADY_EXISTS:case b.PERMISSION_DENIED:case b.FAILED_PRECONDITION:case b.ABORTED:case b.OUT_OF_RANGE:case b.UNIMPLEMENTED:case b.DATA_LOSS:return!0}}function Jt(e){if(void 0===e)return p("GRPC error has no .code"),b.UNKNOWN;switch(e){case Wt.OK:return b.OK;case Wt.CANCELLED:return b.CANCELLED;case Wt.UNKNOWN:return b.UNKNOWN;case Wt.DEADLINE_EXCEEDED:return b.DEADLINE_EXCEEDED;case Wt.RESOURCE_EXHAUSTED:return b.RESOURCE_EXHAUSTED;case Wt.INTERNAL:return b.INTERNAL;case Wt.UNAVAILABLE:return b.UNAVAILABLE;case Wt.UNAUTHENTICATED:return b.UNAUTHENTICATED;case Wt.INVALID_ARGUMENT:return b.INVALID_ARGUMENT;case Wt.NOT_FOUND:return b.NOT_FOUND;case Wt.ALREADY_EXISTS:return b.ALREADY_EXISTS;case Wt.PERMISSION_DENIED:return b.PERMISSION_DENIED;case Wt.FAILED_PRECONDITION:return b.FAILED_PRECONDITION;case Wt.ABORTED:return b.ABORTED;case Wt.OUT_OF_RANGE:return b.OUT_OF_RANGE;case Wt.UNIMPLEMENTED:return b.UNIMPLEMENTED;case Wt.DATA_LOSS:return b.DATA_LOSS;default:return v()}}(Ht=Wt||(Wt={}))[Ht.OK=0]="OK",Ht[Ht.CANCELLED=1]="CANCELLED",Ht[Ht.UNKNOWN=2]="UNKNOWN",Ht[Ht.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",Ht[Ht.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",Ht[Ht.NOT_FOUND=5]="NOT_FOUND",Ht[Ht.ALREADY_EXISTS=6]="ALREADY_EXISTS",Ht[Ht.PERMISSION_DENIED=7]="PERMISSION_DENIED",Ht[Ht.UNAUTHENTICATED=16]="UNAUTHENTICATED",Ht[Ht.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",Ht[Ht.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",Ht[Ht.ABORTED=10]="ABORTED",Ht[Ht.OUT_OF_RANGE=11]="OUT_OF_RANGE",Ht[Ht.UNIMPLEMENTED=12]="UNIMPLEMENTED",Ht[Ht.INTERNAL=13]="INTERNAL",Ht[Ht.UNAVAILABLE=14]="UNAVAILABLE",Ht[Ht.DATA_LOSS=15]="DATA_LOSS";class Xt{constructor(e,t){this.comparator=e,this.root=t||en.EMPTY}insert(e,t){return new Xt(this.comparator,this.root.insert(e,t,this.comparator).copy(null,null,en.BLACK,null,null))}remove(e){return new Xt(this.comparator,this.root.remove(e,this.comparator).copy(null,null,en.BLACK,null,null))}get(e){let t=this.root;for(;!t.isEmpty();){const n=this.comparator(e,t.key);if(0===n)return t.value;n<0?t=t.left:n>0&&(t=t.right)}return null}indexOf(e){let t=0,n=this.root;for(;!n.isEmpty();){const s=this.comparator(e,n.key);if(0===s)return t+n.left.size;s<0?n=n.left:(t+=n.left.size+1,n=n.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(e){return this.root.inorderTraversal(e)}forEach(e){this.inorderTraversal(((t,n)=>(e(t,n),!1)))}toString(){const e=[];return this.inorderTraversal(((t,n)=>(e.push(`${t}:${n}`),!1))),`{${e.join(", ")}}`}reverseTraversal(e){return this.root.reverseTraversal(e)}getIterator(){return new Zt(this.root,null,this.comparator,!1)}getIteratorFrom(e){return new Zt(this.root,e,this.comparator,!1)}getReverseIterator(){return new Zt(this.root,null,this.comparator,!0)}getReverseIteratorFrom(e){return new Zt(this.root,e,this.comparator,!0)}}class Zt{constructor(e,t,n,s){this.isReverse=s,this.nodeStack=[];let r=1;for(;!e.isEmpty();)if(r=t?n(e.key,t):1,s&&(r*=-1),r<0)e=this.isReverse?e.left:e.right;else{if(0===r){this.nodeStack.push(e);break}this.nodeStack.push(e),e=this.isReverse?e.right:e.left}}getNext(){let e=this.nodeStack.pop();const t={key:e.key,value:e.value};if(this.isReverse)for(e=e.left;!e.isEmpty();)this.nodeStack.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack.push(e),e=e.left;return t}hasNext(){return this.nodeStack.length>0}peek(){if(0===this.nodeStack.length)return null;const e=this.nodeStack[this.nodeStack.length-1];return{key:e.key,value:e.value}}}class en{constructor(e,t,n,s,r){this.key=e,this.value=t,this.color=null!=n?n:en.RED,this.left=null!=s?s:en.EMPTY,this.right=null!=r?r:en.EMPTY,this.size=this.left.size+1+this.right.size}copy(e,t,n,s,r){return new en(null!=e?e:this.key,null!=t?t:this.value,null!=n?n:this.color,null!=s?s:this.left,null!=r?r:this.right)}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,n){let s=this;const r=n(e,s.key);return s=r<0?s.copy(null,null,null,s.left.insert(e,t,n),null):0===r?s.copy(null,t,null,null,null):s.copy(null,null,null,null,s.right.insert(e,t,n)),s.fixUp()}removeMin(){if(this.left.isEmpty())return en.EMPTY;let e=this;return e.left.isRed()||e.left.left.isRed()||(e=e.moveRedLeft()),e=e.copy(null,null,null,e.left.removeMin(),null),e.fixUp()}remove(e,t){let n,s=this;if(t(e,s.key)<0)s.left.isEmpty()||s.left.isRed()||s.left.left.isRed()||(s=s.moveRedLeft()),s=s.copy(null,null,null,s.left.remove(e,t),null);else{if(s.left.isRed()&&(s=s.rotateRight()),s.right.isEmpty()||s.right.isRed()||s.right.left.isRed()||(s=s.moveRedRight()),0===t(e,s.key)){if(s.right.isEmpty())return en.EMPTY;n=s.right.min(),s=s.copy(n.key,n.value,null,null,s.right.removeMin())}s=s.copy(null,null,null,null,s.right.remove(e,t))}return s.fixUp()}isRed(){return this.color}fixUp(){let e=this;return e.right.isRed()&&!e.left.isRed()&&(e=e.rotateLeft()),e.left.isRed()&&e.left.left.isRed()&&(e=e.rotateRight()),e.left.isRed()&&e.right.isRed()&&(e=e.colorFlip()),e}moveRedLeft(){let e=this.colorFlip();return e.right.left.isRed()&&(e=e.copy(null,null,null,null,e.right.rotateRight()),e=e.rotateLeft(),e=e.colorFlip()),e}moveRedRight(){let e=this.colorFlip();return e.left.left.isRed()&&(e=e.rotateRight(),e=e.colorFlip()),e}rotateLeft(){const e=this.copy(null,null,en.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight(){const e=this.copy(null,null,en.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip(){const e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth(){const e=this.check();return Math.pow(2,e)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw v();if(this.right.isRed())throw v();const e=this.left.check();if(e!==this.right.check())throw v();return e+(this.isRed()?0:1)}}en.EMPTY=null,en.RED=!0,en.BLACK=!1,en.EMPTY=new class{constructor(){this.size=0}get key(){throw v()}get value(){throw v()}get color(){throw v()}get left(){throw v()}get right(){throw v()}copy(e,t,n,s,r){return this}insert(e,t,n){return new en(e,t)}remove(e,t){return this}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class tn{constructor(e){this.comparator=e,this.data=new Xt(this.comparator)}has(e){return null!==this.data.get(e)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(e){return this.data.indexOf(e)}forEach(e){this.data.inorderTraversal(((t,n)=>(e(t),!1)))}forEachInRange(e,t){const n=this.data.getIteratorFrom(e[0]);for(;n.hasNext();){const s=n.getNext();if(this.comparator(s.key,e[1])>=0)return;t(s.key)}}forEachWhile(e,t){let n;for(n=void 0!==t?this.data.getIteratorFrom(t):this.data.getIterator();n.hasNext();)if(!e(n.getNext().key))return}firstAfterOrEqual(e){const t=this.data.getIteratorFrom(e);return t.hasNext()?t.getNext().key:null}getIterator(){return new nn(this.data.getIterator())}getIteratorFrom(e){return new nn(this.data.getIteratorFrom(e))}add(e){return this.copy(this.data.remove(e).insert(e,!0))}delete(e){return this.has(e)?this.copy(this.data.remove(e)):this}isEmpty(){return this.data.isEmpty()}unionWith(e){let t=this;return t.size<e.size&&(t=e,e=this),e.forEach((e=>{t=t.add(e)})),t}isEqual(e){if(!(e instanceof tn))return!1;if(this.size!==e.size)return!1;const t=this.data.getIterator(),n=e.data.getIterator();for(;t.hasNext();){const e=t.getNext().key,s=n.getNext().key;if(0!==this.comparator(e,s))return!1}return!0}toArray(){const e=[];return this.forEach((t=>{e.push(t)})),e}toString(){const e=[];return this.forEach((t=>e.push(t))),"SortedSet("+e.toString()+")"}copy(e){const t=new tn(this.comparator);return t.data=e,t}}class nn{constructor(e){this.iter=e}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}function sn(e){return e.hasNext()?e.getNext():void 0}const rn=new Xt(he.comparator);function on(){return rn}const an=new Xt(he.comparator);function cn(){return an}const un=new Xt(he.comparator),hn=new tn(he.comparator);function ln(...e){let t=hn;for(const n of e)t=t.add(n);return t}const dn=new tn(V);function fn(){return dn}class mn{constructor(e,t,n,s,r){this.snapshotVersion=e,this.targetChanges=t,this.targetMismatches=n,this.documentUpdates=s,this.resolvedLimboDocuments=r}static createSynthesizedRemoteEventForCurrentChange(e,t){const n=new Map;return n.set(e,gn.createSynthesizedTargetChangeForCurrentChange(e,t)),new mn(B.min(),n,fn(),on(),ln())}}class gn{constructor(e,t,n,s,r){this.resumeToken=e,this.current=t,this.addedDocuments=n,this.modifiedDocuments=s,this.removedDocuments=r}static createSynthesizedTargetChangeForCurrentChange(e,t){return new gn(J.EMPTY_BYTE_STRING,t,ln(),ln(),ln())}}class pn{constructor(e,t,n,s){this.M=e,this.removedTargetIds=t,this.key=n,this.$=s}}class yn{constructor(e,t){this.targetId=e,this.F=t}}class wn{constructor(e,t,n=J.EMPTY_BYTE_STRING,s=null){this.state=e,this.targetIds=t,this.resumeToken=n,this.cause=s}}class vn{constructor(){this.B=0,this.L=En(),this.U=J.EMPTY_BYTE_STRING,this.q=!1,this.K=!0}get current(){return this.q}get resumeToken(){return this.U}get G(){return 0!==this.B}get j(){return this.K}W(e){e.approximateByteSize()>0&&(this.K=!0,this.U=e)}H(){let e=ln(),t=ln(),n=ln();return this.L.forEach(((s,r)=>{switch(r){case 0:e=e.add(s);break;case 2:t=t.add(s);break;case 1:n=n.add(s);break;default:v()}})),new gn(this.U,this.q,e,t,n)}J(){this.K=!1,this.L=En()}Y(e,t){this.K=!0,this.L=this.L.insert(e,t)}X(e){this.K=!0,this.L=this.L.remove(e)}Z(){this.B+=1}tt(){this.B-=1}et(){this.K=!0,this.q=!0}}class In{constructor(e){this.nt=e,this.st=new Map,this.it=on(),this.rt=Tn(),this.ot=new tn(V)}ct(e){for(const t of e.M)e.$&&e.$.isFoundDocument()?this.ut(t,e.$):this.at(t,e.key,e.$);for(const t of e.removedTargetIds)this.at(t,e.key,e.$)}ht(e){this.forEachTarget(e,(t=>{const n=this.lt(t);switch(e.state){case 0:this.ft(t)&&n.W(e.resumeToken);break;case 1:n.tt(),n.G||n.J(),n.W(e.resumeToken);break;case 2:n.tt(),n.G||this.removeTarget(t);break;case 3:this.ft(t)&&(n.et(),n.W(e.resumeToken));break;case 4:this.ft(t)&&(this.dt(t),n.W(e.resumeToken));break;default:v()}}))}forEachTarget(e,t){e.targetIds.length>0?e.targetIds.forEach(t):this.st.forEach(((e,n)=>{this.ft(n)&&t(n)}))}_t(e){const t=e.targetId,n=e.F.count,s=this.wt(t);if(s){const e=s.target;if(Ve(e))if(0===n){const n=new he(e.path);this.at(t,n,ke.newNoDocument(n,B.min()))}else I(1===n);else this.gt(t)!==n&&(this.dt(t),this.ot=this.ot.add(t))}}yt(e){const t=new Map;this.st.forEach(((n,s)=>{const r=this.wt(s);if(r){if(n.current&&Ve(r.target)){const t=new he(r.target.path);null!==this.it.get(t)||this.It(s,t)||this.at(s,t,ke.newNoDocument(t,e))}n.j&&(t.set(s,n.H()),n.J())}}));let n=ln();this.rt.forEach(((e,t)=>{let s=!0;t.forEachWhile((e=>{const t=this.wt(e);return!t||2===t.purpose||(s=!1,!1)})),s&&(n=n.add(e))})),this.it.forEach(((t,n)=>n.setReadTime(e)));const s=new mn(e,t,this.ot,this.it,n);return this.it=on(),this.rt=Tn(),this.ot=new tn(V),s}ut(e,t){if(!this.ft(e))return;const n=this.It(e,t.key)?2:0;this.lt(e).Y(t.key,n),this.it=this.it.insert(t.key,t),this.rt=this.rt.insert(t.key,this.Et(t.key).add(e))}at(e,t,n){if(!this.ft(e))return;const s=this.lt(e);this.It(e,t)?s.Y(t,1):s.X(t),this.rt=this.rt.insert(t,this.Et(t).delete(e)),n&&(this.it=this.it.insert(t,n))}removeTarget(e){this.st.delete(e)}gt(e){const t=this.lt(e).H();return this.nt.getRemoteKeysForTarget(e).size+t.addedDocuments.size-t.removedDocuments.size}Z(e){this.lt(e).Z()}lt(e){let t=this.st.get(e);return t||(t=new vn,this.st.set(e,t)),t}Et(e){let t=this.rt.get(e);return t||(t=new tn(V),this.rt=this.rt.insert(e,t)),t}ft(e){const t=null!==this.wt(e);return t||g("WatchChangeAggregator","Detected inactive target",e),t}wt(e){const t=this.st.get(e);return t&&t.G?null:this.nt.Tt(e)}dt(e){this.st.set(e,new vn),this.nt.getRemoteKeysForTarget(e).forEach((t=>{this.at(e,t,null)}))}It(e,t){return this.nt.getRemoteKeysForTarget(e).has(t)}}function Tn(){return new Xt(he.comparator)}function En(){return new Xt(he.comparator)}const bn={asc:"ASCENDING",desc:"DESCENDING"},Sn={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"};class xn{constructor(e,t){this.databaseId=e,this.N=t}}function Nn(e,t){return e.N?`${new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+t.nanoseconds).slice(-9)}Z`:{seconds:""+t.seconds,nanos:t.nanoseconds}}function _n(e,t){return e.N?t.toBase64():t.toUint8Array()}function kn(e,t){return Nn(e,t.toTimestamp())}function An(e){return I(!!e),B.fromTimestamp(function(e){const t=Z(e);return new U(t.seconds,t.nanos)}(e))}function Dn(e,t){return function(e){return new Q(["projects",e.projectId,"databases",e.database])}(e).child("documents").child(t).canonicalString()}function Cn(e){const t=Q.fromString(e);return I(Zn(t)),t}function On(e,t){return Dn(e.databaseId,t.path)}function Rn(e,t){const n=Cn(t);if(n.get(1)!==e.databaseId.projectId)throw new S(b.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+e.databaseId.projectId);if(n.get(3)!==e.databaseId.database)throw new S(b.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+e.databaseId.database);return new he(Vn(n))}function Ln(e,t){return Dn(e.databaseId,t)}function Mn(e){const t=Cn(e);return 4===t.length?Q.emptyPath():Vn(t)}function Pn(e){return new Q(["projects",e.databaseId.projectId,"databases",e.databaseId.database]).canonicalString()}function Vn(e){return I(e.length>4&&"documents"===e.get(4)),e.popFirst(5)}function Fn(e,t,n){return{name:On(e,t),fields:n.value.mapValue.fields}}function qn(e,t,n){const s=Rn(e,t.name),r=An(t.updateTime),i=new Ne({mapValue:{fields:t.fields}}),o=ke.newFoundDocument(s,r,i);return n&&o.setHasCommittedMutations(),n?o.setHasCommittedMutations():o}function Un(e,t){let n;if(t instanceof Ut)n={update:Fn(e,t.key,t.value)};else if(t instanceof jt)n={delete:On(e,t.key)};else if(t instanceof Bt)n={update:Fn(e,t.key,t.data),updateMask:Xn(t.fieldMask)};else{if(!(t instanceof Qt))return v();n={verify:On(e,t.key)}}return t.fieldTransforms.length>0&&(n.updateTransforms=t.fieldTransforms.map((e=>function(e,t){const n=t.transform;if(n instanceof Et)return{fieldPath:t.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(n instanceof bt)return{fieldPath:t.field.canonicalString(),appendMissingElements:{values:n.elements}};if(n instanceof xt)return{fieldPath:t.field.canonicalString(),removeAllFromArray:{values:n.elements}};if(n instanceof _t)return{fieldPath:t.field.canonicalString(),increment:n.k};throw v()}(0,e)))),t.precondition.isNone||(n.currentDocument=function(e,t){return void 0!==t.updateTime?{updateTime:kn(e,t.updateTime)}:void 0!==t.exists?{exists:t.exists}:v()}(e,t.precondition)),n}function Bn(e,t){const n=t.currentDocument?function(e){return void 0!==e.updateTime?Ot.updateTime(An(e.updateTime)):void 0!==e.exists?Ot.exists(e.exists):Ot.none()}(t.currentDocument):Ot.none(),s=t.updateTransforms?t.updateTransforms.map((t=>function(e,t){let n=null;if("setToServerValue"in t)I("REQUEST_TIME"===t.setToServerValue),n=new Et;else if("appendMissingElements"in t){const e=t.appendMissingElements.values||[];n=new bt(e)}else if("removeAllFromArray"in t){const e=t.removeAllFromArray.values||[];n=new xt(e)}else"increment"in t?n=new _t(e,t.increment):v();const s=W.fromServerFormat(t.fieldPath);return new Dt(s,n)}(e,t))):[];if(t.update){t.update.name;const r=Rn(e,t.update.name),i=new Ne({mapValue:{fields:t.update.fields}});if(t.updateMask){const e=function(e){const t=e.fieldPaths||[];return new H(t.map((e=>W.fromServerFormat(e))))}(t.updateMask);return new Bt(r,i,e,n,s)}return new Ut(r,i,n,s)}if(t.delete){const s=Rn(e,t.delete);return new jt(s,n)}if(t.verify){const s=Rn(e,t.verify);return new Qt(s,n)}return v()}function Kn(e,t){return{documents:[Ln(e,t.path)]}}function Gn(e,t){const n={structuredQuery:{}},s=t.path;null!==t.collectionGroup?(n.parent=Ln(e,s),n.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(n.parent=Ln(e,s.popLast()),n.structuredQuery.from=[{collectionId:s.lastSegment()}]);const r=function(e){if(0===e.length)return;const t=e.map((e=>function(e){if("=="===e.op){if(be(e.value))return{unaryFilter:{field:Wn(e.field),op:"IS_NAN"}};if(Ee(e.value))return{unaryFilter:{field:Wn(e.field),op:"IS_NULL"}}}else if("!="===e.op){if(be(e.value))return{unaryFilter:{field:Wn(e.field),op:"IS_NOT_NAN"}};if(Ee(e.value))return{unaryFilter:{field:Wn(e.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:Wn(e.field),op:zn(e.op),value:e.value}}}(e)));return 1===t.length?t[0]:{compositeFilter:{op:"AND",filters:t}}}(t.filters);r&&(n.structuredQuery.where=r);const i=function(e){if(0!==e.length)return e.map((e=>function(e){return{field:Wn(e.field),direction:Qn(e.dir)}}(e)))}(t.orderBy);i&&(n.structuredQuery.orderBy=i);const o=function(e,t){return e.N||ae(t)?t:{value:t}}(e,t.limit);var a;return null!==o&&(n.structuredQuery.limit=o),t.startAt&&(n.structuredQuery.startAt={before:(a=t.startAt).inclusive,values:a.position}),t.endAt&&(n.structuredQuery.endAt=function(e){return{before:!e.inclusive,values:e.position}}(t.endAt)),n}function $n(e){let t=Mn(e.parent);const n=e.structuredQuery,s=n.from?n.from.length:0;let r=null;if(s>0){I(1===s);const e=n.from[0];e.allDescendants?r=e.collectionId:t=t.child(e.collectionId)}let i=[];n.where&&(i=jn(n.where));let o=[];n.orderBy&&(o=n.orderBy.map((e=>function(e){return new We(Hn(e.field),function(e){switch(e){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(e.direction))}(e))));let a=null;n.limit&&(a=function(e){let t;return t="object"==typeof e?e.value:e,ae(t)?null:t}(n.limit));let c=null;n.startAt&&(c=function(e){const t=!!e.before,n=e.values||[];return new ze(n,t)}(n.startAt));let u=null;return n.endAt&&(u=function(e){const t=!e.before,n=e.values||[];return new ze(n,t)}(n.endAt)),Ze(t,r,o,i,a,"F",c,u)}function jn(e){return e?void 0!==e.unaryFilter?[Jn(e)]:void 0!==e.fieldFilter?[Yn(e)]:void 0!==e.compositeFilter?e.compositeFilter.filters.map((e=>jn(e))).reduce(((e,t)=>e.concat(t))):v():[]}function Qn(e){return bn[e]}function zn(e){return Sn[e]}function Wn(e){return{fieldPath:e.canonicalString()}}function Hn(e){return W.fromServerFormat(e.fieldPath)}function Yn(e){return Fe.create(Hn(e.fieldFilter.field),function(e){switch(e){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return v()}}(e.fieldFilter.op),e.fieldFilter.value)}function Jn(e){switch(e.unaryFilter.op){case"IS_NAN":const t=Hn(e.unaryFilter.field);return Fe.create(t,"==",{doubleValue:NaN});case"IS_NULL":const n=Hn(e.unaryFilter.field);return Fe.create(n,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":const s=Hn(e.unaryFilter.field);return Fe.create(s,"!=",{doubleValue:NaN});case"IS_NOT_NULL":const r=Hn(e.unaryFilter.field);return Fe.create(r,"!=",{nullValue:"NULL_VALUE"});default:return v()}}function Xn(e){const t=[];return e.fields.forEach((e=>t.push(e.canonicalString()))),{fieldPaths:t}}function Zn(e){return e.length>=4&&"projects"===e.get(0)&&"databases"===e.get(2)}function es(e){let t="";for(let n=0;n<e.length;n++)t.length>0&&(t=ns(t)),t=ts(e.get(n),t);return ns(t)}function ts(e,t){let n=t;const s=e.length;for(let r=0;r<s;r++){const t=e.charAt(r);switch(t){case"\0":n+="\x01\x10";break;case"\x01":n+="\x01\x11";break;default:n+=t}}return n}function ns(e){return e+"\x01\x01"}function ss(e){const t=e.length;if(I(t>=2),2===t)return I("\x01"===e.charAt(0)&&"\x01"===e.charAt(1)),Q.emptyPath();const n=t-2,s=[];let r="";for(let i=0;i<t;){const t=e.indexOf("\x01",i);switch((t<0||t>n)&&v(),e.charAt(t+1)){case"\x01":const n=e.substring(i,t);let o;0===r.length?o=n:(r+=n,o=r,r=""),s.push(o);break;case"\x10":r+=e.substring(i,t),r+="\0";break;case"\x11":r+=e.substring(i,t+1);break;default:v()}i=t+2}return new Q(s)}class rs{constructor(e,t){this.seconds=e,this.nanoseconds=t}}class is{constructor(e,t,n){this.ownerId=e,this.allowTabSynchronization=t,this.leaseTimestampMs=n}}is.store="owner",is.key="owner";class os{constructor(e,t,n){this.userId=e,this.lastAcknowledgedBatchId=t,this.lastStreamToken=n}}os.store="mutationQueues",os.keyPath="userId";class as{constructor(e,t,n,s,r){this.userId=e,this.batchId=t,this.localWriteTimeMs=n,this.baseMutations=s,this.mutations=r}}as.store="mutations",as.keyPath="batchId",as.userMutationsIndex="userMutationsIndex",as.userMutationsKeyPath=["userId","batchId"];class cs{constructor(){}static prefixForUser(e){return[e]}static prefixForPath(e,t){return[e,es(t)]}static key(e,t,n){return[e,es(t),n]}}cs.store="documentMutations",cs.PLACEHOLDER=new cs;class us{constructor(e,t){this.path=e,this.readTime=t}}class hs{constructor(e,t){this.path=e,this.version=t}}class ls{constructor(e,t,n,s,r,i){this.unknownDocument=e,this.noDocument=t,this.document=n,this.hasCommittedMutations=s,this.readTime=r,this.parentPath=i}}ls.store="remoteDocuments",ls.readTimeIndex="readTimeIndex",ls.readTimeIndexPath="readTime",ls.collectionReadTimeIndex="collectionReadTimeIndex",ls.collectionReadTimeIndexPath=["parentPath","readTime"];class ds{constructor(e){this.byteSize=e}}ds.store="remoteDocumentGlobal",ds.key="remoteDocumentGlobalKey";class fs{constructor(e,t,n,s,r,i,o){this.targetId=e,this.canonicalId=t,this.readTime=n,this.resumeToken=s,this.lastListenSequenceNumber=r,this.lastLimboFreeSnapshotVersion=i,this.query=o}}fs.store="targets",fs.keyPath="targetId",fs.queryTargetsIndexName="queryTargetsIndex",fs.queryTargetsKeyPath=["canonicalId","targetId"];class ms{constructor(e,t,n){this.targetId=e,this.path=t,this.sequenceNumber=n}}ms.store="targetDocuments",ms.keyPath=["targetId","path"],ms.documentTargetsIndex="documentTargetsIndex",ms.documentTargetsKeyPath=["path","targetId"];class gs{constructor(e,t,n,s){this.highestTargetId=e,this.highestListenSequenceNumber=t,this.lastRemoteSnapshotVersion=n,this.targetCount=s}}gs.key="targetGlobalKey",gs.store="targetGlobal";class ps{constructor(e,t){this.collectionId=e,this.parent=t}}ps.store="collectionParents",ps.keyPath=["collectionId","parent"];class ys{constructor(e,t,n,s){this.clientId=e,this.updateTimeMs=t,this.networkEnabled=n,this.inForeground=s}}ys.store="clientMetadata",ys.keyPath="clientId";class ws{constructor(e,t,n){this.bundleId=e,this.createTime=t,this.version=n}}ws.store="bundles",ws.keyPath="bundleId";class vs{constructor(e,t,n){this.name=e,this.readTime=t,this.bundledQuery=n}}vs.store="namedQueries",vs.keyPath="name";class Is{constructor(e,t,n){this.indexId=e,this.collectionGroup=t,this.fields=n}}Is.store="indexConfiguration",Is.keyPath="indexId",Is.collectionGroupIndex="collectionGroupIndex",Is.collectionGroupIndexPath="collectionGroup";class Ts{constructor(e,t,n,s,r,i){this.indexId=e,this.uid=t,this.sequenceNumber=n,this.readTime=s,this.documentKey=r,this.largestBatchId=i}}Ts.store="indexState",Ts.keyPath=["indexId","uid"],Ts.sequenceNumberIndex="sequenceNumberIndex",Ts.sequenceNumberIndexPath=["uid","sequenceNumber"];class Es{constructor(e,t,n,s,r){this.indexId=e,this.uid=t,this.arrayValue=n,this.directionalValue=s,this.documentKey=r}}Es.store="indexEntries",Es.keyPath=["indexId","uid","arrayValue","directionalValue","documentKey"],Es.documentKeyIndex="documentKeyIndex",Es.documentKeyIndexPath=["indexId","uid","documentKey"];class bs{constructor(e,t,n,s,r,i){this.userId=e,this.collectionPath=t,this.documentId=n,this.collectionGroup=s,this.largestBatchId=r,this.overlayMutation=i}}bs.store="documentOverlays",bs.keyPath=["userId","collectionPath","documentId"],bs.collectionPathOverlayIndex="collectionPathOverlayIndex",bs.collectionPathOverlayIndexPath=["userId","collectionPath","largestBatchId"],bs.collectionGroupOverlayIndex="collectionGroupOverlayIndex",bs.collectionGroupOverlayIndexPath=["userId","collectionGroup","largestBatchId"];const Ss=[os.store,as.store,cs.store,ls.store,fs.store,is.store,gs.store,ms.store,ys.store,ds.store,ps.store,ws.store,vs.store],xs=[...Ss,bs.store],Ns=[...xs,Is.store,Ts.store,Es.store],_s="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class ks{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(e){this.onCommittedListeners.push(e)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach((e=>e()))}}class As{constructor(e){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,e((e=>{this.isDone=!0,this.result=e,this.nextCallback&&this.nextCallback(e)}),(e=>{this.isDone=!0,this.error=e,this.catchCallback&&this.catchCallback(e)}))}catch(e){return this.next(void 0,e)}next(e,t){return this.callbackAttached&&v(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(t,this.error):this.wrapSuccess(e,this.result):new As(((n,s)=>{this.nextCallback=t=>{this.wrapSuccess(e,t).next(n,s)},this.catchCallback=e=>{this.wrapFailure(t,e).next(n,s)}}))}toPromise(){return new Promise(((e,t)=>{this.next(e,t)}))}wrapUserFunction(e){try{const t=e();return t instanceof As?t:As.resolve(t)}catch(e){return As.reject(e)}}wrapSuccess(e,t){return e?this.wrapUserFunction((()=>e(t))):As.resolve(t)}wrapFailure(e,t){return e?this.wrapUserFunction((()=>e(t))):As.reject(t)}static resolve(e){return new As(((t,n)=>{t(e)}))}static reject(e){return new As(((t,n)=>{n(e)}))}static waitFor(e){return new As(((t,n)=>{let s=0,r=0,i=!1;e.forEach((e=>{++s,e.next((()=>{++r,i&&r===s&&t()}),(e=>n(e)))})),i=!0,r===s&&t()}))}static or(e){let t=As.resolve(!1);for(const n of e)t=t.next((e=>e?As.resolve(e):n()));return t}static forEach(e,t){const n=[];return e.forEach(((e,s)=>{n.push(t.call(this,e,s))})),this.waitFor(n)}}class Ds{constructor(e,t){this.action=e,this.transaction=t,this.aborted=!1,this.At=new x,this.transaction.oncomplete=()=>{this.At.resolve()},this.transaction.onabort=()=>{t.error?this.At.reject(new Rs(e,t.error)):this.At.resolve()},this.transaction.onerror=t=>{const n=Fs(t.target.error);this.At.reject(new Rs(e,n))}}static open(e,t,n,s){try{return new Ds(t,e.transaction(s,n))}catch(e){throw new Rs(t,e)}}get Rt(){return this.At.promise}abort(e){e&&this.At.reject(e),this.aborted||(g("SimpleDb","Aborting transaction:",e?e.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}Pt(){const e=this.transaction;this.aborted||"function"!=typeof e.commit||e.commit()}store(e){const t=this.transaction.objectStore(e);return new Ms(t)}}class Cs{constructor(e,t,n){this.name=e,this.version=t,this.bt=n,12.2===Cs.vt((0,o.z$)())&&p("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(e){return g("SimpleDb","Removing database:",e),Ps(window.indexedDB.deleteDatabase(e)).toPromise()}static Vt(){if(!(0,o.hl)())return!1;if(Cs.St())return!0;const e=(0,o.z$)(),t=Cs.vt(e),n=0<t&&t<10,s=Cs.Dt(e),r=0<s&&s<4.5;return!(e.indexOf("MSIE ")>0||e.indexOf("Trident/")>0||e.indexOf("Edge/")>0||n||r)}static St(){var e;return"undefined"!=typeof c&&"YES"===(null===(e=c.env)||void 0===e?void 0:e.Ct)}static Nt(e,t){return e.store(t)}static vt(e){const t=e.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=t?t[1].split("_").slice(0,2).join("."):"-1";return Number(n)}static Dt(e){const t=e.match(/Android ([\d.]+)/i),n=t?t[1].split(".").slice(0,2).join("."):"-1";return Number(n)}async xt(e){return this.db||(g("SimpleDb","Opening database:",this.name),this.db=await new Promise(((t,n)=>{const s=indexedDB.open(this.name,this.version);s.onsuccess=e=>{const n=e.target.result;t(n)},s.onblocked=()=>{n(new Rs(e,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},s.onerror=t=>{const s=t.target.error;"VersionError"===s.name?n(new S(b.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===s.name?n(new S(b.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+s)):n(new Rs(e,s))},s.onupgradeneeded=e=>{g("SimpleDb",'Database "'+this.name+'" requires upgrade from version:',e.oldVersion);const t=e.target.result;this.bt.kt(t,s.transaction,e.oldVersion,this.version).next((()=>{g("SimpleDb","Database upgrade to version "+this.version+" complete")}))}}))),this.Ot&&(this.db.onversionchange=e=>this.Ot(e)),this.db}Mt(e){this.Ot=e,this.db&&(this.db.onversionchange=t=>e(t))}async runTransaction(e,t,n,s){const r="readonly"===t;let i=0;for(;;){++i;try{this.db=await this.xt(e);const t=Ds.open(this.db,e,r?"readonly":"readwrite",n),i=s(t).next((e=>(t.Pt(),e))).catch((e=>(t.abort(e),As.reject(e)))).toPromise();return i.catch((()=>{})),await t.Rt,i}catch(e){const t="FirebaseError"!==e.name&&i<3;if(g("SimpleDb","Transaction failed with error:",e.message,"Retrying:",t),this.close(),!t)return Promise.reject(e)}}}close(){this.db&&this.db.close(),this.db=void 0}}class Os{constructor(e){this.$t=e,this.Ft=!1,this.Bt=null}get isDone(){return this.Ft}get Lt(){return this.Bt}set cursor(e){this.$t=e}done(){this.Ft=!0}Ut(e){this.Bt=e}delete(){return Ps(this.$t.delete())}}class Rs extends S{constructor(e,t){super(b.UNAVAILABLE,`IndexedDB transaction '${e}' failed: ${t}`),this.name="IndexedDbTransactionError"}}function Ls(e){return"IndexedDbTransactionError"===e.name}class Ms{constructor(e){this.store=e}put(e,t){let n;return void 0!==t?(g("SimpleDb","PUT",this.store.name,e,t),n=this.store.put(t,e)):(g("SimpleDb","PUT",this.store.name,"<auto-key>",e),n=this.store.put(e)),Ps(n)}add(e){return g("SimpleDb","ADD",this.store.name,e,e),Ps(this.store.add(e))}get(e){return Ps(this.store.get(e)).next((t=>(void 0===t&&(t=null),g("SimpleDb","GET",this.store.name,e,t),t)))}delete(e){return g("SimpleDb","DELETE",this.store.name,e),Ps(this.store.delete(e))}count(){return g("SimpleDb","COUNT",this.store.name),Ps(this.store.count())}qt(e,t){const n=this.options(e,t);if(n.index||"function"!=typeof this.store.getAll){const e=this.cursor(n),t=[];return this.Kt(e,((e,n)=>{t.push(n)})).next((()=>t))}{const e=this.store.getAll(n.range);return new As(((t,n)=>{e.onerror=e=>{n(e.target.error)},e.onsuccess=e=>{t(e.target.result)}}))}}Gt(e,t){g("SimpleDb","DELETE ALL",this.store.name);const n=this.options(e,t);n.jt=!1;const s=this.cursor(n);return this.Kt(s,((e,t,n)=>n.delete()))}Qt(e,t){let n;t?n=e:(n={},t=e);const s=this.cursor(n);return this.Kt(s,t)}Wt(e){const t=this.cursor({});return new As(((n,s)=>{t.onerror=e=>{const t=Fs(e.target.error);s(t)},t.onsuccess=t=>{const s=t.target.result;s?e(s.primaryKey,s.value).next((e=>{e?s.continue():n()})):n()}}))}Kt(e,t){const n=[];return new As(((s,r)=>{e.onerror=e=>{r(e.target.error)},e.onsuccess=e=>{const r=e.target.result;if(!r)return void s();const i=new Os(r),o=t(r.primaryKey,r.value,i);if(o instanceof As){const e=o.catch((e=>(i.done(),As.reject(e))));n.push(e)}i.isDone?s():null===i.Lt?r.continue():r.continue(i.Lt)}})).next((()=>As.waitFor(n)))}options(e,t){let n;return void 0!==e&&("string"==typeof e?n=e:t=e),{index:n,range:t}}cursor(e){let t="next";if(e.reverse&&(t="prev"),e.index){const n=this.store.index(e.index);return e.jt?n.openKeyCursor(e.range,t):n.openCursor(e.range,t)}return this.store.openCursor(e.range,t)}}function Ps(e){return new As(((t,n)=>{e.onsuccess=e=>{const n=e.target.result;t(n)},e.onerror=e=>{const t=Fs(e.target.error);n(t)}}))}let Vs=!1;function Fs(e){const t=Cs.vt((0,o.z$)());if(t>=12.2&&t<13){const t="An internal error was encountered in the Indexed Database server";if(e.message.indexOf(t)>=0){const e=new S("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${t}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return Vs||(Vs=!0,setTimeout((()=>{throw e}),0)),e}}return e}class qs extends ks{constructor(e,t){super(),this.zt=e,this.currentSequenceNumber=t}}function Us(e,t){const n=E(e);return Cs.Nt(n.zt,t)}class Bs{constructor(e,t,n,s){this.batchId=e,this.localWriteTime=t,this.baseMutations=n,this.mutations=s}applyToRemoteDocument(e,t){const n=t.mutationResults;for(let s=0;s<this.mutations.length;s++){const t=this.mutations[s];t.key.isEqual(e.key)&&Mt(t,e,n[s])}}applyToLocalView(e){for(const t of this.baseMutations)t.key.isEqual(e.key)&&Pt(t,e,this.localWriteTime);for(const t of this.mutations)t.key.isEqual(e.key)&&Pt(t,e,this.localWriteTime)}applyToLocalDocumentSet(e){this.mutations.forEach((t=>{const n=e.get(t.key),s=n;this.applyToLocalView(s),n.isValidDocument()||s.convertToNoDocument(B.min())}))}keys(){return this.mutations.reduce(((e,t)=>e.add(t.key)),ln())}isEqual(e){return this.batchId===e.batchId&&F(this.mutations,e.mutations,((e,t)=>Ft(e,t)))&&F(this.baseMutations,e.baseMutations,((e,t)=>Ft(e,t)))}}class Ks{constructor(e,t,n,s){this.batch=e,this.commitVersion=t,this.mutationResults=n,this.docVersions=s}static from(e,t,n){I(e.mutations.length===n.length);let s=un;const r=e.mutations;for(let i=0;i<r.length;i++)s=s.insert(r[i].key,n[i].version);return new Ks(e,t,n,s)}}class Gs{constructor(e,t){this.largestBatchId=e,this.mutation=t}getKey(){return this.mutation.key}isEqual(e){return null!==e&&this.mutation===e.mutation}toString(){return`Overlay{\n      largestBatchId: ${this.largestBatchId},\n      mutation: ${this.mutation.toString()}\n    }`}}class $s{constructor(e,t,n,s,r=B.min(),i=B.min(),o=J.EMPTY_BYTE_STRING){this.target=e,this.targetId=t,this.purpose=n,this.sequenceNumber=s,this.snapshotVersion=r,this.lastLimboFreeSnapshotVersion=i,this.resumeToken=o}withSequenceNumber(e){return new $s(this.target,this.targetId,this.purpose,e,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken)}withResumeToken(e,t){return new $s(this.target,this.targetId,this.purpose,this.sequenceNumber,t,this.lastLimboFreeSnapshotVersion,e)}withLastLimboFreeSnapshotVersion(e){return new $s(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,e,this.resumeToken)}}class js{constructor(e){this.Ht=e}}function Qs(e,t){let n;if(t.document)n=qn(e.Ht,t.document,!!t.hasCommittedMutations);else if(t.noDocument){const e=he.fromSegments(t.noDocument.path),s=Js(t.noDocument.readTime);n=ke.newNoDocument(e,s),t.hasCommittedMutations&&n.setHasCommittedMutations()}else{if(!t.unknownDocument)return v();{const e=he.fromSegments(t.unknownDocument.path),s=Js(t.unknownDocument.version);n=ke.newUnknownDocument(e,s)}}return t.readTime&&n.setReadTime(Hs(t.readTime)),n}function zs(e,t){const n=Ws(t.readTime),s=t.key.path.popLast().toArray();if(t.isFoundDocument()){const r=function(e,t){return{name:On(e,t.key),fields:t.data.value.mapValue.fields,updateTime:Nn(e,t.version.toTimestamp())}}(e.Ht,t),i=t.hasCommittedMutations;return new ls(null,null,r,i,n,s)}if(t.isNoDocument()){const e=t.key.path.toArray(),r=Ys(t.version),i=t.hasCommittedMutations;return new ls(null,new us(e,r),null,i,n,s)}if(t.isUnknownDocument()){const e=t.key.path.toArray(),r=Ys(t.version);return new ls(new hs(e,r),null,null,!0,n,s)}return v()}function Ws(e){const t=e.toTimestamp();return[t.seconds,t.nanoseconds]}function Hs(e){const t=new U(e[0],e[1]);return B.fromTimestamp(t)}function Ys(e){const t=e.toTimestamp();return new rs(t.seconds,t.nanoseconds)}function Js(e){const t=new U(e.seconds,e.nanoseconds);return B.fromTimestamp(t)}function Xs(e,t){const n=(t.baseMutations||[]).map((t=>Bn(e.Ht,t)));for(let i=0;i<t.mutations.length-1;++i){const e=t.mutations[i];if(i+1<t.mutations.length&&void 0!==t.mutations[i+1].transform){const n=t.mutations[i+1];e.updateTransforms=n.transform.fieldTransforms,t.mutations.splice(i+1,1),++i}}const s=t.mutations.map((t=>Bn(e.Ht,t))),r=U.fromMillis(t.localWriteTimeMs);return new Bs(t.batchId,r,n,s)}function Zs(e){const t=Js(e.readTime),n=void 0!==e.lastLimboFreeSnapshotVersion?Js(e.lastLimboFreeSnapshotVersion):B.min();let s;var r;return void 0!==e.query.documents?(I(1===(r=e.query).documents.length),s=at(et(Mn(r.documents[0])))):s=function(e){return at($n(e))}(e.query),new $s(s,e.targetId,0,e.lastListenSequenceNumber,t,n,J.fromBase64String(e.resumeToken))}function er(e,t){const n=Ys(t.snapshotVersion),s=Ys(t.lastLimboFreeSnapshotVersion);let r;r=Ve(t.target)?Kn(e.Ht,t.target):Gn(e.Ht,t.target);const i=t.resumeToken.toBase64();return new fs(t.targetId,Me(t.target),n,i,t.sequenceNumber,s,r)}function tr(e){const t=$n({parent:e.parent,structuredQuery:e.structuredQuery});return"LAST"===e.limitType?ct(t,t.limit,"L"):t}function nr(e,t){return new Gs(t.largestBatchId,Bn(e.Ht,t.overlayMutation))}function sr(e,t){const n=t.path.lastSegment();return[e,es(t.path.popLast()),n]}class rr{getBundleMetadata(e,t){return ir(e).get(t).next((e=>{if(e)return{id:(t=e).bundleId,createTime:Js(t.createTime),version:t.version};var t}))}saveBundleMetadata(e,t){return ir(e).put({bundleId:(n=t).id,createTime:Ys(An(n.createTime)),version:n.version});var n}getNamedQuery(e,t){return or(e).get(t).next((e=>{if(e)return{name:(t=e).name,query:tr(t.bundledQuery),readTime:Js(t.readTime)};var t}))}saveNamedQuery(e,t){return or(e).put(function(e){return{name:e.name,readTime:Ys(An(e.readTime)),bundledQuery:e.bundledQuery}}(t))}}function ir(e){return Us(e,ws.store)}function or(e){return Us(e,vs.store)}class ar{constructor(e,t){this.O=e,this.userId=t}static Jt(e,t){const n=t.uid||"";return new ar(e,n)}getOverlay(e,t){return cr(e).get(sr(this.userId,t)).next((e=>e?nr(this.O,e):null))}saveOverlays(e,t,n){const s=[];return n.forEach((n=>{const r=new Gs(t,n);s.push(this.Yt(e,r))})),As.waitFor(s)}removeOverlaysForBatchId(e,t,n){const s=new Set;t.forEach((e=>s.add(es(e.getCollectionPath()))));const r=[];return s.forEach((t=>{const s=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,n+1],!1,!0);r.push(cr(e).Gt(bs.collectionPathOverlayIndex,s))})),As.waitFor(r)}getOverlaysForCollection(e,t,n){const s=new Map,r=es(t),i=IDBKeyRange.bound([this.userId,r,n],[this.userId,r,Number.POSITIVE_INFINITY],!0);return cr(e).qt(bs.collectionPathOverlayIndex,i).next((e=>{for(const t of e){const e=nr(this.O,t);s.set(e.getKey(),e)}return s}))}getOverlaysForCollectionGroup(e,t,n,s){const r=new Map;let i;const o=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,Number.POSITIVE_INFINITY],!0);return cr(e).Qt({index:bs.collectionGroupOverlayIndex,range:o},((e,t,n)=>{const o=nr(this.O,t);r.size<s||o.largestBatchId===i?(r.set(o.getKey(),o),i=o.largestBatchId):n.done()})).next((()=>r))}Yt(e,t){return cr(e).put(function(e,t,n){const[s,r,i]=sr(t,n.mutation.key);return new bs(t,r,i,n.mutation.key.getCollectionGroup(),n.largestBatchId,Un(e.Ht,n.mutation))}(this.O,this.userId,t))}}function cr(e){return Us(e,bs.store)}class ur{constructor(){}Xt(e,t){this.Zt(e,t),t.te()}Zt(e,t){if("nullValue"in e)this.ee(t,5);else if("booleanValue"in e)this.ee(t,10),t.ne(e.booleanValue?1:0);else if("integerValue"in e)this.ee(t,15),t.ne(ee(e.integerValue));else if("doubleValue"in e){const n=ee(e.doubleValue);isNaN(n)?this.ee(t,13):(this.ee(t,15),ce(n)?t.ne(0):t.ne(n))}else if("timestampValue"in e){const n=e.timestampValue;this.ee(t,20),"string"==typeof n?t.se(n):(t.se(`${n.seconds||""}`),t.ne(n.nanos||0))}else if("stringValue"in e)this.ie(e.stringValue,t),this.re(t);else if("bytesValue"in e)this.ee(t,30),t.oe(te(e.bytesValue)),this.re(t);else if("referenceValue"in e)this.ce(e.referenceValue,t);else if("geoPointValue"in e){const n=e.geoPointValue;this.ee(t,45),t.ne(n.latitude||0),t.ne(n.longitude||0)}else"mapValue"in e?fe(e,le)?this.ee(t,Number.MAX_SAFE_INTEGER):(this.ue(e.mapValue,t),this.re(t)):"arrayValue"in e?(this.ae(e.arrayValue,t),this.re(t)):v()}ie(e,t){this.ee(t,25),this.he(e,t)}he(e,t){t.se(e)}ue(e,t){const n=e.fields||{};this.ee(t,55);for(const s of Object.keys(n))this.ie(s,t),this.Zt(n[s],t)}ae(e,t){const n=e.values||[];this.ee(t,50);for(const s of n)this.Zt(s,t)}ce(e,t){this.ee(t,37),he.fromName(e).path.forEach((e=>{this.ee(t,60),this.he(e,t)}))}ee(e,t){e.ne(t)}re(e){e.ne(2)}}function hr(e){if(0===e)return 8;let t=0;return e>>4==0&&(t+=4,e<<=4),e>>6==0&&(t+=2,e<<=2),e>>7==0&&(t+=1),t}function lr(e){const t=64-function(e){let t=0;for(let n=0;n<8;++n){const s=hr(255&e[n]);if(t+=s,8!==s)break}return t}(e);return Math.ceil(t/8)}ur.le=new ur;class dr{constructor(){this.buffer=new Uint8Array(1024),this.position=0}fe(e){const t=e[Symbol.iterator]();let n=t.next();for(;!n.done;)this.de(n.value),n=t.next();this._e()}we(e){const t=e[Symbol.iterator]();let n=t.next();for(;!n.done;)this.me(n.value),n=t.next();this.ge()}ye(e){for(const t of e){const e=t.charCodeAt(0);if(e<128)this.de(e);else if(e<2048)this.de(960|e>>>6),this.de(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.de(480|e>>>12),this.de(128|63&e>>>6),this.de(128|63&e);else{const e=t.codePointAt(0);this.de(240|e>>>18),this.de(128|63&e>>>12),this.de(128|63&e>>>6),this.de(128|63&e)}}this._e()}pe(e){for(const t of e){const e=t.charCodeAt(0);if(e<128)this.me(e);else if(e<2048)this.me(960|e>>>6),this.me(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.me(480|e>>>12),this.me(128|63&e>>>6),this.me(128|63&e);else{const e=t.codePointAt(0);this.me(240|e>>>18),this.me(128|63&e>>>12),this.me(128|63&e>>>6),this.me(128|63&e)}}this.ge()}Ie(e){const t=this.Ee(e),n=lr(t);this.Te(1+n),this.buffer[this.position++]=255&n;for(let s=t.length-n;s<t.length;++s)this.buffer[this.position++]=255&t[s]}Ae(e){const t=this.Ee(e),n=lr(t);this.Te(1+n),this.buffer[this.position++]=~(255&n);for(let s=t.length-n;s<t.length;++s)this.buffer[this.position++]=~(255&t[s])}Re(){this.Pe(255),this.Pe(255)}be(){this.ve(255),this.ve(255)}reset(){this.position=0}seed(e){this.Te(e.length),this.buffer.set(e,this.position),this.position+=e.length}Ve(){return this.buffer.slice(0,this.position)}Ee(e){const t=function(e){const t=new DataView(new ArrayBuffer(8));return t.setFloat64(0,e,!1),new Uint8Array(t.buffer)}(e),n=0!=(128&t[0]);t[0]^=n?255:128;for(let s=1;s<t.length;++s)t[s]^=n?255:0;return t}de(e){const t=255&e;0===t?(this.Pe(0),this.Pe(255)):255===t?(this.Pe(255),this.Pe(0)):this.Pe(t)}me(e){const t=255&e;0===t?(this.ve(0),this.ve(255)):255===t?(this.ve(255),this.ve(0)):this.ve(e)}_e(){this.Pe(0),this.Pe(1)}ge(){this.ve(0),this.ve(1)}Pe(e){this.Te(1),this.buffer[this.position++]=e}ve(e){this.Te(1),this.buffer[this.position++]=~e}Te(e){const t=e+this.position;if(t<=this.buffer.length)return;let n=2*this.buffer.length;n<t&&(n=t);const s=new Uint8Array(n);s.set(this.buffer),this.buffer=s}}class fr{constructor(e){this.Se=e}oe(e){this.Se.fe(e)}se(e){this.Se.ye(e)}ne(e){this.Se.Ie(e)}te(){this.Se.Re()}}class mr{constructor(e){this.Se=e}oe(e){this.Se.we(e)}se(e){this.Se.pe(e)}ne(e){this.Se.Ae(e)}te(){this.Se.be()}}class gr{constructor(){this.Se=new dr,this.De=new fr(this.Se),this.Ce=new mr(this.Se)}seed(e){this.Se.seed(e)}Ne(e){return 0===e?this.De:this.Ce}Ve(){return this.Se.Ve()}reset(){this.Se.reset()}}class pr{constructor(e,t,n,s){this.indexId=e,this.documentKey=t,this.arrayValue=n,this.directionalValue=s}}function yr(e,t){let n=e.indexId-t.indexId;return 0!==n?n:(n=he.comparator(e.documentKey,t.documentKey),0!==n?n:(n=wr(e.arrayValue,t.arrayValue),0!==n?n:wr(e.directionalValue,t.directionalValue)))}function wr(e,t){for(let n=0;n<e.length&&n<t.length;++n){const s=e[n]-t[n];if(0!==s)return s}return e.length-t.length}class vr{constructor(){this.xe=new Ir}addToCollectionParentIndex(e,t){return this.xe.add(t),As.resolve()}getCollectionParents(e,t){return As.resolve(this.xe.getEntries(t))}addFieldIndex(e,t){return As.resolve()}deleteFieldIndex(e,t){return As.resolve()}getDocumentsMatchingTarget(e,t,n){return As.resolve(ln())}getFieldIndex(e,t){return As.resolve(null)}getFieldIndexes(e,t){return As.resolve([])}getNextCollectionGroupToUpdate(e){return As.resolve(null)}updateCollectionGroup(e,t,n){return As.resolve()}updateIndexEntries(e,t){return As.resolve()}}class Ir{constructor(){this.index={}}add(e){const t=e.lastSegment(),n=e.popLast(),s=this.index[t]||new tn(Q.comparator),r=!s.has(n);return this.index[t]=s.add(n),r}has(e){const t=e.lastSegment(),n=e.popLast(),s=this.index[t];return s&&s.has(n)}getEntries(e){return(this.index[e]||new tn(Q.comparator)).toArray()}}class Tr{constructor(e){this.user=e,this.ke=new Ir,this.uid=e.uid||""}addToCollectionParentIndex(e,t){if(!this.ke.has(t)){const n=t.lastSegment(),s=t.popLast();e.addOnCommittedListener((()=>{this.ke.add(t)}));const r={collectionId:n,parent:es(s)};return Er(e).put(r)}return As.resolve()}getCollectionParents(e,t){const n=[],s=IDBKeyRange.bound([t,""],[q(t),""],!1,!0);return Er(e).qt(s).next((e=>{for(const s of e){if(s.collectionId!==t)break;n.push(ss(s.parent))}return n}))}addFieldIndex(e,t){const n=Sr(e),s=function(e){return new Is(e.indexId,e.collectionGroup,e.fields.map((e=>[e.fieldPath.canonicalString(),e.kind])))}(t);return delete s.indexId,n.add(s).next()}deleteFieldIndex(e,t){const n=Sr(e),s=xr(e),r=br(e);return n.delete(t.indexId).next((()=>s.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0)))).next((()=>r.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0))))}getDocumentsMatchingTarget(e,t,n){return As.resolve(ln())}getFieldIndex(e,t){return As.resolve(null)}Oe(e,t){const n=new gr;for(const s of function(e){return e.fields.filter((e=>2!==e.kind))}(e)){const e=t.data.field(s.fieldPath);if(null==e)return null;const r=n.Ne(s.kind);ur.le.Xt(e,r)}return n.Ve()}Me(e){const t=new gr;return ur.le.Xt(e,t.Ne(0)),t.Ve()}getFieldIndexes(e,t){const n=Sr(e),s=xr(e);return(t?n.qt(Is.collectionGroupIndex,IDBKeyRange.bound(t,t)):n.qt()).next((e=>{const t=[];return As.forEach(e,(e=>s.get([e.indexId,this.uid]).next((n=>{t.push(function(e,t){const n=t?new Ce(t.sequenceNumber,new Oe(Js(t.readTime),new he(ss(t.documentKey)),t.largestBatchId)):Ce.empty(),s=e.fields.map((([e,t])=>new De(W.fromServerFormat(e),t)));return new Ae(e.indexId,e.collectionGroup,s,n)}(e,n))})))).next((()=>t))}))}getNextCollectionGroupToUpdate(e){return this.getFieldIndexes(e).next((e=>0===e.length?null:(e.sort(((e,t)=>e.indexState.sequenceNumber-t.indexState.sequenceNumber)),e[0].collectionGroup)))}updateCollectionGroup(e,t,n){const s=Sr(e),r=xr(e);return this.$e(e).next((e=>s.qt(Is.collectionGroupIndex,IDBKeyRange.bound(t,t)).next((t=>As.forEach(t,(t=>r.put(function(e,t,n,s){return new Ts(e,t.uid||"",n,Ys(s.readTime),es(s.documentKey.path),s.largestBatchId)}(t.indexId,this.user,e,n))))))))}updateIndexEntries(e,t){const n=new Map;return As.forEach(t,((t,s)=>{const r=n.get(t.collectionGroup);return(r?As.resolve(r):this.getFieldIndexes(e,t.collectionGroup)).next((r=>(n.set(t.collectionGroup,r),As.forEach(r,(n=>this.Fe(e,t,n).next((t=>{const r=this.Be(s,n);return t.isEqual(r)?As.resolve():this.Le(e,s,t,r)})))))))}))}Ue(e,t,n){return br(e).put(new Es(n.indexId,this.uid,n.arrayValue,n.directionalValue,es(t.key.path)))}qe(e,t,n){return br(e).delete([n.indexId,this.uid,n.arrayValue,n.directionalValue,es(t.key.path)])}Fe(e,t,n){const s=br(e);let r=new tn(yr);return s.Qt({index:Es.documentKeyIndex,range:IDBKeyRange.only([n.indexId,this.uid,es(t.path)])},((e,s)=>{r=r.add(new pr(n.indexId,t,s.arrayValue,s.directionalValue))})).next((()=>r))}Be(e,t){let n=new tn(yr);const s=this.Oe(t,e);if(null==s)return n;const r=function(e){return e.fields.find((e=>2===e.kind))}(t);if(null!=r){const i=e.data.field(r.fieldPath);if(Te(i))for(const r of i.arrayValue.values||[])n=n.add(new pr(t.indexId,e.key,this.Me(r),s))}else n=n.add(new pr(t.indexId,e.key,new Uint8Array,s));return n}Le(e,t,n,s){g("IndexedDbIndexManager","Updating index entries for document '%s'",t.key);const r=[];return function(e,t,n,s,r){const i=e.getIterator(),o=t.getIterator();let a=sn(i),c=sn(o);for(;a||c;){let e=!1,t=!1;if(a&&c){const s=n(a,c);s<0?t=!0:s>0&&(e=!0)}else null!=a?t=!0:e=!0;e?(s(c),c=sn(o)):t?(r(a),a=sn(i)):(a=sn(i),c=sn(o))}}(n,s,yr,(n=>{r.push(this.Ue(e,t,n))}),(n=>{r.push(this.qe(e,t,n))})),As.waitFor(r)}$e(e){let t=1;return xr(e).Qt({index:Ts.sequenceNumberIndex,reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},((e,n,s)=>{s.done(),t=n.sequenceNumber+1})).next((()=>t))}}function Er(e){return Us(e,ps.store)}function br(e){return Us(e,Es.store)}function Sr(e){return Us(e,Is.store)}function xr(e){return Us(e,Ts.store)}const Nr={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0};class _r{constructor(e,t,n){this.cacheSizeCollectionThreshold=e,this.percentileToCollect=t,this.maximumSequenceNumbersToCollect=n}static withCacheSize(e){return new _r(e,_r.DEFAULT_COLLECTION_PERCENTILE,_r.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}}function kr(e,t,n){const s=e.store(as.store),r=e.store(cs.store),i=[],o=IDBKeyRange.only(n.batchId);let a=0;const c=s.Qt({range:o},((e,t,n)=>(a++,n.delete())));i.push(c.next((()=>{I(1===a)})));const u=[];for(const h of n.mutations){const e=cs.key(t,h.key.path,n.batchId);i.push(r.delete(e)),u.push(h.key)}return As.waitFor(i).next((()=>u))}function Ar(e){if(!e)return 0;let t;if(e.document)t=e.document;else if(e.unknownDocument)t=e.unknownDocument;else{if(!e.noDocument)throw v();t=e.noDocument}return JSON.stringify(t).length}_r.DEFAULT_COLLECTION_PERCENTILE=10,_r.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,_r.DEFAULT=new _r(41943040,_r.DEFAULT_COLLECTION_PERCENTILE,_r.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),_r.DISABLED=new _r(-1,0,0);class Dr{constructor(e,t,n,s){this.userId=e,this.O=t,this.indexManager=n,this.referenceDelegate=s,this.Ke={}}static Jt(e,t,n,s){I(""!==e.uid);const r=e.isAuthenticated()?e.uid:"";return new Dr(r,t,n,s)}checkEmpty(e){let t=!0;const n=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return Or(e).Qt({index:as.userMutationsIndex,range:n},((e,n,s)=>{t=!1,s.done()})).next((()=>t))}addMutationBatch(e,t,n,s){const r=Rr(e),i=Or(e);return i.add({}).next((o=>{I("number"==typeof o);const a=new Bs(o,t,n,s),c=function(e,t,n){const s=n.baseMutations.map((t=>Un(e.Ht,t))),r=n.mutations.map((t=>Un(e.Ht,t)));return new as(t,n.batchId,n.localWriteTime.toMillis(),s,r)}(this.O,this.userId,a),u=[];let h=new tn(((e,t)=>V(e.canonicalString(),t.canonicalString())));for(const e of s){const t=cs.key(this.userId,e.key.path,o);h=h.add(e.key.path.popLast()),u.push(i.put(c)),u.push(r.put(t,cs.PLACEHOLDER))}return h.forEach((t=>{u.push(this.indexManager.addToCollectionParentIndex(e,t))})),e.addOnCommittedListener((()=>{this.Ke[o]=a.keys()})),As.waitFor(u).next((()=>a))}))}lookupMutationBatch(e,t){return Or(e).get(t).next((e=>e?(I(e.userId===this.userId),Xs(this.O,e)):null))}Ge(e,t){return this.Ke[t]?As.resolve(this.Ke[t]):this.lookupMutationBatch(e,t).next((e=>{if(e){const n=e.keys();return this.Ke[t]=n,n}return null}))}getNextMutationBatchAfterBatchId(e,t){const n=t+1,s=IDBKeyRange.lowerBound([this.userId,n]);let r=null;return Or(e).Qt({index:as.userMutationsIndex,range:s},((e,t,s)=>{t.userId===this.userId&&(I(t.batchId>=n),r=Xs(this.O,t)),s.done()})).next((()=>r))}getHighestUnacknowledgedBatchId(e){const t=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]);let n=-1;return Or(e).Qt({index:as.userMutationsIndex,range:t,reverse:!0},((e,t,s)=>{n=t.batchId,s.done()})).next((()=>n))}getAllMutationBatches(e){const t=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return Or(e).qt(as.userMutationsIndex,t).next((e=>e.map((e=>Xs(this.O,e)))))}getAllMutationBatchesAffectingDocumentKey(e,t){const n=cs.prefixForPath(this.userId,t.path),s=IDBKeyRange.lowerBound(n),r=[];return Rr(e).Qt({range:s},((n,s,i)=>{const[o,a,c]=n,u=ss(a);if(o===this.userId&&t.path.isEqual(u))return Or(e).get(c).next((e=>{if(!e)throw v();I(e.userId===this.userId),r.push(Xs(this.O,e))}));i.done()})).next((()=>r))}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new tn(V);const s=[];return t.forEach((t=>{const r=cs.prefixForPath(this.userId,t.path),i=IDBKeyRange.lowerBound(r),o=Rr(e).Qt({range:i},((e,s,r)=>{const[i,o,a]=e,c=ss(o);i===this.userId&&t.path.isEqual(c)?n=n.add(a):r.done()}));s.push(o)})),As.waitFor(s).next((()=>this.je(e,n)))}getAllMutationBatchesAffectingQuery(e,t){const n=t.path,s=n.length+1,r=cs.prefixForPath(this.userId,n),i=IDBKeyRange.lowerBound(r);let o=new tn(V);return Rr(e).Qt({range:i},((e,t,r)=>{const[i,a,c]=e,u=ss(a);i===this.userId&&n.isPrefixOf(u)?u.length===s&&(o=o.add(c)):r.done()})).next((()=>this.je(e,o)))}je(e,t){const n=[],s=[];return t.forEach((t=>{s.push(Or(e).get(t).next((e=>{if(null===e)throw v();I(e.userId===this.userId),n.push(Xs(this.O,e))})))})),As.waitFor(s).next((()=>n))}removeMutationBatch(e,t){return kr(e.zt,this.userId,t).next((n=>(e.addOnCommittedListener((()=>{this.Qe(t.batchId)})),As.forEach(n,(t=>this.referenceDelegate.markPotentiallyOrphaned(e,t))))))}Qe(e){delete this.Ke[e]}performConsistencyCheck(e){return this.checkEmpty(e).next((t=>{if(!t)return As.resolve();const n=IDBKeyRange.lowerBound(cs.prefixForUser(this.userId)),s=[];return Rr(e).Qt({range:n},((e,t,n)=>{if(e[0]===this.userId){const t=ss(e[1]);s.push(t)}else n.done()})).next((()=>{I(0===s.length)}))}))}containsKey(e,t){return Cr(e,this.userId,t)}We(e){return Lr(e).get(this.userId).next((e=>e||new os(this.userId,-1,"")))}}function Cr(e,t,n){const s=cs.prefixForPath(t,n.path),r=s[1],i=IDBKeyRange.lowerBound(s);let o=!1;return Rr(e).Qt({range:i,jt:!0},((e,n,s)=>{const[i,a,c]=e;i===t&&a===r&&(o=!0),s.done()})).next((()=>o))}function Or(e){return Us(e,as.store)}function Rr(e){return Us(e,cs.store)}function Lr(e){return Us(e,os.store)}class Mr{constructor(e){this.ze=e}next(){return this.ze+=2,this.ze}static He(){return new Mr(0)}static Je(){return new Mr(-1)}}class Pr{constructor(e,t){this.referenceDelegate=e,this.O=t}allocateTargetId(e){return this.Ye(e).next((t=>{const n=new Mr(t.highestTargetId);return t.highestTargetId=n.next(),this.Xe(e,t).next((()=>t.highestTargetId))}))}getLastRemoteSnapshotVersion(e){return this.Ye(e).next((e=>B.fromTimestamp(new U(e.lastRemoteSnapshotVersion.seconds,e.lastRemoteSnapshotVersion.nanoseconds))))}getHighestSequenceNumber(e){return this.Ye(e).next((e=>e.highestListenSequenceNumber))}setTargetsMetadata(e,t,n){return this.Ye(e).next((s=>(s.highestListenSequenceNumber=t,n&&(s.lastRemoteSnapshotVersion=n.toTimestamp()),t>s.highestListenSequenceNumber&&(s.highestListenSequenceNumber=t),this.Xe(e,s))))}addTargetData(e,t){return this.Ze(e,t).next((()=>this.Ye(e).next((n=>(n.targetCount+=1,this.tn(t,n),this.Xe(e,n))))))}updateTargetData(e,t){return this.Ze(e,t)}removeTargetData(e,t){return this.removeMatchingKeysForTargetId(e,t.targetId).next((()=>Vr(e).delete(t.targetId))).next((()=>this.Ye(e))).next((t=>(I(t.targetCount>0),t.targetCount-=1,this.Xe(e,t))))}removeTargets(e,t,n){let s=0;const r=[];return Vr(e).Qt(((i,o)=>{const a=Zs(o);a.sequenceNumber<=t&&null===n.get(a.targetId)&&(s++,r.push(this.removeTargetData(e,a)))})).next((()=>As.waitFor(r))).next((()=>s))}forEachTarget(e,t){return Vr(e).Qt(((e,n)=>{const s=Zs(n);t(s)}))}Ye(e){return Fr(e).get(gs.key).next((e=>(I(null!==e),e)))}Xe(e,t){return Fr(e).put(gs.key,t)}Ze(e,t){return Vr(e).put(er(this.O,t))}tn(e,t){let n=!1;return e.targetId>t.highestTargetId&&(t.highestTargetId=e.targetId,n=!0),e.sequenceNumber>t.highestListenSequenceNumber&&(t.highestListenSequenceNumber=e.sequenceNumber,n=!0),n}getTargetCount(e){return this.Ye(e).next((e=>e.targetCount))}getTargetData(e,t){const n=Me(t),s=IDBKeyRange.bound([n,Number.NEGATIVE_INFINITY],[n,Number.POSITIVE_INFINITY]);let r=null;return Vr(e).Qt({range:s,index:fs.queryTargetsIndexName},((e,n,s)=>{const i=Zs(n);Pe(t,i.target)&&(r=i,s.done())})).next((()=>r))}addMatchingKeys(e,t,n){const s=[],r=qr(e);return t.forEach((t=>{const i=es(t.path);s.push(r.put(new ms(n,i))),s.push(this.referenceDelegate.addReference(e,n,t))})),As.waitFor(s)}removeMatchingKeys(e,t,n){const s=qr(e);return As.forEach(t,(t=>{const r=es(t.path);return As.waitFor([s.delete([n,r]),this.referenceDelegate.removeReference(e,n,t)])}))}removeMatchingKeysForTargetId(e,t){const n=qr(e),s=IDBKeyRange.bound([t],[t+1],!1,!0);return n.delete(s)}getMatchingKeysForTargetId(e,t){const n=IDBKeyRange.bound([t],[t+1],!1,!0),s=qr(e);let r=ln();return s.Qt({range:n,jt:!0},((e,t,n)=>{const s=ss(e[1]),i=new he(s);r=r.add(i)})).next((()=>r))}containsKey(e,t){const n=es(t.path),s=IDBKeyRange.bound([n],[q(n)],!1,!0);let r=0;return qr(e).Qt({index:ms.documentTargetsIndex,jt:!0,range:s},(([e,t],n,s)=>{0!==e&&(r++,s.done())})).next((()=>r>0))}Tt(e,t){return Vr(e).get(t).next((e=>e?Zs(e):null))}}function Vr(e){return Us(e,fs.store)}function Fr(e){return Us(e,gs.store)}function qr(e){return Us(e,ms.store)}async function Ur(e){if(e.code!==b.FAILED_PRECONDITION||e.message!==_s)throw e;g("LocalStore","Unexpectedly lost primary lease")}function Br([e,t],[n,s]){const r=V(e,n);return 0===r?V(t,s):r}class Kr{constructor(e){this.en=e,this.buffer=new tn(Br),this.nn=0}sn(){return++this.nn}rn(e){const t=[e,this.sn()];if(this.buffer.size<this.en)this.buffer=this.buffer.add(t);else{const e=this.buffer.last();Br(t,e)<0&&(this.buffer=this.buffer.delete(e).add(t))}}get maxValue(){return this.buffer.last()[0]}}class Gr{constructor(e,t){this.garbageCollector=e,this.asyncQueue=t,this.on=!1,this.cn=null}start(e){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.un(e)}stop(){this.cn&&(this.cn.cancel(),this.cn=null)}get started(){return null!==this.cn}un(e){const t=this.on?3e5:6e4;g("LruGarbageCollector",`Garbage collection scheduled in ${t}ms`),this.cn=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",t,(async()=>{this.cn=null,this.on=!0;try{await e.collectGarbage(this.garbageCollector)}catch(e){Ls(e)?g("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",e):await Ur(e)}await this.un(e)}))}}class $r{constructor(e,t){this.an=e,this.params=t}calculateTargetCount(e,t){return this.an.hn(e).next((e=>Math.floor(t/100*e)))}nthSequenceNumber(e,t){if(0===t)return As.resolve(L.A);const n=new Kr(t);return this.an.forEachTarget(e,(e=>n.rn(e.sequenceNumber))).next((()=>this.an.ln(e,(e=>n.rn(e))))).next((()=>n.maxValue))}removeTargets(e,t,n){return this.an.removeTargets(e,t,n)}removeOrphanedDocuments(e,t){return this.an.removeOrphanedDocuments(e,t)}collect(e,t){return-1===this.params.cacheSizeCollectionThreshold?(g("LruGarbageCollector","Garbage collection skipped; disabled"),As.resolve(Nr)):this.getCacheSize(e).next((n=>n<this.params.cacheSizeCollectionThreshold?(g("LruGarbageCollector",`Garbage collection skipped; Cache size ${n} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),Nr):this.fn(e,t)))}getCacheSize(e){return this.an.getCacheSize(e)}fn(e,t){let n,s,r,o,a,c,u;const h=Date.now();return this.calculateTargetCount(e,this.params.percentileToCollect).next((t=>(t>this.params.maximumSequenceNumbersToCollect?(g("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${t}`),s=this.params.maximumSequenceNumbersToCollect):s=t,o=Date.now(),this.nthSequenceNumber(e,s)))).next((s=>(n=s,a=Date.now(),this.removeTargets(e,n,t)))).next((t=>(r=t,c=Date.now(),this.removeOrphanedDocuments(e,n)))).next((e=>(u=Date.now(),f()<=i.in.DEBUG&&g("LruGarbageCollector",`LRU Garbage Collection\n\tCounted targets in ${o-h}ms\n\tDetermined least recently used ${s} in `+(a-o)+"ms\n"+`\tRemoved ${r} targets in `+(c-a)+"ms\n"+`\tRemoved ${e} documents in `+(u-c)+"ms\n"+`Total Duration: ${u-h}ms`),As.resolve({didRun:!0,sequenceNumbersCollected:s,targetsRemoved:r,documentsRemoved:e}))))}}class jr{constructor(e,t){this.db=e,this.garbageCollector=function(e,t){return new $r(e,t)}(this,t)}hn(e){const t=this.dn(e);return this.db.getTargetCache().getTargetCount(e).next((e=>t.next((t=>e+t))))}dn(e){let t=0;return this.ln(e,(e=>{t++})).next((()=>t))}forEachTarget(e,t){return this.db.getTargetCache().forEachTarget(e,t)}ln(e,t){return this._n(e,((e,n)=>t(n)))}addReference(e,t,n){return Qr(e,n)}removeReference(e,t,n){return Qr(e,n)}removeTargets(e,t,n){return this.db.getTargetCache().removeTargets(e,t,n)}markPotentiallyOrphaned(e,t){return Qr(e,t)}wn(e,t){return function(e,t){let n=!1;return Lr(e).Wt((s=>Cr(e,s,t).next((e=>(e&&(n=!0),As.resolve(!e)))))).next((()=>n))}(e,t)}removeOrphanedDocuments(e,t){const n=this.db.getRemoteDocumentCache().newChangeBuffer(),s=[];let r=0;return this._n(e,((i,o)=>{if(o<=t){const t=this.wn(e,i).next((t=>{if(!t)return r++,n.getEntry(e,i).next((()=>(n.removeEntry(i,B.min()),qr(e).delete([0,es(i.path)]))))}));s.push(t)}})).next((()=>As.waitFor(s))).next((()=>n.apply(e))).next((()=>r))}removeTarget(e,t){const n=t.withSequenceNumber(e.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(e,n)}updateLimboDocument(e,t){return Qr(e,t)}_n(e,t){const n=qr(e);let s,r=L.A;return n.Qt({index:ms.documentTargetsIndex},(([e,n],{path:i,sequenceNumber:o})=>{0===e?(r!==L.A&&t(new he(ss(s)),r),r=o,s=i):r=L.A})).next((()=>{r!==L.A&&t(new he(ss(s)),r)}))}getCacheSize(e){return this.db.getRemoteDocumentCache().getSize(e)}}function Qr(e,t){return qr(e).put(function(e,t){return new ms(0,es(e.path),t)}(t,e.currentSequenceNumber))}class zr{constructor(e,t){this.mapKeyFn=e,this.equalsFn=t,this.inner={}}get(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0!==n)for(const[s,r]of n)if(this.equalsFn(s,e))return r}has(e){return void 0!==this.get(e)}set(e,t){const n=this.mapKeyFn(e),s=this.inner[n];if(void 0!==s){for(let n=0;n<s.length;n++)if(this.equalsFn(s[n][0],e))return void(s[n]=[e,t]);s.push([e,t])}else this.inner[n]=[[e,t]]}delete(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0===n)return!1;for(let s=0;s<n.length;s++)if(this.equalsFn(n[s][0],e))return 1===n.length?delete this.inner[t]:n.splice(s,1),!0;return!1}forEach(e){G(this.inner,((t,n)=>{for(const[s,r]of n)e(s,r)}))}isEmpty(){return $(this.inner)}}class Wr{constructor(){this.changes=new zr((e=>e.toString()),((e,t)=>e.isEqual(t))),this.changesApplied=!1}addEntry(e){this.assertNotApplied(),this.changes.set(e.key,e)}removeEntry(e,t){this.assertNotApplied(),this.changes.set(e,ke.newInvalidDocument(e).setReadTime(t))}getEntry(e,t){this.assertNotApplied();const n=this.changes.get(t);return void 0!==n?As.resolve(n):this.getFromCache(e,t)}getEntries(e,t){return this.getAllFromCache(e,t)}apply(e){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(e)}assertNotApplied(){}}class Hr{constructor(e){this.O=e}setIndexManager(e){this.indexManager=e}addEntry(e,t,n){return Xr(e).put(Zr(t),n)}removeEntry(e,t){const n=Xr(e),s=Zr(t);return n.delete(s)}updateMetadata(e,t){return this.getMetadata(e).next((n=>(n.byteSize+=t,this.mn(e,n))))}getEntry(e,t){return Xr(e).get(Zr(t)).next((e=>this.gn(t,e)))}yn(e,t){return Xr(e).get(Zr(t)).next((e=>({document:this.gn(t,e),size:Ar(e)})))}getEntries(e,t){let n=on();return this.pn(e,t,((e,t)=>{const s=this.gn(e,t);n=n.insert(e,s)})).next((()=>n))}In(e,t){let n=on(),s=new Xt(he.comparator);return this.pn(e,t,((e,t)=>{const r=this.gn(e,t);n=n.insert(e,r),s=s.insert(e,Ar(t))})).next((()=>({documents:n,En:s})))}pn(e,t,n){if(t.isEmpty())return As.resolve();const s=IDBKeyRange.bound(t.first().path.toArray(),t.last().path.toArray()),r=t.getIterator();let i=r.getNext();return Xr(e).Qt({range:s},((e,t,s)=>{const o=he.fromSegments(e);for(;i&&he.comparator(i,o)<0;)n(i,null),i=r.getNext();i&&i.isEqual(o)&&(n(i,t),i=r.hasNext()?r.getNext():null),i?s.Ut(i.path.toArray()):s.done()})).next((()=>{for(;i;)n(i,null),i=r.hasNext()?r.getNext():null}))}getAll(e,t,n){let s=on();const r=t.length+1,i={};if(n.isEqual(B.min())){const e=t.toArray();i.range=IDBKeyRange.lowerBound(e)}else{const e=t.toArray(),s=Ws(n);i.range=IDBKeyRange.lowerBound([e,s],!0),i.index=ls.collectionReadTimeIndex}return Xr(e).Qt(i,((e,n,i)=>{if(e.length!==r)return;const o=this.gn(he.fromSegments(e),n);t.isPrefixOf(o.key.path)?s=s.insert(o.key,o):i.done()})).next((()=>s))}newChangeBuffer(e){return new Yr(this,!!e&&e.trackRemovals)}getSize(e){return this.getMetadata(e).next((e=>e.byteSize))}getMetadata(e){return Jr(e).get(ds.key).next((e=>(I(!!e),e)))}mn(e,t){return Jr(e).put(ds.key,t)}gn(e,t){if(t){const e=Qs(this.O,t);if(!e.isNoDocument()||!e.version.isEqual(B.min()))return e}return ke.newInvalidDocument(e)}}class Yr extends Wr{constructor(e,t){super(),this.Tn=e,this.trackRemovals=t,this.An=new zr((e=>e.toString()),((e,t)=>e.isEqual(t)))}applyChanges(e){const t=[];let n=0,s=new tn(((e,t)=>V(e.canonicalString(),t.canonicalString())));return this.changes.forEach(((r,i)=>{const o=this.An.get(r);if(i.isValidDocument()){const a=zs(this.Tn.O,i);s=s.add(r.path.popLast());const c=Ar(a);n+=c-o,t.push(this.Tn.addEntry(e,r,a))}else if(n-=o,this.trackRemovals){const n=zs(this.Tn.O,i.convertToNoDocument(B.min()));t.push(this.Tn.addEntry(e,r,n))}else t.push(this.Tn.removeEntry(e,r))})),s.forEach((n=>{t.push(this.Tn.indexManager.addToCollectionParentIndex(e,n))})),t.push(this.Tn.updateMetadata(e,n)),As.waitFor(t)}getFromCache(e,t){return this.Tn.yn(e,t).next((e=>(this.An.set(t,e.size),e.document)))}getAllFromCache(e,t){return this.Tn.In(e,t).next((({documents:e,En:t})=>(t.forEach(((e,t)=>{this.An.set(e,t)})),e)))}}function Jr(e){return Us(e,ds.store)}function Xr(e){return Us(e,ls.store)}function Zr(e){return e.path.toArray()}class ei{constructor(e){this.O=e}kt(e,t,n,s){const r=new Ds("createOrUpgrade",t);n<1&&s>=1&&(function(e){e.createObjectStore(is.store)}(e),function(e){e.createObjectStore(os.store,{keyPath:os.keyPath}),e.createObjectStore(as.store,{keyPath:as.keyPath,autoIncrement:!0}).createIndex(as.userMutationsIndex,as.userMutationsKeyPath,{unique:!0}),e.createObjectStore(cs.store)}(e),ti(e),function(e){e.createObjectStore(ls.store)}(e));let i=As.resolve();return n<3&&s>=3&&(0!==n&&(function(e){e.deleteObjectStore(ms.store),e.deleteObjectStore(fs.store),e.deleteObjectStore(gs.store)}(e),ti(e)),i=i.next((()=>function(e){const t=e.store(gs.store),n=new gs(0,0,B.min().toTimestamp(),0);return t.put(gs.key,n)}(r)))),n<4&&s>=4&&(0!==n&&(i=i.next((()=>function(e,t){return t.store(as.store).qt().next((n=>{e.deleteObjectStore(as.store),e.createObjectStore(as.store,{keyPath:as.keyPath,autoIncrement:!0}).createIndex(as.userMutationsIndex,as.userMutationsKeyPath,{unique:!0});const s=t.store(as.store),r=n.map((e=>s.put(e)));return As.waitFor(r)}))}(e,r)))),i=i.next((()=>{!function(e){e.createObjectStore(ys.store,{keyPath:ys.keyPath})}(e)}))),n<5&&s>=5&&(i=i.next((()=>this.Rn(r)))),n<6&&s>=6&&(i=i.next((()=>(function(e){e.createObjectStore(ds.store)}(e),this.Pn(r))))),n<7&&s>=7&&(i=i.next((()=>this.bn(r)))),n<8&&s>=8&&(i=i.next((()=>this.vn(e,r)))),n<9&&s>=9&&(i=i.next((()=>{!function(e){e.objectStoreNames.contains("remoteDocumentChanges")&&e.deleteObjectStore("remoteDocumentChanges")}(e),function(e){const t=e.objectStore(ls.store);t.createIndex(ls.readTimeIndex,ls.readTimeIndexPath,{unique:!1}),t.createIndex(ls.collectionReadTimeIndex,ls.collectionReadTimeIndexPath,{unique:!1})}(t)}))),n<10&&s>=10&&(i=i.next((()=>this.Vn(r)))),n<11&&s>=11&&(i=i.next((()=>{!function(e){e.createObjectStore(ws.store,{keyPath:ws.keyPath})}(e),function(e){e.createObjectStore(vs.store,{keyPath:vs.keyPath})}(e)}))),n<12&&s>=12&&(i=i.next((()=>{!function(e){const t=e.createObjectStore(bs.store,{keyPath:bs.keyPath});t.createIndex(bs.collectionPathOverlayIndex,bs.collectionPathOverlayIndexPath,{unique:!1}),t.createIndex(bs.collectionGroupOverlayIndex,bs.collectionGroupOverlayIndexPath,{unique:!1})}(e)}))),n<13&&s>=13&&(i=i.next((()=>{!function(e){e.createObjectStore(Is.store,{keyPath:Is.keyPath,autoIncrement:!0}).createIndex(Is.collectionGroupIndex,Is.collectionGroupIndexPath,{unique:!1}),e.createObjectStore(Ts.store,{keyPath:Ts.keyPath}).createIndex(Ts.sequenceNumberIndex,Ts.sequenceNumberIndexPath,{unique:!1}),e.createObjectStore(Es.store,{keyPath:Es.keyPath}).createIndex(Es.documentKeyIndex,Es.documentKeyIndexPath,{unique:!1})}(e)}))),i}Pn(e){let t=0;return e.store(ls.store).Qt(((e,n)=>{t+=Ar(n)})).next((()=>{const n=new ds(t);return e.store(ds.store).put(ds.key,n)}))}Rn(e){const t=e.store(os.store),n=e.store(as.store);return t.qt().next((t=>As.forEach(t,(t=>{const s=IDBKeyRange.bound([t.userId,-1],[t.userId,t.lastAcknowledgedBatchId]);return n.qt(as.userMutationsIndex,s).next((n=>As.forEach(n,(n=>{I(n.userId===t.userId);const s=Xs(this.O,n);return kr(e,t.userId,s).next((()=>{}))}))))}))))}bn(e){const t=e.store(ms.store),n=e.store(ls.store);return e.store(gs.store).get(gs.key).next((e=>{const s=[];return n.Qt(((n,r)=>{const i=new Q(n),o=function(e){return[0,es(e)]}(i);s.push(t.get(o).next((n=>n?As.resolve():(n=>t.put(new ms(0,es(n),e.highestListenSequenceNumber)))(i))))})).next((()=>As.waitFor(s)))}))}vn(e,t){e.createObjectStore(ps.store,{keyPath:ps.keyPath});const n=t.store(ps.store),s=new Ir,r=e=>{if(s.add(e)){const t=e.lastSegment(),s=e.popLast();return n.put({collectionId:t,parent:es(s)})}};return t.store(ls.store).Qt({jt:!0},((e,t)=>{const n=new Q(e);return r(n.popLast())})).next((()=>t.store(cs.store).Qt({jt:!0},(([e,t,n],s)=>{const i=ss(t);return r(i.popLast())}))))}Vn(e){const t=e.store(fs.store);return t.Qt(((e,n)=>{const s=Zs(n),r=er(this.O,s);return t.put(r)}))}}function ti(e){e.createObjectStore(ms.store,{keyPath:ms.keyPath}).createIndex(ms.documentTargetsIndex,ms.documentTargetsKeyPath,{unique:!0}),e.createObjectStore(fs.store,{keyPath:fs.keyPath}).createIndex(fs.queryTargetsIndexName,fs.queryTargetsKeyPath,{unique:!0}),e.createObjectStore(gs.store)}const ni="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.";class si{constructor(e,t,n,s,r,i,o,a,c,u,h=12){if(this.allowTabSynchronization=e,this.persistenceKey=t,this.clientId=n,this.Sn=r,this.window=i,this.document=o,this.Dn=c,this.Cn=u,this.schemaVersion=h,this.Nn=null,this.xn=!1,this.isPrimary=!1,this.networkEnabled=!0,this.kn=null,this.inForeground=!1,this.On=null,this.Mn=null,this.$n=Number.NEGATIVE_INFINITY,this.Fn=e=>Promise.resolve(),!si.Vt())throw new S(b.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new jr(this,s),this.Bn=t+"main",this.O=new js(a),this.Ln=new Cs(this.Bn,this.schemaVersion,new ei(this.O)),this.Un=new Pr(this.referenceDelegate,this.O),this.qn=function(e){return new Hr(e)}(this.O),this.Kn=new rr,this.window&&this.window.localStorage?this.Gn=this.window.localStorage:(this.Gn=null,!1===u&&p("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.jn().then((()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new S(b.FAILED_PRECONDITION,ni);return this.Qn(),this.Wn(),this.zn(),this.runTransaction("getHighestListenSequenceNumber","readonly",(e=>this.Un.getHighestSequenceNumber(e)))})).then((e=>{this.Nn=new L(e,this.Dn)})).then((()=>{this.xn=!0})).catch((e=>(this.Ln&&this.Ln.close(),Promise.reject(e))))}Hn(e){return this.Fn=async t=>{if(this.started)return e(t)},e(this.isPrimary)}setDatabaseDeletedListener(e){this.Ln.Mt((async t=>{null===t.newVersion&&await e()}))}setNetworkEnabled(e){this.networkEnabled!==e&&(this.networkEnabled=e,this.Sn.enqueueAndForget((async()=>{this.started&&await this.jn()})))}jn(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",(e=>ii(e).put(new ys(this.clientId,Date.now(),this.networkEnabled,this.inForeground)).next((()=>{if(this.isPrimary)return this.Jn(e).next((e=>{e||(this.isPrimary=!1,this.Sn.enqueueRetryable((()=>this.Fn(!1))))}))})).next((()=>this.Yn(e))).next((t=>this.isPrimary&&!t?this.Xn(e).next((()=>!1)):!!t&&this.Zn(e).next((()=>!0)))))).catch((e=>{if(Ls(e))return g("IndexedDbPersistence","Failed to extend owner lease: ",e),this.isPrimary;if(!this.allowTabSynchronization)throw e;return g("IndexedDbPersistence","Releasing owner lease after error during lease refresh",e),!1})).then((e=>{this.isPrimary!==e&&this.Sn.enqueueRetryable((()=>this.Fn(e))),this.isPrimary=e}))}Jn(e){return ri(e).get(is.key).next((e=>As.resolve(this.ts(e))))}es(e){return ii(e).delete(this.clientId)}async ns(){if(this.isPrimary&&!this.ss(this.$n,18e5)){this.$n=Date.now();const e=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",(e=>{const t=Us(e,ys.store);return t.qt().next((e=>{const n=this.rs(e,18e5),s=e.filter((e=>-1===n.indexOf(e)));return As.forEach(s,(e=>t.delete(e.clientId))).next((()=>s))}))})).catch((()=>[]));if(this.Gn)for(const t of e)this.Gn.removeItem(this.os(t.clientId))}}zn(){this.Mn=this.Sn.enqueueAfterDelay("client_metadata_refresh",4e3,(()=>this.jn().then((()=>this.ns())).then((()=>this.zn()))))}ts(e){return!!e&&e.ownerId===this.clientId}Yn(e){return this.Cn?As.resolve(!0):ri(e).get(is.key).next((t=>{if(null!==t&&this.ss(t.leaseTimestampMs,5e3)&&!this.cs(t.ownerId)){if(this.ts(t)&&this.networkEnabled)return!0;if(!this.ts(t)){if(!t.allowTabSynchronization)throw new S(b.FAILED_PRECONDITION,ni);return!1}}return!(!this.networkEnabled||!this.inForeground)||ii(e).qt().next((e=>void 0===this.rs(e,5e3).find((e=>{if(this.clientId!==e.clientId){const t=!this.networkEnabled&&e.networkEnabled,n=!this.inForeground&&e.inForeground,s=this.networkEnabled===e.networkEnabled;if(t||n&&s)return!0}return!1}))))})).next((e=>(this.isPrimary!==e&&g("IndexedDbPersistence",`Client ${e?"is":"is not"} eligible for a primary lease.`),e)))}async shutdown(){this.xn=!1,this.us(),this.Mn&&(this.Mn.cancel(),this.Mn=null),this.hs(),this.ls(),await this.Ln.runTransaction("shutdown","readwrite",[is.store,ys.store],(e=>{const t=new qs(e,L.A);return this.Xn(t).next((()=>this.es(t)))})),this.Ln.close(),this.fs()}rs(e,t){return e.filter((e=>this.ss(e.updateTimeMs,t)&&!this.cs(e.clientId)))}ds(){return this.runTransaction("getActiveClients","readonly",(e=>ii(e).qt().next((e=>this.rs(e,18e5).map((e=>e.clientId))))))}get started(){return this.xn}getMutationQueue(e,t){return Dr.Jt(e,this.O,t,this.referenceDelegate)}getTargetCache(){return this.Un}getRemoteDocumentCache(){return this.qn}getIndexManager(e){return new Tr(e)}getDocumentOverlayCache(e){return ar.Jt(this.O,e)}getBundleCache(){return this.Kn}runTransaction(e,t,n){g("IndexedDbPersistence","Starting transaction:",e);const s="readonly"===t?"readonly":"readwrite",r=13===(i=this.schemaVersion)?Ns:12===i?xs:11===i?Ss:void v();var i;let o;return this.Ln.runTransaction(e,s,r,(s=>(o=new qs(s,this.Nn?this.Nn.next():L.A),"readwrite-primary"===t?this.Jn(o).next((e=>!!e||this.Yn(o))).next((t=>{if(!t)throw p(`Failed to obtain primary lease for action '${e}'.`),this.isPrimary=!1,this.Sn.enqueueRetryable((()=>this.Fn(!1))),new S(b.FAILED_PRECONDITION,_s);return n(o)})).next((e=>this.Zn(o).next((()=>e)))):this._s(o).next((()=>n(o)))))).then((e=>(o.raiseOnCommittedEvent(),e)))}_s(e){return ri(e).get(is.key).next((e=>{if(null!==e&&this.ss(e.leaseTimestampMs,5e3)&&!this.cs(e.ownerId)&&!this.ts(e)&&!(this.Cn||this.allowTabSynchronization&&e.allowTabSynchronization))throw new S(b.FAILED_PRECONDITION,ni)}))}Zn(e){const t=new is(this.clientId,this.allowTabSynchronization,Date.now());return ri(e).put(is.key,t)}static Vt(){return Cs.Vt()}Xn(e){const t=ri(e);return t.get(is.key).next((e=>this.ts(e)?(g("IndexedDbPersistence","Releasing primary lease."),t.delete(is.key)):As.resolve()))}ss(e,t){const n=Date.now();return!(e<n-t)&&(!(e>n)||(p(`Detected an update time that is in the future: ${e} > ${n}`),!1))}Qn(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.On=()=>{this.Sn.enqueueAndForget((()=>(this.inForeground="visible"===this.document.visibilityState,this.jn())))},this.document.addEventListener("visibilitychange",this.On),this.inForeground="visible"===this.document.visibilityState)}hs(){this.On&&(this.document.removeEventListener("visibilitychange",this.On),this.On=null)}Wn(){var e;"function"==typeof(null===(e=this.window)||void 0===e?void 0:e.addEventListener)&&(this.kn=()=>{this.us(),(0,o.G6)()&&navigator.appVersion.match(/Version\/1[45]/)&&this.Sn.enterRestrictedMode(!0),this.Sn.enqueueAndForget((()=>this.shutdown()))},this.window.addEventListener("pagehide",this.kn))}ls(){this.kn&&(this.window.removeEventListener("pagehide",this.kn),this.kn=null)}cs(e){var t;try{const n=null!==(null===(t=this.Gn)||void 0===t?void 0:t.getItem(this.os(e)));return g("IndexedDbPersistence",`Client '${e}' ${n?"is":"is not"} zombied in LocalStorage`),n}catch(e){return p("IndexedDbPersistence","Failed to get zombied client id.",e),!1}}us(){if(this.Gn)try{this.Gn.setItem(this.os(this.clientId),String(Date.now()))}catch(e){p("Failed to set zombie client id.",e)}}fs(){if(this.Gn)try{this.Gn.removeItem(this.os(this.clientId))}catch(e){}}os(e){return`firestore_zombie_${this.persistenceKey}_${e}`}}function ri(e){return Us(e,is.store)}function ii(e){return Us(e,ys.store)}function oi(e,t){let n=e.projectId;return e.isDefaultDatabase||(n+="."+e.database),"firestore/"+t+"/"+n+"/"}class ai{constructor(e,t){this.progress=e,this.ws=t}}class ci{constructor(e,t,n){this.qn=e,this.gs=t,this.indexManager=n}ys(e,t){return this.gs.getAllMutationBatchesAffectingDocumentKey(e,t).next((n=>this.ps(e,t,n)))}ps(e,t,n){return this.qn.getEntry(e,t).next((e=>{for(const t of n)t.applyToLocalView(e);return e}))}Is(e,t){e.forEach(((e,n)=>{for(const s of t)s.applyToLocalView(n)}))}Es(e,t){return this.qn.getEntries(e,t).next((t=>this.Ts(e,t).next((()=>t))))}Ts(e,t){return this.gs.getAllMutationBatchesAffectingDocumentKeys(e,t).next((e=>this.Is(t,e)))}As(e,t,n){return function(e){return he.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}(t)?this.Rs(e,t.path):it(t)?this.Ps(e,t,n):this.bs(e,t,n)}Rs(e,t){return this.ys(e,new he(t)).next((e=>{let t=cn();return e.isFoundDocument()&&(t=t.insert(e.key,e)),t}))}Ps(e,t,n){const s=t.collectionGroup;let r=cn();return this.indexManager.getCollectionParents(e,s).next((i=>As.forEach(i,(i=>{const o=function(e,t){return new Xe(t,null,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)}(t,i.child(s));return this.bs(e,o,n).next((e=>{e.forEach(((e,t)=>{r=r.insert(e,t)}))}))})).next((()=>r))))}bs(e,t,n){let s;return this.qn.getAll(e,t.path,n).next((n=>(s=n,this.gs.getAllMutationBatchesAffectingQuery(e,t)))).next((e=>{for(const t of e)for(const e of t.mutations){const n=e.key;let r=s.get(n);null==r&&(r=ke.newInvalidDocument(n),s=s.insert(n,r)),Pt(e,r,t.localWriteTime),r.isFoundDocument()||(s=s.remove(n))}})).next((()=>(s.forEach(((e,n)=>{dt(t,n)||(s=s.remove(e))})),s)))}}class ui{constructor(e,t,n,s){this.targetId=e,this.fromCache=t,this.vs=n,this.Vs=s}static Ss(e,t){let n=ln(),s=ln();for(const r of t.docChanges)switch(r.type){case 0:n=n.add(r.doc.key);break;case 1:s=s.add(r.doc.key)}return new ui(e,t.fromCache,n,s)}}class hi{Ds(e){this.Cs=e}As(e,t,n,s){return function(e){return 0===e.filters.length&&null===e.limit&&null==e.startAt&&null==e.endAt&&(0===e.explicitOrderBy.length||1===e.explicitOrderBy.length&&e.explicitOrderBy[0].field.isKeyField())}(t)||n.isEqual(B.min())?this.Ns(e,t):this.Cs.Es(e,s).next((r=>{const o=this.xs(t,r);return(tt(t)||nt(t))&&this.ks(t.limitType,o,s,n)?this.Ns(e,t):(f()<=i.in.DEBUG&&g("QueryEngine","Re-using previous result from %s to execute query: %s",n.toString(),lt(t)),this.Cs.As(e,t,n).next((e=>(o.forEach((t=>{e=e.insert(t.key,t)})),e))))}))}xs(e,t){let n=new tn(ft(e));return t.forEach(((t,s)=>{dt(e,s)&&(n=n.add(s))})),n}ks(e,t,n,s){if(n.size!==t.size)return!0;const r="F"===e?t.last():t.first();return!!r&&(r.hasPendingWrites||r.version.compareTo(s)>0)}Ns(e,t){return f()<=i.in.DEBUG&&g("QueryEngine","Using full collection scan to execute query:",lt(t)),this.Cs.As(e,t,B.min())}}class li{constructor(e,t,n,s){this.persistence=e,this.Os=t,this.O=s,this.Ms=new Xt(V),this.$s=new zr((e=>Me(e)),Pe),this.Fs=B.min(),this.Bs=e.getRemoteDocumentCache(),this.Un=e.getTargetCache(),this.Kn=e.getBundleCache(),this.Ls(n)}Ls(e){this.indexManager=this.persistence.getIndexManager(e),this.gs=this.persistence.getMutationQueue(e,this.indexManager),this.Us=new ci(this.Bs,this.gs,this.indexManager),this.Bs.setIndexManager(this.indexManager),this.Os.Ds(this.Us)}collectGarbage(e){return this.persistence.runTransaction("Collect garbage","readwrite-primary",(t=>e.collect(t,this.Ms)))}}function di(e,t,n,s){return new li(e,t,n,s)}async function fi(e,t){const n=E(e);return await n.persistence.runTransaction("Handle user change","readonly",(e=>{let s;return n.gs.getAllMutationBatches(e).next((r=>(s=r,n.Ls(t),n.gs.getAllMutationBatches(e)))).next((t=>{const r=[],i=[];let o=ln();for(const e of s){r.push(e.batchId);for(const t of e.mutations)o=o.add(t.key)}for(const e of t){i.push(e.batchId);for(const t of e.mutations)o=o.add(t.key)}return n.Us.Es(e,o).next((e=>({qs:e,removedBatchIds:r,addedBatchIds:i})))}))}))}function mi(e){const t=E(e);return t.persistence.runTransaction("Get last remote snapshot version","readonly",(e=>t.Un.getLastRemoteSnapshotVersion(e)))}function gi(e,t,n){let s=ln();return n.forEach((e=>s=s.add(e))),t.getEntries(e,s).next((e=>{let s=on();return n.forEach(((n,r)=>{const i=e.get(n);r.isNoDocument()&&r.version.isEqual(B.min())?(t.removeEntry(n,r.readTime),s=s.insert(n,r)):!i.isValidDocument()||r.version.compareTo(i.version)>0||0===r.version.compareTo(i.version)&&i.hasPendingWrites?(t.addEntry(r),s=s.insert(n,r)):g("LocalStore","Ignoring outdated watch update for ",n,". Current version:",i.version," Watch version:",r.version)})),s}))}function pi(e,t){const n=E(e);return n.persistence.runTransaction("Get next mutation batch","readonly",(e=>(void 0===t&&(t=-1),n.gs.getNextMutationBatchAfterBatchId(e,t))))}function yi(e,t){const n=E(e);return n.persistence.runTransaction("Allocate target","readwrite",(e=>{let s;return n.Un.getTargetData(e,t).next((r=>r?(s=r,As.resolve(s)):n.Un.allocateTargetId(e).next((r=>(s=new $s(t,r,0,e.currentSequenceNumber),n.Un.addTargetData(e,s).next((()=>s)))))))})).then((e=>{const s=n.Ms.get(e.targetId);return(null===s||e.snapshotVersion.compareTo(s.snapshotVersion)>0)&&(n.Ms=n.Ms.insert(e.targetId,e),n.$s.set(t,e.targetId)),e}))}async function wi(e,t,n){const s=E(e),r=s.Ms.get(t),i=n?"readwrite":"readwrite-primary";try{n||await s.persistence.runTransaction("Release target",i,(e=>s.persistence.referenceDelegate.removeTarget(e,r)))}catch(e){if(!Ls(e))throw e;g("LocalStore",`Failed to update sequence numbers for target ${t}: ${e}`)}s.Ms=s.Ms.remove(t),s.$s.delete(r.target)}function vi(e,t,n){const s=E(e);let r=B.min(),i=ln();return s.persistence.runTransaction("Execute query","readonly",(e=>function(e,t,n){const s=E(e),r=s.$s.get(n);return void 0!==r?As.resolve(s.Ms.get(r)):s.Un.getTargetData(t,n)}(s,e,at(t)).next((t=>{if(t)return r=t.lastLimboFreeSnapshotVersion,s.Un.getMatchingKeysForTargetId(e,t.targetId).next((e=>{i=e}))})).next((()=>s.Os.As(e,t,n?r:B.min(),n?i:ln()))).next((e=>({documents:e,Ks:i})))))}function Ii(e,t){const n=E(e),s=E(n.Un),r=n.Ms.get(t);return r?Promise.resolve(r.target):n.persistence.runTransaction("Get target data","readonly",(e=>s.Tt(e,t).next((e=>e?e.target:null))))}function Ti(e){const t=E(e);return t.persistence.runTransaction("Get new document changes","readonly",(e=>function(e,t,n){const s=E(e);let r=on(),i=Ws(n);const o=Xr(t),a=IDBKeyRange.lowerBound(i,!0);return o.Qt({index:ls.readTimeIndex,range:a},((e,t)=>{const n=Qs(s.O,t);r=r.insert(n.key,n),i=t.readTime})).next((()=>({ws:r,readTime:Hs(i)})))}(t.Bs,e,t.Fs))).then((({ws:e,readTime:n})=>(t.Fs=n,e)))}async function Ei(e,t,n=ln()){const s=await yi(e,at(tr(t.bundledQuery))),r=E(e);return r.persistence.runTransaction("Save named query","readwrite",(e=>{const i=An(t.readTime);if(s.snapshotVersion.compareTo(i)>=0)return r.Kn.saveNamedQuery(e,t);const o=s.withResumeToken(J.EMPTY_BYTE_STRING,i);return r.Ms=r.Ms.insert(o.targetId,o),r.Un.updateTargetData(e,o).next((()=>r.Un.removeMatchingKeysForTargetId(e,s.targetId))).next((()=>r.Un.addMatchingKeys(e,n,s.targetId))).next((()=>r.Kn.saveNamedQuery(e,t)))}))}class bi{constructor(e){this.O=e,this.Ws=new Map,this.zs=new Map}getBundleMetadata(e,t){return As.resolve(this.Ws.get(t))}saveBundleMetadata(e,t){var n;return this.Ws.set(t.id,{id:(n=t).id,version:n.version,createTime:An(n.createTime)}),As.resolve()}getNamedQuery(e,t){return As.resolve(this.zs.get(t))}saveNamedQuery(e,t){return this.zs.set(t.name,function(e){return{name:e.name,query:tr(e.bundledQuery),readTime:An(e.readTime)}}(t)),As.resolve()}}class Si{constructor(){this.overlays=new Xt(he.comparator),this.Hs=new Map}getOverlay(e,t){return As.resolve(this.overlays.get(t))}saveOverlays(e,t,n){return n.forEach((n=>{this.Yt(e,t,n)})),As.resolve()}removeOverlaysForBatchId(e,t,n){const s=this.Hs.get(n);return void 0!==s&&(s.forEach((e=>this.overlays=this.overlays.remove(e))),this.Hs.delete(n)),As.resolve()}getOverlaysForCollection(e,t,n){const s=new Map,r=t.length+1,i=new he(t.child("")),o=this.overlays.getIteratorFrom(i);for(;o.hasNext();){const e=o.getNext().value,i=e.getKey();if(!t.isPrefixOf(i.path))break;i.path.length===r&&e.largestBatchId>n&&s.set(e.getKey(),e)}return As.resolve(s)}getOverlaysForCollectionGroup(e,t,n,s){let r=new Xt(((e,t)=>e-t));const i=this.overlays.getIterator();for(;i.hasNext();){const e=i.getNext().value;if(e.getKey().getCollectionGroup()===t&&e.largestBatchId>n){let t=r.get(e.largestBatchId);null===t&&(t=new Map,r=r.insert(e.largestBatchId,t)),t.set(e.getKey(),e)}}const o=new Map,a=r.getIterator();for(;a.hasNext()&&(a.getNext().value.forEach(((e,t)=>o.set(t,e))),!(o.size>=s)););return As.resolve(o)}Yt(e,t,n){if(null===n)return;const s=this.overlays.get(n.key);null!==s&&this.Hs.get(s.largestBatchId).delete(n.key),this.overlays=this.overlays.insert(n.key,new Gs(t,n));let r=this.Hs.get(t);void 0===r&&(r=new Set,this.Hs.set(t,r)),r.add(n.key)}}class xi{constructor(){this.Js=new tn(Ni.Ys),this.Xs=new tn(Ni.Zs)}isEmpty(){return this.Js.isEmpty()}addReference(e,t){const n=new Ni(e,t);this.Js=this.Js.add(n),this.Xs=this.Xs.add(n)}ti(e,t){e.forEach((e=>this.addReference(e,t)))}removeReference(e,t){this.ei(new Ni(e,t))}ni(e,t){e.forEach((e=>this.removeReference(e,t)))}si(e){const t=new he(new Q([])),n=new Ni(t,e),s=new Ni(t,e+1),r=[];return this.Xs.forEachInRange([n,s],(e=>{this.ei(e),r.push(e.key)})),r}ii(){this.Js.forEach((e=>this.ei(e)))}ei(e){this.Js=this.Js.delete(e),this.Xs=this.Xs.delete(e)}ri(e){const t=new he(new Q([])),n=new Ni(t,e),s=new Ni(t,e+1);let r=ln();return this.Xs.forEachInRange([n,s],(e=>{r=r.add(e.key)})),r}containsKey(e){const t=new Ni(e,0),n=this.Js.firstAfterOrEqual(t);return null!==n&&e.isEqual(n.key)}}class Ni{constructor(e,t){this.key=e,this.oi=t}static Ys(e,t){return he.comparator(e.key,t.key)||V(e.oi,t.oi)}static Zs(e,t){return V(e.oi,t.oi)||he.comparator(e.key,t.key)}}class _i{constructor(e,t){this.indexManager=e,this.referenceDelegate=t,this.gs=[],this.ci=1,this.ui=new tn(Ni.Ys)}checkEmpty(e){return As.resolve(0===this.gs.length)}addMutationBatch(e,t,n,s){const r=this.ci;this.ci++,this.gs.length>0&&this.gs[this.gs.length-1];const i=new Bs(r,t,n,s);this.gs.push(i);for(const o of s)this.ui=this.ui.add(new Ni(o.key,r)),this.indexManager.addToCollectionParentIndex(e,o.key.path.popLast());return As.resolve(i)}lookupMutationBatch(e,t){return As.resolve(this.ai(t))}getNextMutationBatchAfterBatchId(e,t){const n=t+1,s=this.hi(n),r=s<0?0:s;return As.resolve(this.gs.length>r?this.gs[r]:null)}getHighestUnacknowledgedBatchId(){return As.resolve(0===this.gs.length?-1:this.ci-1)}getAllMutationBatches(e){return As.resolve(this.gs.slice())}getAllMutationBatchesAffectingDocumentKey(e,t){const n=new Ni(t,0),s=new Ni(t,Number.POSITIVE_INFINITY),r=[];return this.ui.forEachInRange([n,s],(e=>{const t=this.ai(e.oi);r.push(t)})),As.resolve(r)}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new tn(V);return t.forEach((e=>{const t=new Ni(e,0),s=new Ni(e,Number.POSITIVE_INFINITY);this.ui.forEachInRange([t,s],(e=>{n=n.add(e.oi)}))})),As.resolve(this.li(n))}getAllMutationBatchesAffectingQuery(e,t){const n=t.path,s=n.length+1;let r=n;he.isDocumentKey(r)||(r=r.child(""));const i=new Ni(new he(r),0);let o=new tn(V);return this.ui.forEachWhile((e=>{const t=e.key.path;return!!n.isPrefixOf(t)&&(t.length===s&&(o=o.add(e.oi)),!0)}),i),As.resolve(this.li(o))}li(e){const t=[];return e.forEach((e=>{const n=this.ai(e);null!==n&&t.push(n)})),t}removeMutationBatch(e,t){I(0===this.fi(t.batchId,"removed")),this.gs.shift();let n=this.ui;return As.forEach(t.mutations,(s=>{const r=new Ni(s.key,t.batchId);return n=n.delete(r),this.referenceDelegate.markPotentiallyOrphaned(e,s.key)})).next((()=>{this.ui=n}))}Qe(e){}containsKey(e,t){const n=new Ni(t,0),s=this.ui.firstAfterOrEqual(n);return As.resolve(t.isEqual(s&&s.key))}performConsistencyCheck(e){return this.gs.length,As.resolve()}fi(e,t){return this.hi(e)}hi(e){return 0===this.gs.length?0:e-this.gs[0].batchId}ai(e){const t=this.hi(e);return t<0||t>=this.gs.length?null:this.gs[t]}}class ki{constructor(e){this.di=e,this.docs=new Xt(he.comparator),this.size=0}setIndexManager(e){this.indexManager=e}addEntry(e,t){const n=t.key,s=this.docs.get(n),r=s?s.size:0,i=this.di(t);return this.docs=this.docs.insert(n,{document:t.mutableCopy(),size:i}),this.size+=i-r,this.indexManager.addToCollectionParentIndex(e,n.path.popLast())}removeEntry(e){const t=this.docs.get(e);t&&(this.docs=this.docs.remove(e),this.size-=t.size)}getEntry(e,t){const n=this.docs.get(t);return As.resolve(n?n.document.mutableCopy():ke.newInvalidDocument(t))}getEntries(e,t){let n=on();return t.forEach((e=>{const t=this.docs.get(e);n=n.insert(e,t?t.document.mutableCopy():ke.newInvalidDocument(e))})),As.resolve(n)}getAll(e,t,n){let s=on();const r=new he(t.child("")),i=this.docs.getIteratorFrom(r);for(;i.hasNext();){const{key:e,value:{document:r}}=i.getNext();if(!t.isPrefixOf(e.path))break;e.path.length>t.length+1||r.readTime.compareTo(n)<=0||(s=s.insert(r.key,r.mutableCopy()))}return As.resolve(s)}_i(e,t){return As.forEach(this.docs,(e=>t(e)))}newChangeBuffer(e){return new Ai(this)}getSize(e){return As.resolve(this.size)}}class Ai extends Wr{constructor(e){super(),this.Tn=e}applyChanges(e){const t=[];return this.changes.forEach(((n,s)=>{s.isValidDocument()?t.push(this.Tn.addEntry(e,s)):this.Tn.removeEntry(n)})),As.waitFor(t)}getFromCache(e,t){return this.Tn.getEntry(e,t)}getAllFromCache(e,t){return this.Tn.getEntries(e,t)}}class Di{constructor(e){this.persistence=e,this.wi=new zr((e=>Me(e)),Pe),this.lastRemoteSnapshotVersion=B.min(),this.highestTargetId=0,this.mi=0,this.gi=new xi,this.targetCount=0,this.yi=Mr.He()}forEachTarget(e,t){return this.wi.forEach(((e,n)=>t(n))),As.resolve()}getLastRemoteSnapshotVersion(e){return As.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(e){return As.resolve(this.mi)}allocateTargetId(e){return this.highestTargetId=this.yi.next(),As.resolve(this.highestTargetId)}setTargetsMetadata(e,t,n){return n&&(this.lastRemoteSnapshotVersion=n),t>this.mi&&(this.mi=t),As.resolve()}Ze(e){this.wi.set(e.target,e);const t=e.targetId;t>this.highestTargetId&&(this.yi=new Mr(t),this.highestTargetId=t),e.sequenceNumber>this.mi&&(this.mi=e.sequenceNumber)}addTargetData(e,t){return this.Ze(t),this.targetCount+=1,As.resolve()}updateTargetData(e,t){return this.Ze(t),As.resolve()}removeTargetData(e,t){return this.wi.delete(t.target),this.gi.si(t.targetId),this.targetCount-=1,As.resolve()}removeTargets(e,t,n){let s=0;const r=[];return this.wi.forEach(((i,o)=>{o.sequenceNumber<=t&&null===n.get(o.targetId)&&(this.wi.delete(i),r.push(this.removeMatchingKeysForTargetId(e,o.targetId)),s++)})),As.waitFor(r).next((()=>s))}getTargetCount(e){return As.resolve(this.targetCount)}getTargetData(e,t){const n=this.wi.get(t)||null;return As.resolve(n)}addMatchingKeys(e,t,n){return this.gi.ti(t,n),As.resolve()}removeMatchingKeys(e,t,n){this.gi.ni(t,n);const s=this.persistence.referenceDelegate,r=[];return s&&t.forEach((t=>{r.push(s.markPotentiallyOrphaned(e,t))})),As.waitFor(r)}removeMatchingKeysForTargetId(e,t){return this.gi.si(t),As.resolve()}getMatchingKeysForTargetId(e,t){const n=this.gi.ri(t);return As.resolve(n)}containsKey(e,t){return As.resolve(this.gi.containsKey(t))}}class Ci{constructor(e,t){this.pi={},this.overlays={},this.Nn=new L(0),this.xn=!1,this.xn=!0,this.referenceDelegate=e(this),this.Un=new Di(this),this.indexManager=new vr,this.qn=function(e){return new ki(e)}((e=>this.referenceDelegate.Ii(e))),this.O=new js(t),this.Kn=new bi(this.O)}start(){return Promise.resolve()}shutdown(){return this.xn=!1,Promise.resolve()}get started(){return this.xn}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(e){return this.indexManager}getDocumentOverlayCache(e){let t=this.overlays[e.toKey()];return t||(t=new Si,this.overlays[e.toKey()]=t),t}getMutationQueue(e,t){let n=this.pi[e.toKey()];return n||(n=new _i(t,this.referenceDelegate),this.pi[e.toKey()]=n),n}getTargetCache(){return this.Un}getRemoteDocumentCache(){return this.qn}getBundleCache(){return this.Kn}runTransaction(e,t,n){g("MemoryPersistence","Starting transaction:",e);const s=new Oi(this.Nn.next());return this.referenceDelegate.Ei(),n(s).next((e=>this.referenceDelegate.Ti(s).next((()=>e)))).toPromise().then((e=>(s.raiseOnCommittedEvent(),e)))}Ai(e,t){return As.or(Object.values(this.pi).map((n=>()=>n.containsKey(e,t))))}}class Oi extends ks{constructor(e){super(),this.currentSequenceNumber=e}}class Ri{constructor(e){this.persistence=e,this.Ri=new xi,this.Pi=null}static bi(e){return new Ri(e)}get vi(){if(this.Pi)return this.Pi;throw v()}addReference(e,t,n){return this.Ri.addReference(n,t),this.vi.delete(n.toString()),As.resolve()}removeReference(e,t,n){return this.Ri.removeReference(n,t),this.vi.add(n.toString()),As.resolve()}markPotentiallyOrphaned(e,t){return this.vi.add(t.toString()),As.resolve()}removeTarget(e,t){this.Ri.si(t.targetId).forEach((e=>this.vi.add(e.toString())));const n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(e,t.targetId).next((e=>{e.forEach((e=>this.vi.add(e.toString())))})).next((()=>n.removeTargetData(e,t)))}Ei(){this.Pi=new Set}Ti(e){const t=this.persistence.getRemoteDocumentCache().newChangeBuffer();return As.forEach(this.vi,(n=>{const s=he.fromPath(n);return this.Vi(e,s).next((e=>{e||t.removeEntry(s,B.min())}))})).next((()=>(this.Pi=null,t.apply(e))))}updateLimboDocument(e,t){return this.Vi(e,t).next((e=>{e?this.vi.delete(t.toString()):this.vi.add(t.toString())}))}Ii(e){return 0}Vi(e,t){return As.or([()=>As.resolve(this.Ri.containsKey(t)),()=>this.persistence.getTargetCache().containsKey(e,t),()=>this.persistence.Ai(e,t)])}}function Li(e,t){return`firestore_clients_${e}_${t}`}function Mi(e,t,n){let s=`firestore_mutations_${e}_${n}`;return t.isAuthenticated()&&(s+=`_${t.uid}`),s}function Pi(e,t){return`firestore_targets_${e}_${t}`}class Vi{constructor(e,t,n,s){this.user=e,this.batchId=t,this.state=n,this.error=s}static Si(e,t,n){const s=JSON.parse(n);let r,i="object"==typeof s&&-1!==["pending","acknowledged","rejected"].indexOf(s.state)&&(void 0===s.error||"object"==typeof s.error);return i&&s.error&&(i="string"==typeof s.error.message&&"string"==typeof s.error.code,i&&(r=new S(s.error.code,s.error.message))),i?new Vi(e,t,s.state,r):(p("SharedClientState",`Failed to parse mutation state for ID '${t}': ${n}`),null)}Di(){const e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class Fi{constructor(e,t,n){this.targetId=e,this.state=t,this.error=n}static Si(e,t){const n=JSON.parse(t);let s,r="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error);return r&&n.error&&(r="string"==typeof n.error.message&&"string"==typeof n.error.code,r&&(s=new S(n.error.code,n.error.message))),r?new Fi(e,n.state,s):(p("SharedClientState",`Failed to parse target state for ID '${e}': ${t}`),null)}Di(){const e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class qi{constructor(e,t){this.clientId=e,this.activeTargetIds=t}static Si(e,t){const n=JSON.parse(t);let s="object"==typeof n&&n.activeTargetIds instanceof Array,r=fn();for(let i=0;s&&i<n.activeTargetIds.length;++i)s=ue(n.activeTargetIds[i]),r=r.add(n.activeTargetIds[i]);return s?new qi(e,r):(p("SharedClientState",`Failed to parse client data for instance '${e}': ${t}`),null)}}class Ui{constructor(e,t){this.clientId=e,this.onlineState=t}static Si(e){const t=JSON.parse(e);return"object"==typeof t&&-1!==["Unknown","Online","Offline"].indexOf(t.onlineState)&&"string"==typeof t.clientId?new Ui(t.clientId,t.onlineState):(p("SharedClientState",`Failed to parse online state: ${e}`),null)}}class Bi{constructor(){this.activeTargetIds=fn()}Ci(e){this.activeTargetIds=this.activeTargetIds.add(e)}Ni(e){this.activeTargetIds=this.activeTargetIds.delete(e)}Di(){const e={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(e)}}class Ki{constructor(e,t,n,s,r){this.window=e,this.Sn=t,this.persistenceKey=n,this.xi=s,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.ki=this.Oi.bind(this),this.Mi=new Xt(V),this.started=!1,this.$i=[];const i=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=r,this.Fi=Li(this.persistenceKey,this.xi),this.Bi=function(e){return`firestore_sequence_number_${e}`}(this.persistenceKey),this.Mi=this.Mi.insert(this.xi,new Bi),this.Li=new RegExp(`^firestore_clients_${i}_([^_]*)$`),this.Ui=new RegExp(`^firestore_mutations_${i}_(\\d+)(?:_(.*))?$`),this.qi=new RegExp(`^firestore_targets_${i}_(\\d+)$`),this.Ki=function(e){return`firestore_online_state_${e}`}(this.persistenceKey),this.Gi=function(e){return`firestore_bundle_loaded_${e}`}(this.persistenceKey),this.window.addEventListener("storage",this.ki)}static Vt(e){return!(!e||!e.localStorage)}async start(){const e=await this.syncEngine.ds();for(const n of e){if(n===this.xi)continue;const e=this.getItem(Li(this.persistenceKey,n));if(e){const t=qi.Si(n,e);t&&(this.Mi=this.Mi.insert(t.clientId,t))}}this.ji();const t=this.storage.getItem(this.Ki);if(t){const e=this.Qi(t);e&&this.Wi(e)}for(const n of this.$i)this.Oi(n);this.$i=[],this.window.addEventListener("pagehide",(()=>this.shutdown())),this.started=!0}writeSequenceNumber(e){this.setItem(this.Bi,JSON.stringify(e))}getAllActiveQueryTargets(){return this.zi(this.Mi)}isActiveQueryTarget(e){let t=!1;return this.Mi.forEach(((n,s)=>{s.activeTargetIds.has(e)&&(t=!0)})),t}addPendingMutation(e){this.Hi(e,"pending")}updateMutationState(e,t,n){this.Hi(e,t,n),this.Ji(e)}addLocalQueryTarget(e){let t="not-current";if(this.isActiveQueryTarget(e)){const n=this.storage.getItem(Pi(this.persistenceKey,e));if(n){const s=Fi.Si(e,n);s&&(t=s.state)}}return this.Yi.Ci(e),this.ji(),t}removeLocalQueryTarget(e){this.Yi.Ni(e),this.ji()}isLocalQueryTarget(e){return this.Yi.activeTargetIds.has(e)}clearQueryState(e){this.removeItem(Pi(this.persistenceKey,e))}updateQueryState(e,t,n){this.Xi(e,t,n)}handleUserChange(e,t,n){t.forEach((e=>{this.Ji(e)})),this.currentUser=e,n.forEach((e=>{this.addPendingMutation(e)}))}setOnlineState(e){this.Zi(e)}notifyBundleLoaded(){this.tr()}shutdown(){this.started&&(this.window.removeEventListener("storage",this.ki),this.removeItem(this.Fi),this.started=!1)}getItem(e){const t=this.storage.getItem(e);return g("SharedClientState","READ",e,t),t}setItem(e,t){g("SharedClientState","SET",e,t),this.storage.setItem(e,t)}removeItem(e){g("SharedClientState","REMOVE",e),this.storage.removeItem(e)}Oi(e){const t=e;if(t.storageArea===this.storage){if(g("SharedClientState","EVENT",t.key,t.newValue),t.key===this.Fi)return void p("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.Sn.enqueueRetryable((async()=>{if(this.started){if(null!==t.key)if(this.Li.test(t.key)){if(null==t.newValue){const e=this.er(t.key);return this.nr(e,null)}{const e=this.sr(t.key,t.newValue);if(e)return this.nr(e.clientId,e)}}else if(this.Ui.test(t.key)){if(null!==t.newValue){const e=this.ir(t.key,t.newValue);if(e)return this.rr(e)}}else if(this.qi.test(t.key)){if(null!==t.newValue){const e=this.cr(t.key,t.newValue);if(e)return this.ur(e)}}else if(t.key===this.Ki){if(null!==t.newValue){const e=this.Qi(t.newValue);if(e)return this.Wi(e)}}else if(t.key===this.Bi){const e=function(e){let t=L.A;if(null!=e)try{const n=JSON.parse(e);I("number"==typeof n),t=n}catch(e){p("SharedClientState","Failed to read sequence number from WebStorage",e)}return t}(t.newValue);e!==L.A&&this.sequenceNumberHandler(e)}else if(t.key===this.Gi)return this.syncEngine.ar()}else this.$i.push(t)}))}}get Yi(){return this.Mi.get(this.xi)}ji(){this.setItem(this.Fi,this.Yi.Di())}Hi(e,t,n){const s=new Vi(this.currentUser,e,t,n),r=Mi(this.persistenceKey,this.currentUser,e);this.setItem(r,s.Di())}Ji(e){const t=Mi(this.persistenceKey,this.currentUser,e);this.removeItem(t)}Zi(e){const t={clientId:this.xi,onlineState:e};this.storage.setItem(this.Ki,JSON.stringify(t))}Xi(e,t,n){const s=Pi(this.persistenceKey,e),r=new Fi(e,t,n);this.setItem(s,r.Di())}tr(){this.setItem(this.Gi,"value-not-used")}er(e){const t=this.Li.exec(e);return t?t[1]:null}sr(e,t){const n=this.er(e);return qi.Si(n,t)}ir(e,t){const n=this.Ui.exec(e),s=Number(n[1]),r=void 0!==n[2]?n[2]:null;return Vi.Si(new h(r),s,t)}cr(e,t){const n=this.qi.exec(e),s=Number(n[1]);return Fi.Si(s,t)}Qi(e){return Ui.Si(e)}async rr(e){if(e.user.uid===this.currentUser.uid)return this.syncEngine.hr(e.batchId,e.state,e.error);g("SharedClientState",`Ignoring mutation for non-active user ${e.user.uid}`)}ur(e){return this.syncEngine.lr(e.targetId,e.state,e.error)}nr(e,t){const n=t?this.Mi.insert(e,t):this.Mi.remove(e),s=this.zi(this.Mi),r=this.zi(n),i=[],o=[];return r.forEach((e=>{s.has(e)||i.push(e)})),s.forEach((e=>{r.has(e)||o.push(e)})),this.syncEngine.dr(i,o).then((()=>{this.Mi=n}))}Wi(e){this.Mi.get(e.clientId)&&this.onlineStateHandler(e.onlineState)}zi(e){let t=fn();return e.forEach(((e,n)=>{t=t.unionWith(n.activeTargetIds)})),t}}class Gi{constructor(){this._r=new Bi,this.wr={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(e){}updateMutationState(e,t,n){}addLocalQueryTarget(e){return this._r.Ci(e),this.wr[e]||"not-current"}updateQueryState(e,t,n){this.wr[e]=t}removeLocalQueryTarget(e){this._r.Ni(e)}isLocalQueryTarget(e){return this._r.activeTargetIds.has(e)}clearQueryState(e){delete this.wr[e]}getAllActiveQueryTargets(){return this._r.activeTargetIds}isActiveQueryTarget(e){return this._r.activeTargetIds.has(e)}start(){return this._r=new Bi,Promise.resolve()}handleUserChange(e,t,n){}setOnlineState(e){}shutdown(){}writeSequenceNumber(e){}notifyBundleLoaded(){}}class $i{mr(e){}shutdown(){}}class ji{constructor(){this.gr=()=>this.yr(),this.pr=()=>this.Ir(),this.Er=[],this.Tr()}mr(e){this.Er.push(e)}shutdown(){window.removeEventListener("online",this.gr),window.removeEventListener("offline",this.pr)}Tr(){window.addEventListener("online",this.gr),window.addEventListener("offline",this.pr)}yr(){g("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(const e of this.Er)e(0)}Ir(){g("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(const e of this.Er)e(1)}static Vt(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}const Qi={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery"};class zi{constructor(e){this.Ar=e.Ar,this.Rr=e.Rr}Pr(e){this.br=e}vr(e){this.Vr=e}onMessage(e){this.Sr=e}close(){this.Rr()}send(e){this.Ar(e)}Dr(){this.br()}Cr(e){this.Vr(e)}Nr(e){this.Sr(e)}}class Wi extends class{constructor(e){this.databaseInfo=e,this.databaseId=e.databaseId;const t=e.ssl?"https":"http";this.kr=t+"://"+e.host,this.Or="projects/"+this.databaseId.projectId+"/databases/"+this.databaseId.database+"/documents"}Mr(e,t,n,s,r){const i=this.$r(e,t);g("RestConnection","Sending: ",i,n);const o={};return this.Fr(o,s,r),this.Br(e,i,o,n).then((e=>(g("RestConnection","Received: ",e),e)),(t=>{throw y("RestConnection",`${e} failed with error: `,t,"url: ",i,"request:",n),t}))}Lr(e,t,n,s,r){return this.Mr(e,t,n,s,r)}Fr(e,t,n){e["X-Goog-Api-Client"]="gl-js/ fire/"+l,e["Content-Type"]="text/plain",this.databaseInfo.appId&&(e["X-Firebase-GMPID"]=this.databaseInfo.appId),t&&t.headers.forEach(((t,n)=>e[n]=t)),n&&n.headers.forEach(((t,n)=>e[n]=t))}$r(e,t){const n=Qi[e];return`${this.kr}/v1/${t}:${n}`}}{constructor(e){super(e),this.forceLongPolling=e.forceLongPolling,this.autoDetectLongPolling=e.autoDetectLongPolling,this.useFetchStreams=e.useFetchStreams}Br(e,t,n,s){return new Promise(((r,i)=>{const o=new a.JJ;o.listenOnce(a.tw.COMPLETE,(()=>{try{switch(o.getLastErrorCode()){case a.jK.NO_ERROR:const t=o.getResponseJson();g("Connection","XHR received:",JSON.stringify(t)),r(t);break;case a.jK.TIMEOUT:g("Connection",'RPC "'+e+'" timed out'),i(new S(b.DEADLINE_EXCEEDED,"Request time out"));break;case a.jK.HTTP_ERROR:const n=o.getStatus();if(g("Connection",'RPC "'+e+'" failed with status:',n,"response text:",o.getResponseText()),n>0){const e=o.getResponseJson().error;if(e&&e.status&&e.message){const t=function(e){const t=e.toLowerCase().replace(/_/g,"-");return Object.values(b).indexOf(t)>=0?t:b.UNKNOWN}(e.status);i(new S(t,e.message))}else i(new S(b.UNKNOWN,"Server responded with status "+o.getStatus()))}else i(new S(b.UNAVAILABLE,"Connection failed."));break;default:v()}}finally{g("Connection",'RPC "'+e+'" completed.')}}));const c=JSON.stringify(s);o.send(t,"POST",c,n,15)}))}Ur(e,t,n){const s=[this.kr,"/","google.firestore.v1.Firestore","/",e,"/channel"],r=(0,a.UE)(),i=(0,a.FJ)(),c={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling};this.useFetchStreams&&(c.xmlHttpFactory=new a.zI({})),this.Fr(c.initMessageHeaders,t,n),(0,o.uI)()||(0,o.b$)()||(0,o.d)()||(0,o.w1)()||(0,o.Mn)()||(0,o.ru)()||(c.httpHeadersOverwriteParam="$httpHeaders");const u=s.join("");g("Connection","Creating WebChannel: "+u,c);const h=r.createWebChannel(u,c);let l=!1,d=!1;const f=new zi({Ar:e=>{d?g("Connection","Not sending because WebChannel is closed:",e):(l||(g("Connection","Opening WebChannel transport."),h.open(),l=!0),g("Connection","WebChannel sending:",e),h.send(e))},Rr:()=>h.close()}),m=(e,t,n)=>{e.listen(t,(e=>{try{n(e)}catch(e){setTimeout((()=>{throw e}),0)}}))};return m(h,a.ii.EventType.OPEN,(()=>{d||g("Connection","WebChannel transport opened.")})),m(h,a.ii.EventType.CLOSE,(()=>{d||(d=!0,g("Connection","WebChannel transport closed"),f.Cr())})),m(h,a.ii.EventType.ERROR,(e=>{d||(d=!0,y("Connection","WebChannel transport errored:",e),f.Cr(new S(b.UNAVAILABLE,"The operation could not be completed")))})),m(h,a.ii.EventType.MESSAGE,(e=>{var t;if(!d){const n=e.data[0];I(!!n);const s=n,r=s.error||(null===(t=s[0])||void 0===t?void 0:t.error);if(r){g("Connection","WebChannel received error:",r);const e=r.status;let t=function(e){const t=Wt[e];if(void 0!==t)return Jt(t)}(e),n=r.message;void 0===t&&(t=b.INTERNAL,n="Unknown error status: "+e+" with message "+r.message),d=!0,f.Cr(new S(t,n)),h.close()}else g("Connection","WebChannel received:",n),f.Nr(n)}})),m(i,a.ju.STAT_EVENT,(e=>{e.stat===a.kN.PROXY?g("Connection","Detected buffering proxy"):e.stat===a.kN.NOPROXY&&g("Connection","Detected no buffering proxy")})),setTimeout((()=>{f.Dr()}),0),f}}function Hi(){return"undefined"!=typeof window?window:null}function Yi(){return"undefined"!=typeof document?document:null}function Ji(e){return new xn(e,!0)}class Xi{constructor(e,t,n=1e3,s=1.5,r=6e4){this.Sn=e,this.timerId=t,this.qr=n,this.Kr=s,this.Gr=r,this.jr=0,this.Qr=null,this.Wr=Date.now(),this.reset()}reset(){this.jr=0}zr(){this.jr=this.Gr}Hr(e){this.cancel();const t=Math.floor(this.jr+this.Jr()),n=Math.max(0,Date.now()-this.Wr),s=Math.max(0,t-n);s>0&&g("ExponentialBackoff",`Backing off for ${s} ms (base delay: ${this.jr} ms, delay with jitter: ${t} ms, last attempt: ${n} ms ago)`),this.Qr=this.Sn.enqueueAfterDelay(this.timerId,s,(()=>(this.Wr=Date.now(),e()))),this.jr*=this.Kr,this.jr<this.qr&&(this.jr=this.qr),this.jr>this.Gr&&(this.jr=this.Gr)}Yr(){null!==this.Qr&&(this.Qr.skipDelay(),this.Qr=null)}cancel(){null!==this.Qr&&(this.Qr.cancel(),this.Qr=null)}Jr(){return(Math.random()-.5)*this.jr}}class Zi{constructor(e,t,n,s,r,i,o,a){this.Sn=e,this.Xr=n,this.Zr=s,this.eo=r,this.authCredentialsProvider=i,this.appCheckCredentialsProvider=o,this.listener=a,this.state=0,this.no=0,this.so=null,this.io=null,this.stream=null,this.ro=new Xi(e,t)}oo(){return 1===this.state||5===this.state||this.co()}co(){return 2===this.state||3===this.state}start(){4!==this.state?this.auth():this.uo()}async stop(){this.oo()&&await this.close(0)}ao(){this.state=0,this.ro.reset()}ho(){this.co()&&null===this.so&&(this.so=this.Sn.enqueueAfterDelay(this.Xr,6e4,(()=>this.lo())))}fo(e){this._o(),this.stream.send(e)}async lo(){if(this.co())return this.close(0)}_o(){this.so&&(this.so.cancel(),this.so=null)}wo(){this.io&&(this.io.cancel(),this.io=null)}async close(e,t){this._o(),this.wo(),this.ro.cancel(),this.no++,4!==e?this.ro.reset():t&&t.code===b.RESOURCE_EXHAUSTED?(p(t.toString()),p("Using maximum backoff delay to prevent overloading the backend."),this.ro.zr()):t&&t.code===b.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.mo(),this.stream.close(),this.stream=null),this.state=e,await this.listener.vr(t)}mo(){}auth(){this.state=1;const e=this.yo(this.no),t=this.no;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then((([e,n])=>{this.no===t&&this.po(e,n)}),(t=>{e((()=>{const e=new S(b.UNKNOWN,"Fetching auth token failed: "+t.message);return this.Io(e)}))}))}po(e,t){const n=this.yo(this.no);this.stream=this.Eo(e,t),this.stream.Pr((()=>{n((()=>(this.state=2,this.io=this.Sn.enqueueAfterDelay(this.Zr,1e4,(()=>(this.co()&&(this.state=3),Promise.resolve()))),this.listener.Pr())))})),this.stream.vr((e=>{n((()=>this.Io(e)))})),this.stream.onMessage((e=>{n((()=>this.onMessage(e)))}))}uo(){this.state=5,this.ro.Hr((async()=>{this.state=0,this.start()}))}Io(e){return g("PersistentStream",`close with error: ${e}`),this.stream=null,this.close(4,e)}yo(e){return t=>{this.Sn.enqueueAndForget((()=>this.no===e?t():(g("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve())))}}}class eo extends Zi{constructor(e,t,n,s,r,i){super(e,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",t,n,s,i),this.O=r}Eo(e,t){return this.eo.Ur("Listen",e,t)}onMessage(e){this.ro.reset();const t=function(e,t){let n;if("targetChange"in t){t.targetChange;const s=function(e){return"NO_CHANGE"===e?0:"ADD"===e?1:"REMOVE"===e?2:"CURRENT"===e?3:"RESET"===e?4:v()}(t.targetChange.targetChangeType||"NO_CHANGE"),r=t.targetChange.targetIds||[],i=function(e,t){return e.N?(I(void 0===t||"string"==typeof t),J.fromBase64String(t||"")):(I(void 0===t||t instanceof Uint8Array),J.fromUint8Array(t||new Uint8Array))}(e,t.targetChange.resumeToken),o=t.targetChange.cause,a=o&&function(e){const t=void 0===e.code?b.UNKNOWN:Jt(e.code);return new S(t,e.message||"")}(o);n=new wn(s,r,i,a||null)}else if("documentChange"in t){t.documentChange;const s=t.documentChange;s.document,s.document.name,s.document.updateTime;const r=Rn(e,s.document.name),i=An(s.document.updateTime),o=new Ne({mapValue:{fields:s.document.fields}}),a=ke.newFoundDocument(r,i,o),c=s.targetIds||[],u=s.removedTargetIds||[];n=new pn(c,u,a.key,a)}else if("documentDelete"in t){t.documentDelete;const s=t.documentDelete;s.document;const r=Rn(e,s.document),i=s.readTime?An(s.readTime):B.min(),o=ke.newNoDocument(r,i),a=s.removedTargetIds||[];n=new pn([],a,o.key,o)}else if("documentRemove"in t){t.documentRemove;const s=t.documentRemove;s.document;const r=Rn(e,s.document),i=s.removedTargetIds||[];n=new pn([],i,r,null)}else{if(!("filter"in t))return v();{t.filter;const e=t.filter;e.targetId;const s=e.count||0,r=new zt(s),i=e.targetId;n=new yn(i,r)}}return n}(this.O,e),n=function(e){if(!("targetChange"in e))return B.min();const t=e.targetChange;return t.targetIds&&t.targetIds.length?B.min():t.readTime?An(t.readTime):B.min()}(e);return this.listener.To(t,n)}Ao(e){const t={};t.database=Pn(this.O),t.addTarget=function(e,t){let n;const s=t.target;return n=Ve(s)?{documents:Kn(e,s)}:{query:Gn(e,s)},n.targetId=t.targetId,t.resumeToken.approximateByteSize()>0?n.resumeToken=_n(e,t.resumeToken):t.snapshotVersion.compareTo(B.min())>0&&(n.readTime=Nn(e,t.snapshotVersion.toTimestamp())),n}(this.O,e);const n=function(e,t){const n=function(e,t){switch(t){case 0:return null;case 1:return"existence-filter-mismatch";case 2:return"limbo-document";default:return v()}}(0,t.purpose);return null==n?null:{"goog-listen-tags":n}}(this.O,e);n&&(t.labels=n),this.fo(t)}Ro(e){const t={};t.database=Pn(this.O),t.removeTarget=e,this.fo(t)}}class to extends Zi{constructor(e,t,n,s,r,i){super(e,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",t,n,s,i),this.O=r,this.Po=!1}get bo(){return this.Po}start(){this.Po=!1,this.lastStreamToken=void 0,super.start()}mo(){this.Po&&this.vo([])}Eo(e,t){return this.eo.Ur("Write",e,t)}onMessage(e){if(I(!!e.streamToken),this.lastStreamToken=e.streamToken,this.Po){this.ro.reset();const t=function(e,t){return e&&e.length>0?(I(void 0!==t),e.map((e=>function(e,t){let n=e.updateTime?An(e.updateTime):An(t);return n.isEqual(B.min())&&(n=An(t)),new Ct(n,e.transformResults||[])}(e,t)))):[]}(e.writeResults,e.commitTime),n=An(e.commitTime);return this.listener.Vo(n,t)}return I(!e.writeResults||0===e.writeResults.length),this.Po=!0,this.listener.So()}Do(){const e={};e.database=Pn(this.O),this.fo(e)}vo(e){const t={streamToken:this.lastStreamToken,writes:e.map((e=>Un(this.O,e)))};this.fo(t)}}class no extends class{}{constructor(e,t,n,s){super(),this.authCredentials=e,this.appCheckCredentials=t,this.eo=n,this.O=s,this.Co=!1}No(){if(this.Co)throw new S(b.FAILED_PRECONDITION,"The client has already been terminated.")}Mr(e,t,n){return this.No(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([s,r])=>this.eo.Mr(e,t,n,s,r))).catch((e=>{throw"FirebaseError"===e.name?(e.code===b.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new S(b.UNKNOWN,e.toString())}))}Lr(e,t,n){return this.No(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([s,r])=>this.eo.Lr(e,t,n,s,r))).catch((e=>{throw"FirebaseError"===e.name?(e.code===b.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new S(b.UNKNOWN,e.toString())}))}terminate(){this.Co=!0}}class so{constructor(e,t){this.asyncQueue=e,this.onlineStateHandler=t,this.state="Unknown",this.xo=0,this.ko=null,this.Oo=!0}Mo(){0===this.xo&&(this.$o("Unknown"),this.ko=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,(()=>(this.ko=null,this.Fo("Backend didn't respond within 10 seconds."),this.$o("Offline"),Promise.resolve()))))}Bo(e){"Online"===this.state?this.$o("Unknown"):(this.xo++,this.xo>=1&&(this.Lo(),this.Fo(`Connection failed 1 times. Most recent error: ${e.toString()}`),this.$o("Offline")))}set(e){this.Lo(),this.xo=0,"Online"===e&&(this.Oo=!1),this.$o(e)}$o(e){e!==this.state&&(this.state=e,this.onlineStateHandler(e))}Fo(e){const t=`Could not reach Cloud Firestore backend. ${e}\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.Oo?(p(t),this.Oo=!1):g("OnlineStateTracker",t)}Lo(){null!==this.ko&&(this.ko.cancel(),this.ko=null)}}class ro{constructor(e,t,n,s,r){this.localStore=e,this.datastore=t,this.asyncQueue=n,this.remoteSyncer={},this.Uo=[],this.qo=new Map,this.Ko=new Set,this.Go=[],this.jo=r,this.jo.mr((e=>{n.enqueueAndForget((async()=>{mo(this)&&(g("RemoteStore","Restarting streams for network reachability change."),await async function(e){const t=E(e);t.Ko.add(4),await oo(t),t.Qo.set("Unknown"),t.Ko.delete(4),await io(t)}(this))}))})),this.Qo=new so(n,s)}}async function io(e){if(mo(e))for(const t of e.Go)await t(!0)}async function oo(e){for(const t of e.Go)await t(!1)}function ao(e,t){const n=E(e);n.qo.has(t.targetId)||(n.qo.set(t.targetId,t),fo(n)?lo(n):Oo(n).co()&&uo(n,t))}function co(e,t){const n=E(e),s=Oo(n);n.qo.delete(t),s.co()&&ho(n,t),0===n.qo.size&&(s.co()?s.ho():mo(n)&&n.Qo.set("Unknown"))}function uo(e,t){e.Wo.Z(t.targetId),Oo(e).Ao(t)}function ho(e,t){e.Wo.Z(t),Oo(e).Ro(t)}function lo(e){e.Wo=new In({getRemoteKeysForTarget:t=>e.remoteSyncer.getRemoteKeysForTarget(t),Tt:t=>e.qo.get(t)||null}),Oo(e).start(),e.Qo.Mo()}function fo(e){return mo(e)&&!Oo(e).oo()&&e.qo.size>0}function mo(e){return 0===E(e).Ko.size}function go(e){e.Wo=void 0}async function po(e){e.qo.forEach(((t,n)=>{uo(e,t)}))}async function yo(e,t){go(e),fo(e)?(e.Qo.Bo(t),lo(e)):e.Qo.set("Unknown")}async function wo(e,t,n){if(e.Qo.set("Online"),t instanceof wn&&2===t.state&&t.cause)try{await async function(e,t){const n=t.cause;for(const s of t.targetIds)e.qo.has(s)&&(await e.remoteSyncer.rejectListen(s,n),e.qo.delete(s),e.Wo.removeTarget(s))}(e,t)}catch(n){g("RemoteStore","Failed to remove targets %s: %s ",t.targetIds.join(","),n),await vo(e,n)}else if(t instanceof pn?e.Wo.ct(t):t instanceof yn?e.Wo._t(t):e.Wo.ht(t),!n.isEqual(B.min()))try{const t=await mi(e.localStore);n.compareTo(t)>=0&&await function(e,t){const n=e.Wo.yt(t);return n.targetChanges.forEach(((n,s)=>{if(n.resumeToken.approximateByteSize()>0){const r=e.qo.get(s);r&&e.qo.set(s,r.withResumeToken(n.resumeToken,t))}})),n.targetMismatches.forEach((t=>{const n=e.qo.get(t);if(!n)return;e.qo.set(t,n.withResumeToken(J.EMPTY_BYTE_STRING,n.snapshotVersion)),ho(e,t);const s=new $s(n.target,t,1,n.sequenceNumber);uo(e,s)})),e.remoteSyncer.applyRemoteEvent(n)}(e,n)}catch(t){g("RemoteStore","Failed to raise snapshot:",t),await vo(e,t)}}async function vo(e,t,n){if(!Ls(t))throw t;e.Ko.add(1),await oo(e),e.Qo.set("Offline"),n||(n=()=>mi(e.localStore)),e.asyncQueue.enqueueRetryable((async()=>{g("RemoteStore","Retrying IndexedDB access"),await n(),e.Ko.delete(1),await io(e)}))}function Io(e,t){return t().catch((n=>vo(e,n,t)))}async function To(e){const t=E(e),n=Ro(t);let s=t.Uo.length>0?t.Uo[t.Uo.length-1].batchId:-1;for(;Eo(t);)try{const e=await pi(t.localStore,s);if(null===e){0===t.Uo.length&&n.ho();break}s=e.batchId,bo(t,e)}catch(e){await vo(t,e)}So(t)&&xo(t)}function Eo(e){return mo(e)&&e.Uo.length<10}function bo(e,t){e.Uo.push(t);const n=Ro(e);n.co()&&n.bo&&n.vo(t.mutations)}function So(e){return mo(e)&&!Ro(e).oo()&&e.Uo.length>0}function xo(e){Ro(e).start()}async function No(e){Ro(e).Do()}async function _o(e){const t=Ro(e);for(const n of e.Uo)t.vo(n.mutations)}async function ko(e,t,n){const s=e.Uo.shift(),r=Ks.from(s,t,n);await Io(e,(()=>e.remoteSyncer.applySuccessfulWrite(r))),await To(e)}async function Ao(e,t){t&&Ro(e).bo&&await async function(e,t){if(Yt(n=t.code)&&n!==b.ABORTED){const n=e.Uo.shift();Ro(e).ao(),await Io(e,(()=>e.remoteSyncer.rejectFailedWrite(n.batchId,t))),await To(e)}var n}(e,t),So(e)&&xo(e)}async function Do(e,t){const n=E(e);n.asyncQueue.verifyOperationInProgress(),g("RemoteStore","RemoteStore received new credentials");const s=mo(n);n.Ko.add(3),await oo(n),s&&n.Qo.set("Unknown"),await n.remoteSyncer.handleCredentialChange(t),n.Ko.delete(3),await io(n)}async function Co(e,t){const n=E(e);t?(n.Ko.delete(2),await io(n)):t||(n.Ko.add(2),await oo(n),n.Qo.set("Unknown"))}function Oo(e){return e.zo||(e.zo=function(e,t,n){const s=E(e);return s.No(),new eo(t,s.eo,s.authCredentials,s.appCheckCredentials,s.O,n)}(e.datastore,e.asyncQueue,{Pr:po.bind(null,e),vr:yo.bind(null,e),To:wo.bind(null,e)}),e.Go.push((async t=>{t?(e.zo.ao(),fo(e)?lo(e):e.Qo.set("Unknown")):(await e.zo.stop(),go(e))}))),e.zo}function Ro(e){return e.Ho||(e.Ho=function(e,t,n){const s=E(e);return s.No(),new to(t,s.eo,s.authCredentials,s.appCheckCredentials,s.O,n)}(e.datastore,e.asyncQueue,{Pr:No.bind(null,e),vr:Ao.bind(null,e),So:_o.bind(null,e),Vo:ko.bind(null,e)}),e.Go.push((async t=>{t?(e.Ho.ao(),await To(e)):(await e.Ho.stop(),e.Uo.length>0&&(g("RemoteStore",`Stopping write stream with ${e.Uo.length} pending writes`),e.Uo=[]))}))),e.Ho}class Lo{constructor(e,t,n,s,r){this.asyncQueue=e,this.timerId=t,this.targetTimeMs=n,this.op=s,this.removalCallback=r,this.deferred=new x,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch((e=>{}))}static createAndSchedule(e,t,n,s,r){const i=Date.now()+n,o=new Lo(e,t,i,s,r);return o.start(n),o}start(e){this.timerHandle=setTimeout((()=>this.handleDelayElapsed()),e)}skipDelay(){return this.handleDelayElapsed()}cancel(e){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new S(b.CANCELLED,"Operation cancelled"+(e?": "+e:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget((()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then((e=>this.deferred.resolve(e)))):Promise.resolve()))}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function Mo(e,t){if(p("AsyncQueue",`${t}: ${e}`),Ls(e))return new S(b.UNAVAILABLE,`${t}: ${e}`);throw e}class Po{constructor(e){this.comparator=e?(t,n)=>e(t,n)||he.comparator(t.key,n.key):(e,t)=>he.comparator(e.key,t.key),this.keyedMap=cn(),this.sortedSet=new Xt(this.comparator)}static emptySet(e){return new Po(e.comparator)}has(e){return null!=this.keyedMap.get(e)}get(e){return this.keyedMap.get(e)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(e){const t=this.keyedMap.get(e);return t?this.sortedSet.indexOf(t):-1}get size(){return this.sortedSet.size}forEach(e){this.sortedSet.inorderTraversal(((t,n)=>(e(t),!1)))}add(e){const t=this.delete(e.key);return t.copy(t.keyedMap.insert(e.key,e),t.sortedSet.insert(e,null))}delete(e){const t=this.get(e);return t?this.copy(this.keyedMap.remove(e),this.sortedSet.remove(t)):this}isEqual(e){if(!(e instanceof Po))return!1;if(this.size!==e.size)return!1;const t=this.sortedSet.getIterator(),n=e.sortedSet.getIterator();for(;t.hasNext();){const e=t.getNext().key,s=n.getNext().key;if(!e.isEqual(s))return!1}return!0}toString(){const e=[];return this.forEach((t=>{e.push(t.toString())})),0===e.length?"DocumentSet ()":"DocumentSet (\n  "+e.join("  \n")+"\n)"}copy(e,t){const n=new Po;return n.comparator=this.comparator,n.keyedMap=e,n.sortedSet=t,n}}class Vo{constructor(){this.Jo=new Xt(he.comparator)}track(e){const t=e.doc.key,n=this.Jo.get(t);n?0!==e.type&&3===n.type?this.Jo=this.Jo.insert(t,e):3===e.type&&1!==n.type?this.Jo=this.Jo.insert(t,{type:n.type,doc:e.doc}):2===e.type&&2===n.type?this.Jo=this.Jo.insert(t,{type:2,doc:e.doc}):2===e.type&&0===n.type?this.Jo=this.Jo.insert(t,{type:0,doc:e.doc}):1===e.type&&0===n.type?this.Jo=this.Jo.remove(t):1===e.type&&2===n.type?this.Jo=this.Jo.insert(t,{type:1,doc:n.doc}):0===e.type&&1===n.type?this.Jo=this.Jo.insert(t,{type:2,doc:e.doc}):v():this.Jo=this.Jo.insert(t,e)}Yo(){const e=[];return this.Jo.inorderTraversal(((t,n)=>{e.push(n)})),e}}class Fo{constructor(e,t,n,s,r,i,o,a){this.query=e,this.docs=t,this.oldDocs=n,this.docChanges=s,this.mutatedKeys=r,this.fromCache=i,this.syncStateChanged=o,this.excludesMetadataChanges=a}static fromInitialDocuments(e,t,n,s){const r=[];return t.forEach((e=>{r.push({type:0,doc:e})})),new Fo(e,t,Po.emptySet(t),r,n,s,!0,!1)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(e){if(!(this.fromCache===e.fromCache&&this.syncStateChanged===e.syncStateChanged&&this.mutatedKeys.isEqual(e.mutatedKeys)&&ut(this.query,e.query)&&this.docs.isEqual(e.docs)&&this.oldDocs.isEqual(e.oldDocs)))return!1;const t=this.docChanges,n=e.docChanges;if(t.length!==n.length)return!1;for(let s=0;s<t.length;s++)if(t[s].type!==n[s].type||!t[s].doc.isEqual(n[s].doc))return!1;return!0}}class qo{constructor(){this.Xo=void 0,this.listeners=[]}}class Uo{constructor(){this.queries=new zr((e=>ht(e)),ut),this.onlineState="Unknown",this.Zo=new Set}}async function Bo(e,t){const n=E(e),s=t.query;let r=!1,i=n.queries.get(s);if(i||(r=!0,i=new qo),r)try{i.Xo=await n.onListen(s)}catch(e){const n=Mo(e,`Initialization of query '${lt(t.query)}' failed`);return void t.onError(n)}n.queries.set(s,i),i.listeners.push(t),t.tc(n.onlineState),i.Xo&&t.ec(i.Xo)&&jo(n)}async function Ko(e,t){const n=E(e),s=t.query;let r=!1;const i=n.queries.get(s);if(i){const e=i.listeners.indexOf(t);e>=0&&(i.listeners.splice(e,1),r=0===i.listeners.length)}if(r)return n.queries.delete(s),n.onUnlisten(s)}function Go(e,t){const n=E(e);let s=!1;for(const r of t){const e=r.query,t=n.queries.get(e);if(t){for(const e of t.listeners)e.ec(r)&&(s=!0);t.Xo=r}}s&&jo(n)}function $o(e,t,n){const s=E(e),r=s.queries.get(t);if(r)for(const i of r.listeners)i.onError(n);s.queries.delete(t)}function jo(e){e.Zo.forEach((e=>{e.next()}))}class Qo{constructor(e,t,n){this.query=e,this.nc=t,this.sc=!1,this.ic=null,this.onlineState="Unknown",this.options=n||{}}ec(e){if(!this.options.includeMetadataChanges){const t=[];for(const n of e.docChanges)3!==n.type&&t.push(n);e=new Fo(e.query,e.docs,e.oldDocs,t,e.mutatedKeys,e.fromCache,e.syncStateChanged,!0)}let t=!1;return this.sc?this.rc(e)&&(this.nc.next(e),t=!0):this.oc(e,this.onlineState)&&(this.cc(e),t=!0),this.ic=e,t}onError(e){this.nc.error(e)}tc(e){this.onlineState=e;let t=!1;return this.ic&&!this.sc&&this.oc(this.ic,e)&&(this.cc(this.ic),t=!0),t}oc(e,t){if(!e.fromCache)return!0;const n="Offline"!==t;return(!this.options.uc||!n)&&(!e.docs.isEmpty()||"Offline"===t)}rc(e){if(e.docChanges.length>0)return!0;const t=this.ic&&this.ic.hasPendingWrites!==e.hasPendingWrites;return!(!e.syncStateChanged&&!t)&&!0===this.options.includeMetadataChanges}cc(e){e=Fo.fromInitialDocuments(e.query,e.docs,e.mutatedKeys,e.fromCache),this.sc=!0,this.nc.next(e)}}class zo{constructor(e,t){this.payload=e,this.byteLength=t}ac(){return"metadata"in this.payload}}class Wo{constructor(e){this.O=e}Gs(e){return Rn(this.O,e)}js(e){return e.metadata.exists?qn(this.O,e.document,!1):ke.newNoDocument(this.Gs(e.metadata.name),this.Qs(e.metadata.readTime))}Qs(e){return An(e)}}class Ho{constructor(e,t,n){this.hc=e,this.localStore=t,this.O=n,this.queries=[],this.documents=[],this.progress=Yo(e)}lc(e){this.progress.bytesLoaded+=e.byteLength;let t=this.progress.documentsLoaded;return e.payload.namedQuery?this.queries.push(e.payload.namedQuery):e.payload.documentMetadata?(this.documents.push({metadata:e.payload.documentMetadata}),e.payload.documentMetadata.exists||++t):e.payload.document&&(this.documents[this.documents.length-1].document=e.payload.document,++t),t!==this.progress.documentsLoaded?(this.progress.documentsLoaded=t,Object.assign({},this.progress)):null}fc(e){const t=new Map,n=new Wo(this.O);for(const s of e)if(s.metadata.queries){const e=n.Gs(s.metadata.name);for(const n of s.metadata.queries){const s=(t.get(n)||ln()).add(e);t.set(n,s)}}return t}async complete(){const e=await async function(e,t,n,s){const r=E(e);let i=ln(),o=on();for(const u of n){const e=t.Gs(u.metadata.name);u.document&&(i=i.add(e));const n=t.js(u);n.setReadTime(t.Qs(u.metadata.readTime)),o=o.insert(e,n)}const a=r.Bs.newChangeBuffer({trackRemovals:!0}),c=await yi(r,function(e){return at(et(Q.fromString(`__bundle__/docs/${e}`)))}(s));return r.persistence.runTransaction("Apply bundle documents","readwrite",(e=>gi(e,a,o).next((t=>(a.apply(e),t))).next((t=>r.Un.removeMatchingKeysForTargetId(e,c.targetId).next((()=>r.Un.addMatchingKeys(e,i,c.targetId))).next((()=>r.Us.Ts(e,t))).next((()=>t))))))}(this.localStore,new Wo(this.O),this.documents,this.hc.id),t=this.fc(this.documents);for(const n of this.queries)await Ei(this.localStore,n,t.get(n.name));return this.progress.taskState="Success",new ai(Object.assign({},this.progress),e)}}function Yo(e){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:e.totalDocuments,totalBytes:e.totalBytes}}class Jo{constructor(e){this.key=e}}class Xo{constructor(e){this.key=e}}class Zo{constructor(e,t){this.query=e,this.dc=t,this._c=null,this.current=!1,this.wc=ln(),this.mutatedKeys=ln(),this.mc=ft(e),this.gc=new Po(this.mc)}get yc(){return this.dc}Ic(e,t){const n=t?t.Ec:new Vo,s=t?t.gc:this.gc;let r=t?t.mutatedKeys:this.mutatedKeys,i=s,o=!1;const a=tt(this.query)&&s.size===this.query.limit?s.last():null,c=nt(this.query)&&s.size===this.query.limit?s.first():null;if(e.inorderTraversal(((e,t)=>{const u=s.get(e),h=dt(this.query,t)?t:null,l=!!u&&this.mutatedKeys.has(u.key),d=!!h&&(h.hasLocalMutations||this.mutatedKeys.has(h.key)&&h.hasCommittedMutations);let f=!1;u&&h?u.data.isEqual(h.data)?l!==d&&(n.track({type:3,doc:h}),f=!0):this.Tc(u,h)||(n.track({type:2,doc:h}),f=!0,(a&&this.mc(h,a)>0||c&&this.mc(h,c)<0)&&(o=!0)):!u&&h?(n.track({type:0,doc:h}),f=!0):u&&!h&&(n.track({type:1,doc:u}),f=!0,(a||c)&&(o=!0)),f&&(h?(i=i.add(h),r=d?r.add(e):r.delete(e)):(i=i.delete(e),r=r.delete(e)))})),tt(this.query)||nt(this.query))for(;i.size>this.query.limit;){const e=tt(this.query)?i.last():i.first();i=i.delete(e.key),r=r.delete(e.key),n.track({type:1,doc:e})}return{gc:i,Ec:n,ks:o,mutatedKeys:r}}Tc(e,t){return e.hasLocalMutations&&t.hasCommittedMutations&&!t.hasLocalMutations}applyChanges(e,t,n){const s=this.gc;this.gc=e.gc,this.mutatedKeys=e.mutatedKeys;const r=e.Ec.Yo();r.sort(((e,t)=>function(e,t){const n=e=>{switch(e){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return v()}};return n(e)-n(t)}(e.type,t.type)||this.mc(e.doc,t.doc))),this.Ac(n);const i=t?this.Rc():[],o=0===this.wc.size&&this.current?1:0,a=o!==this._c;return this._c=o,0!==r.length||a?{snapshot:new Fo(this.query,e.gc,s,r,e.mutatedKeys,0===o,a,!1),Pc:i}:{Pc:i}}tc(e){return this.current&&"Offline"===e?(this.current=!1,this.applyChanges({gc:this.gc,Ec:new Vo,mutatedKeys:this.mutatedKeys,ks:!1},!1)):{Pc:[]}}bc(e){return!this.dc.has(e)&&!!this.gc.has(e)&&!this.gc.get(e).hasLocalMutations}Ac(e){e&&(e.addedDocuments.forEach((e=>this.dc=this.dc.add(e))),e.modifiedDocuments.forEach((e=>{})),e.removedDocuments.forEach((e=>this.dc=this.dc.delete(e))),this.current=e.current)}Rc(){if(!this.current)return[];const e=this.wc;this.wc=ln(),this.gc.forEach((e=>{this.bc(e.key)&&(this.wc=this.wc.add(e.key))}));const t=[];return e.forEach((e=>{this.wc.has(e)||t.push(new Xo(e))})),this.wc.forEach((n=>{e.has(n)||t.push(new Jo(n))})),t}vc(e){this.dc=e.Ks,this.wc=ln();const t=this.Ic(e.documents);return this.applyChanges(t,!0)}Vc(){return Fo.fromInitialDocuments(this.query,this.gc,this.mutatedKeys,0===this._c)}}class ea{constructor(e,t,n){this.query=e,this.targetId=t,this.view=n}}class ta{constructor(e){this.key=e,this.Sc=!1}}class na{constructor(e,t,n,s,r,i){this.localStore=e,this.remoteStore=t,this.eventManager=n,this.sharedClientState=s,this.currentUser=r,this.maxConcurrentLimboResolutions=i,this.Dc={},this.Cc=new zr((e=>ht(e)),ut),this.Nc=new Map,this.xc=new Set,this.kc=new Xt(he.comparator),this.Oc=new Map,this.Mc=new xi,this.$c={},this.Fc=new Map,this.Bc=Mr.Je(),this.onlineState="Unknown",this.Lc=void 0}get isPrimaryClient(){return!0===this.Lc}}async function sa(e,t){const n=Aa(e);let s,r;const i=n.Cc.get(t);if(i)s=i.targetId,n.sharedClientState.addLocalQueryTarget(s),r=i.view.Vc();else{const e=await yi(n.localStore,at(t));n.isPrimaryClient&&ao(n.remoteStore,e);const i=n.sharedClientState.addLocalQueryTarget(e.targetId);s=e.targetId,r=await ra(n,t,s,"current"===i)}return r}async function ra(e,t,n,s){e.Uc=(t,n,s)=>async function(e,t,n,s){let r=t.view.Ic(n);r.ks&&(r=await vi(e.localStore,t.query,!1).then((({documents:e})=>t.view.Ic(e,r))));const i=s&&s.targetChanges.get(t.targetId),o=t.view.applyChanges(r,e.isPrimaryClient,i);return ga(e,t.targetId,o.Pc),o.snapshot}(e,t,n,s);const r=await vi(e.localStore,t,!0),i=new Zo(t,r.Ks),o=i.Ic(r.documents),a=gn.createSynthesizedTargetChangeForCurrentChange(n,s&&"Offline"!==e.onlineState),c=i.applyChanges(o,e.isPrimaryClient,a);ga(e,n,c.Pc);const u=new ea(t,n,i);return e.Cc.set(t,u),e.Nc.has(n)?e.Nc.get(n).push(t):e.Nc.set(n,[t]),c.snapshot}async function ia(e,t){const n=E(e),s=n.Cc.get(t),r=n.Nc.get(s.targetId);if(r.length>1)return n.Nc.set(s.targetId,r.filter((e=>!ut(e,t)))),void n.Cc.delete(t);n.isPrimaryClient?(n.sharedClientState.removeLocalQueryTarget(s.targetId),n.sharedClientState.isActiveQueryTarget(s.targetId)||await wi(n.localStore,s.targetId,!1).then((()=>{n.sharedClientState.clearQueryState(s.targetId),co(n.remoteStore,s.targetId),fa(n,s.targetId)})).catch(Ur)):(fa(n,s.targetId),await wi(n.localStore,s.targetId,!0))}async function oa(e,t){const n=E(e);try{const e=await function(e,t){const n=E(e),s=t.snapshotVersion;let r=n.Ms;return n.persistence.runTransaction("Apply remote event","readwrite-primary",(e=>{const i=n.Bs.newChangeBuffer({trackRemovals:!0});r=n.Ms;const o=[];t.targetChanges.forEach(((i,a)=>{const c=r.get(a);if(!c)return;o.push(n.Un.removeMatchingKeys(e,i.removedDocuments,a).next((()=>n.Un.addMatchingKeys(e,i.addedDocuments,a))));let u=c.withSequenceNumber(e.currentSequenceNumber);t.targetMismatches.has(a)?u=u.withResumeToken(J.EMPTY_BYTE_STRING,B.min()).withLastLimboFreeSnapshotVersion(B.min()):i.resumeToken.approximateByteSize()>0&&(u=u.withResumeToken(i.resumeToken,s)),r=r.insert(a,u),function(e,t,n){return 0===e.resumeToken.approximateByteSize()||t.snapshotVersion.toMicroseconds()-e.snapshotVersion.toMicroseconds()>=3e8||n.addedDocuments.size+n.modifiedDocuments.size+n.removedDocuments.size>0}(c,u,i)&&o.push(n.Un.updateTargetData(e,u))}));let a=on();if(t.documentUpdates.forEach((s=>{t.resolvedLimboDocuments.has(s)&&o.push(n.persistence.referenceDelegate.updateLimboDocument(e,s))})),o.push(gi(e,i,t.documentUpdates).next((e=>{a=e}))),!s.isEqual(B.min())){const t=n.Un.getLastRemoteSnapshotVersion(e).next((t=>n.Un.setTargetsMetadata(e,e.currentSequenceNumber,s)));o.push(t)}return As.waitFor(o).next((()=>i.apply(e))).next((()=>n.Us.Ts(e,a))).next((()=>a))})).then((e=>(n.Ms=r,e)))}(n.localStore,t);t.targetChanges.forEach(((e,t)=>{const s=n.Oc.get(t);s&&(I(e.addedDocuments.size+e.modifiedDocuments.size+e.removedDocuments.size<=1),e.addedDocuments.size>0?s.Sc=!0:e.modifiedDocuments.size>0?I(s.Sc):e.removedDocuments.size>0&&(I(s.Sc),s.Sc=!1))})),await wa(n,e,t)}catch(e){await Ur(e)}}function aa(e,t,n){const s=E(e);if(s.isPrimaryClient&&0===n||!s.isPrimaryClient&&1===n){const e=[];s.Cc.forEach(((n,s)=>{const r=s.view.tc(t);r.snapshot&&e.push(r.snapshot)})),function(e,t){const n=E(e);n.onlineState=t;let s=!1;n.queries.forEach(((e,n)=>{for(const r of n.listeners)r.tc(t)&&(s=!0)})),s&&jo(n)}(s.eventManager,t),e.length&&s.Dc.To(e),s.onlineState=t,s.isPrimaryClient&&s.sharedClientState.setOnlineState(t)}}async function ca(e,t,n){const s=E(e);s.sharedClientState.updateQueryState(t,"rejected",n);const r=s.Oc.get(t),i=r&&r.key;if(i){let e=new Xt(he.comparator);e=e.insert(i,ke.newNoDocument(i,B.min()));const n=ln().add(i),r=new mn(B.min(),new Map,new tn(V),e,n);await oa(s,r),s.kc=s.kc.remove(i),s.Oc.delete(t),ya(s)}else await wi(s.localStore,t,!1).then((()=>fa(s,t,n))).catch(Ur)}async function ua(e,t){const n=E(e),s=t.batch.batchId;try{const e=await function(e,t){const n=E(e);return n.persistence.runTransaction("Acknowledge batch","readwrite-primary",(e=>{const s=t.batch.keys(),r=n.Bs.newChangeBuffer({trackRemovals:!0});return function(e,t,n,s){const r=n.batch,i=r.keys();let o=As.resolve();return i.forEach((e=>{o=o.next((()=>s.getEntry(t,e))).next((t=>{const i=n.docVersions.get(e);I(null!==i),t.version.compareTo(i)<0&&(r.applyToRemoteDocument(t,n),t.isValidDocument()&&(t.setReadTime(n.commitVersion),s.addEntry(t)))}))})),o.next((()=>e.gs.removeMutationBatch(t,r)))}(n,e,t,r).next((()=>r.apply(e))).next((()=>n.gs.performConsistencyCheck(e))).next((()=>n.Us.Es(e,s)))}))}(n.localStore,t);da(n,s,null),la(n,s),n.sharedClientState.updateMutationState(s,"acknowledged"),await wa(n,e)}catch(e){await Ur(e)}}async function ha(e,t,n){const s=E(e);try{const e=await function(e,t){const n=E(e);return n.persistence.runTransaction("Reject batch","readwrite-primary",(e=>{let s;return n.gs.lookupMutationBatch(e,t).next((t=>(I(null!==t),s=t.keys(),n.gs.removeMutationBatch(e,t)))).next((()=>n.gs.performConsistencyCheck(e))).next((()=>n.Us.Es(e,s)))}))}(s.localStore,t);da(s,t,n),la(s,t),s.sharedClientState.updateMutationState(t,"rejected",n),await wa(s,e)}catch(n){await Ur(n)}}function la(e,t){(e.Fc.get(t)||[]).forEach((e=>{e.resolve()})),e.Fc.delete(t)}function da(e,t,n){const s=E(e);let r=s.$c[s.currentUser.toKey()];if(r){const e=r.get(t);e&&(n?e.reject(n):e.resolve(),r=r.remove(t)),s.$c[s.currentUser.toKey()]=r}}function fa(e,t,n=null){e.sharedClientState.removeLocalQueryTarget(t);for(const s of e.Nc.get(t))e.Cc.delete(s),n&&e.Dc.qc(s,n);e.Nc.delete(t),e.isPrimaryClient&&e.Mc.si(t).forEach((t=>{e.Mc.containsKey(t)||ma(e,t)}))}function ma(e,t){e.xc.delete(t.path.canonicalString());const n=e.kc.get(t);null!==n&&(co(e.remoteStore,n),e.kc=e.kc.remove(t),e.Oc.delete(n),ya(e))}function ga(e,t,n){for(const s of n)s instanceof Jo?(e.Mc.addReference(s.key,t),pa(e,s)):s instanceof Xo?(g("SyncEngine","Document no longer in limbo: "+s.key),e.Mc.removeReference(s.key,t),e.Mc.containsKey(s.key)||ma(e,s.key)):v()}function pa(e,t){const n=t.key,s=n.path.canonicalString();e.kc.get(n)||e.xc.has(s)||(g("SyncEngine","New document in limbo: "+n),e.xc.add(s),ya(e))}function ya(e){for(;e.xc.size>0&&e.kc.size<e.maxConcurrentLimboResolutions;){const t=e.xc.values().next().value;e.xc.delete(t);const n=new he(Q.fromString(t)),s=e.Bc.next();e.Oc.set(s,new ta(n)),e.kc=e.kc.insert(n,s),ao(e.remoteStore,new $s(at(et(n.path)),s,2,L.A))}}async function wa(e,t,n){const s=E(e),r=[],i=[],o=[];s.Cc.isEmpty()||(s.Cc.forEach(((e,a)=>{o.push(s.Uc(a,t,n).then((e=>{if(e){s.isPrimaryClient&&s.sharedClientState.updateQueryState(a.targetId,e.fromCache?"not-current":"current"),r.push(e);const t=ui.Ss(a.targetId,e);i.push(t)}})))})),await Promise.all(o),s.Dc.To(r),await async function(e,t){const n=E(e);try{await n.persistence.runTransaction("notifyLocalViewChanges","readwrite",(e=>As.forEach(t,(t=>As.forEach(t.vs,(s=>n.persistence.referenceDelegate.addReference(e,t.targetId,s))).next((()=>As.forEach(t.Vs,(s=>n.persistence.referenceDelegate.removeReference(e,t.targetId,s)))))))))}catch(e){if(!Ls(e))throw e;g("LocalStore","Failed to update sequence numbers: "+e)}for(const s of t){const e=s.targetId;if(!s.fromCache){const t=n.Ms.get(e),s=t.snapshotVersion,r=t.withLastLimboFreeSnapshotVersion(s);n.Ms=n.Ms.insert(e,r)}}}(s.localStore,i))}async function va(e,t){const n=E(e);if(!n.currentUser.isEqual(t)){g("SyncEngine","User change. New user:",t.toKey());const e=await fi(n.localStore,t);n.currentUser=t,function(e,t){e.Fc.forEach((e=>{e.forEach((e=>{e.reject(new S(b.CANCELLED,"'waitForPendingWrites' promise is rejected due to a user change."))}))})),e.Fc.clear()}(n),n.sharedClientState.handleUserChange(t,e.removedBatchIds,e.addedBatchIds),await wa(n,e.qs)}}function Ia(e,t){const n=E(e),s=n.Oc.get(t);if(s&&s.Sc)return ln().add(s.key);{let e=ln();const s=n.Nc.get(t);if(!s)return e;for(const t of s){const s=n.Cc.get(t);e=e.unionWith(s.view.yc)}return e}}async function Ta(e,t){const n=E(e),s=await vi(n.localStore,t.query,!0),r=t.view.vc(s);return n.isPrimaryClient&&ga(n,t.targetId,r.Pc),r}async function Ea(e){const t=E(e);return Ti(t.localStore).then((e=>wa(t,e)))}async function ba(e,t,n,s){const r=E(e),i=await function(e,t){const n=E(e),s=E(n.gs);return n.persistence.runTransaction("Lookup mutation documents","readonly",(e=>s.Ge(e,t).next((t=>t?n.Us.Es(e,t):As.resolve(null)))))}(r.localStore,t);null!==i?("pending"===n?await To(r.remoteStore):"acknowledged"===n||"rejected"===n?(da(r,t,s||null),la(r,t),function(e,t){E(E(e).gs).Qe(t)}(r.localStore,t)):v(),await wa(r,i)):g("SyncEngine","Cannot apply mutation batch with id: "+t)}async function Sa(e,t,n){const s=E(e),r=[],i=[];for(const o of t){let e;const t=s.Nc.get(o);if(t&&0!==t.length){e=await yi(s.localStore,at(t[0]));for(const e of t){const t=s.Cc.get(e),n=await Ta(s,t);n.snapshot&&i.push(n.snapshot)}}else{const t=await Ii(s.localStore,o);e=await yi(s.localStore,t),await ra(s,xa(t),o,!1)}r.push(e)}return s.Dc.To(i),r}function xa(e){return Ze(e.path,e.collectionGroup,e.orderBy,e.filters,e.limit,"F",e.startAt,e.endAt)}function Na(e){const t=E(e);return E(E(t.localStore).persistence).ds()}async function _a(e,t,n,s){const r=E(e);if(r.Lc)g("SyncEngine","Ignoring unexpected query state notification.");else if(r.Nc.has(t))switch(n){case"current":case"not-current":{const e=await Ti(r.localStore),s=mn.createSynthesizedRemoteEventForCurrentChange(t,"current"===n);await wa(r,e,s);break}case"rejected":await wi(r.localStore,t,!0),fa(r,t,s);break;default:v()}}async function ka(e,t,n){const s=Aa(e);if(s.Lc){for(const e of t){if(s.Nc.has(e)){g("SyncEngine","Adding an already active target "+e);continue}const t=await Ii(s.localStore,e),n=await yi(s.localStore,t);await ra(s,xa(t),n.targetId,!1),ao(s.remoteStore,n)}for(const e of n)s.Nc.has(e)&&await wi(s.localStore,e,!1).then((()=>{co(s.remoteStore,e),fa(s,e)})).catch(Ur)}}function Aa(e){const t=E(e);return t.remoteStore.remoteSyncer.applyRemoteEvent=oa.bind(null,t),t.remoteStore.remoteSyncer.getRemoteKeysForTarget=Ia.bind(null,t),t.remoteStore.remoteSyncer.rejectListen=ca.bind(null,t),t.Dc.To=Go.bind(null,t.eventManager),t.Dc.qc=$o.bind(null,t.eventManager),t}function Da(e){const t=E(e);return t.remoteStore.remoteSyncer.applySuccessfulWrite=ua.bind(null,t),t.remoteStore.remoteSyncer.rejectFailedWrite=ha.bind(null,t),t}class Ca{constructor(){this.synchronizeTabs=!1}async initialize(e){this.O=Ji(e.databaseInfo.databaseId),this.sharedClientState=this.Gc(e),this.persistence=this.jc(e),await this.persistence.start(),this.gcScheduler=this.Qc(e),this.localStore=this.Wc(e)}Qc(e){return null}Wc(e){return di(this.persistence,new hi,e.initialUser,this.O)}jc(e){return new Ci(Ri.bi,this.O)}Gc(e){return new Gi}async terminate(){this.gcScheduler&&this.gcScheduler.stop(),await this.sharedClientState.shutdown(),await this.persistence.shutdown()}}class Oa extends Ca{constructor(e,t,n){super(),this.zc=e,this.cacheSizeBytes=t,this.forceOwnership=n,this.synchronizeTabs=!1}async initialize(e){await super.initialize(e),await async function(e){const t=E(e);return t.persistence.runTransaction("Synchronize last document change read time","readonly",(e=>function(e){const t=Xr(e);let n=B.min();return t.Qt({index:ls.readTimeIndex,reverse:!0},((e,t,s)=>{t.readTime&&(n=Hs(t.readTime)),s.done()})).next((()=>n))}(e))).then((e=>{t.Fs=e}))}(this.localStore),await this.zc.initialize(this,e),await Da(this.zc.syncEngine),await To(this.zc.remoteStore),await this.persistence.Hn((()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(this.localStore),Promise.resolve())))}Wc(e){return di(this.persistence,new hi,e.initialUser,this.O)}Qc(e){const t=this.persistence.referenceDelegate.garbageCollector;return new Gr(t,e.asyncQueue)}jc(e){const t=oi(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?_r.withCacheSize(this.cacheSizeBytes):_r.DEFAULT;return new si(this.synchronizeTabs,t,e.clientId,n,e.asyncQueue,Hi(),Yi(),this.O,this.sharedClientState,!!this.forceOwnership)}Gc(e){return new Gi}}class Ra extends Oa{constructor(e,t){super(e,t,!1),this.zc=e,this.cacheSizeBytes=t,this.synchronizeTabs=!0}async initialize(e){await super.initialize(e);const t=this.zc.syncEngine;this.sharedClientState instanceof Ki&&(this.sharedClientState.syncEngine={hr:ba.bind(null,t),lr:_a.bind(null,t),dr:ka.bind(null,t),ds:Na.bind(null,t),ar:Ea.bind(null,t)},await this.sharedClientState.start()),await this.persistence.Hn((async e=>{await async function(e,t){const n=E(e);if(Aa(n),Da(n),!0===t&&!0!==n.Lc){const e=n.sharedClientState.getAllActiveQueryTargets(),t=await Sa(n,e.toArray());n.Lc=!0,await Co(n.remoteStore,!0);for(const s of t)ao(n.remoteStore,s)}else if(!1===t&&!1!==n.Lc){const e=[];let t=Promise.resolve();n.Nc.forEach(((s,r)=>{n.sharedClientState.isLocalQueryTarget(r)?e.push(r):t=t.then((()=>(fa(n,r),wi(n.localStore,r,!0)))),co(n.remoteStore,r)})),await t,await Sa(n,e),function(e){const t=E(e);t.Oc.forEach(((e,n)=>{co(t.remoteStore,n)})),t.Mc.ii(),t.Oc=new Map,t.kc=new Xt(he.comparator)}(n),n.Lc=!1,await Co(n.remoteStore,!1)}}(this.zc.syncEngine,e),this.gcScheduler&&(e&&!this.gcScheduler.started?this.gcScheduler.start(this.localStore):e||this.gcScheduler.stop())}))}Gc(e){const t=Hi();if(!Ki.Vt(t))throw new S(b.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");const n=oi(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey);return new Ki(t,e.asyncQueue,n,e.clientId,e.initialUser)}}class La{async initialize(e,t){this.localStore||(this.localStore=e.localStore,this.sharedClientState=e.sharedClientState,this.datastore=this.createDatastore(t),this.remoteStore=this.createRemoteStore(t),this.eventManager=this.createEventManager(t),this.syncEngine=this.createSyncEngine(t,!e.synchronizeTabs),this.sharedClientState.onlineStateHandler=e=>aa(this.syncEngine,e,1),this.remoteStore.remoteSyncer.handleCredentialChange=va.bind(null,this.syncEngine),await Co(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(e){return new Uo}createDatastore(e){const t=Ji(e.databaseInfo.databaseId),n=(s=e.databaseInfo,new Wi(s));var s;return function(e,t,n,s){return new no(e,t,n,s)}(e.authCredentials,e.appCheckCredentials,n,t)}createRemoteStore(e){return t=this.localStore,n=this.datastore,s=e.asyncQueue,r=e=>aa(this.syncEngine,e,0),i=ji.Vt()?new ji:new $i,new ro(t,n,s,r,i);var t,n,s,r,i}createSyncEngine(e,t){return function(e,t,n,s,r,i,o){const a=new na(e,t,n,s,r,i);return o&&(a.Lc=!0),a}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,e.initialUser,e.maxConcurrentLimboResolutions,t)}terminate(){return async function(e){const t=E(e);g("RemoteStore","RemoteStore shutting down."),t.Ko.add(5),await oo(t),t.jo.shutdown(),t.Qo.set("Unknown")}(this.remoteStore)}}function Ma(e,t=10240){let n=0;return{async read(){if(n<e.byteLength){const s={value:e.slice(n,n+t),done:!1};return n+=t,s}return{done:!0}},async cancel(){},releaseLock(){},closed:Promise.reject("unimplemented")}}class Pa{constructor(e){this.observer=e,this.muted=!1}next(e){this.observer.next&&this.Hc(this.observer.next,e)}error(e){this.observer.error?this.Hc(this.observer.error,e):console.error("Uncaught Error in snapshot listener:",e)}Jc(){this.muted=!0}Hc(e,t){this.muted||setTimeout((()=>{this.muted||e(t)}),0)}}class Va{constructor(e,t){this.Yc=e,this.O=t,this.metadata=new x,this.buffer=new Uint8Array,this.Xc=new TextDecoder("utf-8"),this.Zc().then((e=>{e&&e.ac()?this.metadata.resolve(e.payload.metadata):this.metadata.reject(new Error(`The first element of the bundle is not a metadata, it is\n             ${JSON.stringify(null==e?void 0:e.payload)}`))}),(e=>this.metadata.reject(e)))}close(){return this.Yc.cancel()}async getMetadata(){return this.metadata.promise}async Kc(){return await this.getMetadata(),this.Zc()}async Zc(){const e=await this.tu();if(null===e)return null;const t=this.Xc.decode(e),n=Number(t);isNaN(n)&&this.eu(`length string (${t}) is not valid number`);const s=await this.nu(n);return new zo(JSON.parse(s),e.length+n)}su(){return this.buffer.findIndex((e=>e==="{".charCodeAt(0)))}async tu(){for(;this.su()<0&&!(await this.iu()););if(0===this.buffer.length)return null;const e=this.su();e<0&&this.eu("Reached the end of bundle when a length string is expected.");const t=this.buffer.slice(0,e);return this.buffer=this.buffer.slice(e),t}async nu(e){for(;this.buffer.length<e;)await this.iu()&&this.eu("Reached the end of bundle when more is expected.");const t=this.Xc.decode(this.buffer.slice(0,e));return this.buffer=this.buffer.slice(e),t}eu(e){throw this.Yc.cancel(),new Error(`Invalid bundle format: ${e}`)}async iu(){const e=await this.Yc.read();if(!e.done){const t=new Uint8Array(this.buffer.length+e.value.length);t.set(this.buffer),t.set(e.value,this.buffer.length),this.buffer=t}return e.done}}class Fa{constructor(e){this.datastore=e,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastWriteError=null,this.writtenDocs=new Set}async lookup(e){if(this.ensureCommitNotCalled(),this.mutations.length>0)throw new S(b.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes.");const t=await async function(e,t){const n=E(e),s=Pn(n.O)+"/documents",r={documents:t.map((e=>On(n.O,e)))},i=await n.Lr("BatchGetDocuments",s,r),o=new Map;i.forEach((e=>{const t=function(e,t){return"found"in t?function(e,t){I(!!t.found),t.found.name,t.found.updateTime;const n=Rn(e,t.found.name),s=An(t.found.updateTime),r=new Ne({mapValue:{fields:t.found.fields}});return ke.newFoundDocument(n,s,r)}(e,t):"missing"in t?function(e,t){I(!!t.missing),I(!!t.readTime);const n=Rn(e,t.missing),s=An(t.readTime);return ke.newNoDocument(n,s)}(e,t):v()}(n.O,e);o.set(t.key.toString(),t)}));const a=[];return t.forEach((e=>{const t=o.get(e.toString());I(!!t),a.push(t)})),a}(this.datastore,e);return t.forEach((e=>this.recordVersion(e))),t}set(e,t){this.write(t.toMutation(e,this.precondition(e))),this.writtenDocs.add(e.toString())}update(e,t){try{this.write(t.toMutation(e,this.preconditionForUpdate(e)))}catch(e){this.lastWriteError=e}this.writtenDocs.add(e.toString())}delete(e){this.write(new jt(e,this.precondition(e))),this.writtenDocs.add(e.toString())}async commit(){if(this.ensureCommitNotCalled(),this.lastWriteError)throw this.lastWriteError;const e=this.readVersions;this.mutations.forEach((t=>{e.delete(t.key.toString())})),e.forEach(((e,t)=>{const n=he.fromPath(t);this.mutations.push(new Qt(n,this.precondition(n)))})),await async function(e,t){const n=E(e),s=Pn(n.O)+"/documents",r={writes:t.map((e=>Un(n.O,e)))};await n.Mr("Commit",s,r)}(this.datastore,this.mutations),this.committed=!0}recordVersion(e){let t;if(e.isFoundDocument())t=e.version;else{if(!e.isNoDocument())throw v();t=B.min()}const n=this.readVersions.get(e.key.toString());if(n){if(!t.isEqual(n))throw new S(b.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(e.key.toString(),t)}precondition(e){const t=this.readVersions.get(e.toString());return!this.writtenDocs.has(e.toString())&&t?Ot.updateTime(t):Ot.none()}preconditionForUpdate(e){const t=this.readVersions.get(e.toString());if(!this.writtenDocs.has(e.toString())&&t){if(t.isEqual(B.min()))throw new S(b.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return Ot.updateTime(t)}return Ot.exists(!0)}write(e){this.ensureCommitNotCalled(),this.mutations.push(e)}ensureCommitNotCalled(){}}class qa{constructor(e,t,n,s){this.asyncQueue=e,this.datastore=t,this.updateFunction=n,this.deferred=s,this.ru=5,this.ro=new Xi(this.asyncQueue,"transaction_retry")}run(){this.ru-=1,this.ou()}ou(){this.ro.Hr((async()=>{const e=new Fa(this.datastore),t=this.cu(e);t&&t.then((t=>{this.asyncQueue.enqueueAndForget((()=>e.commit().then((()=>{this.deferred.resolve(t)})).catch((e=>{this.uu(e)}))))})).catch((e=>{this.uu(e)}))}))}cu(e){try{const t=this.updateFunction(e);return!ae(t)&&t.catch&&t.then?t:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(e){return this.deferred.reject(e),null}}uu(e){this.ru>0&&this.au(e)?(this.ru-=1,this.asyncQueue.enqueueAndForget((()=>(this.ou(),Promise.resolve())))):this.deferred.reject(e)}au(e){if("FirebaseError"===e.name){const t=e.code;return"aborted"===t||"failed-precondition"===t||!Yt(t)}return!1}}class Ua{constructor(e,t,n,s){this.authCredentials=e,this.appCheckCredentials=t,this.asyncQueue=n,this.databaseInfo=s,this.user=h.UNAUTHENTICATED,this.clientId=P.R(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this.authCredentials.start(n,(async e=>{g("FirestoreClient","Received user=",e.uid),await this.authCredentialListener(e),this.user=e})),this.appCheckCredentials.start(n,(e=>(g("FirestoreClient","Received new app check token=",e),this.appCheckCredentialListener(e,this.user))))}async getConfiguration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(e){this.authCredentialListener=e}setAppCheckTokenChangeListener(e){this.appCheckCredentialListener=e}verifyNotTerminated(){if(this.asyncQueue.isShuttingDown)throw new S(b.FAILED_PRECONDITION,"The client has already been terminated.")}terminate(){this.asyncQueue.enterRestrictedMode();const e=new x;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted((async()=>{try{this.onlineComponents&&await this.onlineComponents.terminate(),this.offlineComponents&&await this.offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),e.resolve()}catch(t){const n=Mo(t,"Failed to shutdown persistence");e.reject(n)}})),e.promise}}async function Ba(e,t){e.asyncQueue.verifyOperationInProgress(),g("FirestoreClient","Initializing OfflineComponentProvider");const n=await e.getConfiguration();await t.initialize(n);let s=n.initialUser;e.setCredentialChangeListener((async e=>{s.isEqual(e)||(await fi(t.localStore,e),s=e)})),t.persistence.setDatabaseDeletedListener((()=>e.terminate())),e.offlineComponents=t}async function Ka(e,t){e.asyncQueue.verifyOperationInProgress();const n=await Ga(e);g("FirestoreClient","Initializing OnlineComponentProvider");const s=await e.getConfiguration();await t.initialize(n,s),e.setCredentialChangeListener((e=>Do(t.remoteStore,e))),e.setAppCheckTokenChangeListener(((e,n)=>Do(t.remoteStore,n))),e.onlineComponents=t}async function Ga(e){return e.offlineComponents||(g("FirestoreClient","Using default OfflineComponentProvider"),await Ba(e,new Ca)),e.offlineComponents}async function $a(e){return e.onlineComponents||(g("FirestoreClient","Using default OnlineComponentProvider"),await Ka(e,new La)),e.onlineComponents}function ja(e){return Ga(e).then((e=>e.persistence))}function Qa(e){return Ga(e).then((e=>e.localStore))}function za(e){return $a(e).then((e=>e.remoteStore))}function Wa(e){return $a(e).then((e=>e.syncEngine))}async function Ha(e){const t=await $a(e),n=t.eventManager;return n.onListen=sa.bind(null,t.syncEngine),n.onUnlisten=ia.bind(null,t.syncEngine),n}function Ya(e,t,n={}){const s=new x;return e.asyncQueue.enqueueAndForget((async()=>function(e,t,n,s,r){const i=new Pa({next:i=>{t.enqueueAndForget((()=>Ko(e,o)));const a=i.docs.has(n);!a&&i.fromCache?r.reject(new S(b.UNAVAILABLE,"Failed to get document because the client is offline.")):a&&i.fromCache&&s&&"server"===s.source?r.reject(new S(b.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):r.resolve(i)},error:e=>r.reject(e)}),o=new Qo(et(n.path),i,{includeMetadataChanges:!0,uc:!0});return Bo(e,o)}(await Ha(e),e.asyncQueue,t,n,s))),s.promise}function Ja(e,t,n={}){const s=new x;return e.asyncQueue.enqueueAndForget((async()=>function(e,t,n,s,r){const i=new Pa({next:n=>{t.enqueueAndForget((()=>Ko(e,o))),n.fromCache&&"server"===s.source?r.reject(new S(b.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):r.resolve(n)},error:e=>r.reject(e)}),o=new Qo(n,i,{includeMetadataChanges:!0,uc:!0});return Bo(e,o)}(await Ha(e),e.asyncQueue,t,n,s))),s.promise}function Xa(e,t,n,s){const r=function(e,t){let n;return n="string"==typeof e?(new TextEncoder).encode(e):e,function(e,t){return new Va(e,t)}(function(e,t){if(e instanceof Uint8Array)return Ma(e,t);if(e instanceof ArrayBuffer)return Ma(new Uint8Array(e),t);if(e instanceof ReadableStream)return e.getReader();throw new Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}(n),t)}(n,Ji(t));e.asyncQueue.enqueueAndForget((async()=>{!function(e,t,n){const s=E(e);(async function(e,t,n){try{const s=await t.getMetadata();if(await function(e,t){const n=E(e),s=An(t.createTime);return n.persistence.runTransaction("hasNewerBundle","readonly",(e=>n.Kn.getBundleMetadata(e,t.id))).then((e=>!!e&&e.createTime.compareTo(s)>=0))}(e.localStore,s))return await t.close(),void n._completeWith(function(e){return{taskState:"Success",documentsLoaded:e.totalDocuments,bytesLoaded:e.totalBytes,totalDocuments:e.totalDocuments,totalBytes:e.totalBytes}}(s));n._updateProgress(Yo(s));const r=new Ho(s,e.localStore,t.O);let i=await t.Kc();for(;i;){const e=await r.lc(i);e&&n._updateProgress(e),i=await t.Kc()}const o=await r.complete();await wa(e,o.ws,void 0),await function(e,t){const n=E(e);return n.persistence.runTransaction("Save bundle","readwrite",(e=>n.Kn.saveBundleMetadata(e,t)))}(e.localStore,s),n._completeWith(o.progress)}catch(e){y("SyncEngine",`Loading bundle failed with ${e}`),n._failWith(e)}})(s,t,n).then((()=>{s.sharedClientState.notifyBundleLoaded()}))}(await Wa(e),r,s)}))}const Za=new Map;function ec(e,t,n){if(!n)throw new S(b.INVALID_ARGUMENT,`Function ${e}() cannot be called with an empty ${t}.`)}function tc(e,t,n,s){if(!0===t&&!0===s)throw new S(b.INVALID_ARGUMENT,`${e} and ${n} cannot be used together.`)}function nc(e){if(!he.isDocumentKey(e))throw new S(b.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${e} has ${e.length}.`)}function sc(e){if(he.isDocumentKey(e))throw new S(b.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${e} has ${e.length}.`)}function rc(e){if(void 0===e)return"undefined";if(null===e)return"null";if("string"==typeof e)return e.length>20&&(e=`${e.substring(0,20)}...`),JSON.stringify(e);if("number"==typeof e||"boolean"==typeof e)return""+e;if("object"==typeof e){if(e instanceof Array)return"an array";{const t=function(e){return e.constructor?e.constructor.name:null}(e);return t?`a custom ${t} object`:"an object"}}return"function"==typeof e?"a function":v()}function ic(e,t){if("_delegate"in e&&(e=e._delegate),!(e instanceof t)){if(t.name===e.constructor.name)throw new S(b.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{const n=rc(e);throw new S(b.INVALID_ARGUMENT,`Expected type '${t.name}', but it was: ${n}`)}}return e}function oc(e,t){if(t<=0)throw new S(b.INVALID_ARGUMENT,`Function ${e}() requires a positive number, but it was: ${t}.`)}class ac{constructor(e){var t;if(void 0===e.host){if(void 0!==e.ssl)throw new S(b.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=e.host,this.ssl=null===(t=e.ssl)||void 0===t||t;if(this.credentials=e.credentials,this.ignoreUndefinedProperties=!!e.ignoreUndefinedProperties,void 0===e.cacheSizeBytes)this.cacheSizeBytes=41943040;else{if(-1!==e.cacheSizeBytes&&e.cacheSizeBytes<1048576)throw new S(b.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=e.cacheSizeBytes}this.experimentalForceLongPolling=!!e.experimentalForceLongPolling,this.experimentalAutoDetectLongPolling=!!e.experimentalAutoDetectLongPolling,this.useFetchStreams=!!e.useFetchStreams,tc("experimentalForceLongPolling",e.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",e.experimentalAutoDetectLongPolling)}isEqual(e){return this.host===e.host&&this.ssl===e.ssl&&this.credentials===e.credentials&&this.cacheSizeBytes===e.cacheSizeBytes&&this.experimentalForceLongPolling===e.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===e.experimentalAutoDetectLongPolling&&this.ignoreUndefinedProperties===e.ignoreUndefinedProperties&&this.useFetchStreams===e.useFetchStreams}}class cc{constructor(e,t,n){this._authCredentials=t,this._appCheckCredentials=n,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new ac({}),this._settingsFrozen=!1,e instanceof oe?this._databaseId=e:(this._app=e,this._databaseId=function(e){if(!Object.prototype.hasOwnProperty.apply(e.options,["projectId"]))throw new S(b.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new oe(e.options.projectId)}(e))}get app(){if(!this._app)throw new S(b.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return void 0!==this._terminateTask}_setSettings(e){if(this._settingsFrozen)throw new S(b.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new ac(e),void 0!==e.credentials&&(this._authCredentials=function(e){if(!e)return new _;switch(e.type){case"gapi":const t=e.client;return I(!("object"!=typeof t||null===t||!t.auth||!t.auth.getAuthHeaderValueForFirstParty)),new C(t,e.sessionIndex||"0",e.iamToken||null);case"provider":return e.client;default:throw new S(b.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(e.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(e){const t=Za.get(e);t&&(g("ComponentProvider","Removing Datastore"),Za.delete(e),t.terminate())}(this),Promise.resolve()}}function uc(e,t,n,s={}){var r;const i=(e=ic(e,cc))._getSettings();if("firestore.googleapis.com"!==i.host&&i.host!==t&&y("Host has been set in both settings() and useEmulator(), emulator host will be used"),e._setSettings(Object.assign(Object.assign({},i),{host:`${t}:${n}`,ssl:!1})),s.mockUserToken){let t,n;if("string"==typeof s.mockUserToken)t=s.mockUserToken,n=h.MOCK_USER;else{t=(0,o.Sg)(s.mockUserToken,null===(r=e._app)||void 0===r?void 0:r.options.projectId);const i=s.mockUserToken.sub||s.mockUserToken.user_id;if(!i)throw new S(b.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");n=new h(i)}e._authCredentials=new k(new N(t,n))}}class hc{constructor(e,t,n){this.converter=t,this._key=n,this.type="document",this.firestore=e}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new dc(this.firestore,this.converter,this._key.path.popLast())}withConverter(e){return new hc(this.firestore,e,this._key)}}class lc{constructor(e,t,n){this.converter=t,this._query=n,this.type="query",this.firestore=e}withConverter(e){return new lc(this.firestore,e,this._query)}}class dc extends lc{constructor(e,t,n){super(e,t,et(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const e=this._path.popLast();return e.isEmpty()?null:new hc(this.firestore,null,new he(e))}withConverter(e){return new dc(this.firestore,e,this._path)}}function fc(e,t,...n){if(e=(0,o.m9)(e),ec("collection","path",t),e instanceof cc){const s=Q.fromString(t,...n);return sc(s),new dc(e,null,s)}{if(!(e instanceof hc||e instanceof dc))throw new S(b.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const s=e._path.child(Q.fromString(t,...n));return sc(s),new dc(e.firestore,null,s)}}function mc(e,t){if(e=ic(e,cc),ec("collectionGroup","collection id",t),t.indexOf("/")>=0)throw new S(b.INVALID_ARGUMENT,`Invalid collection ID '${t}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new lc(e,null,function(e){return new Xe(Q.emptyPath(),e)}(t))}function gc(e,t,...n){if(e=(0,o.m9)(e),1===arguments.length&&(t=P.R()),ec("doc","path",t),e instanceof cc){const s=Q.fromString(t,...n);return nc(s),new hc(e,null,new he(s))}{if(!(e instanceof hc||e instanceof dc))throw new S(b.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const s=e._path.child(Q.fromString(t,...n));return nc(s),new hc(e.firestore,e instanceof dc?e.converter:null,new he(s))}}function pc(e,t){return e=(0,o.m9)(e),t=(0,o.m9)(t),(e instanceof hc||e instanceof dc)&&(t instanceof hc||t instanceof dc)&&e.firestore===t.firestore&&e.path===t.path&&e.converter===t.converter}function yc(e,t){return e=(0,o.m9)(e),t=(0,o.m9)(t),e instanceof lc&&t instanceof lc&&e.firestore===t.firestore&&ut(e._query,t._query)&&e.converter===t.converter}class wc{constructor(){this.hu=Promise.resolve(),this.lu=[],this.fu=!1,this.du=[],this._u=null,this.wu=!1,this.mu=!1,this.gu=[],this.ro=new Xi(this,"async_queue_retry"),this.yu=()=>{const e=Yi();e&&g("AsyncQueue","Visibility state changed to "+e.visibilityState),this.ro.Yr()};const e=Yi();e&&"function"==typeof e.addEventListener&&e.addEventListener("visibilitychange",this.yu)}get isShuttingDown(){return this.fu}enqueueAndForget(e){this.enqueue(e)}enqueueAndForgetEvenWhileRestricted(e){this.pu(),this.Iu(e)}enterRestrictedMode(e){if(!this.fu){this.fu=!0,this.mu=e||!1;const t=Yi();t&&"function"==typeof t.removeEventListener&&t.removeEventListener("visibilitychange",this.yu)}}enqueue(e){if(this.pu(),this.fu)return new Promise((()=>{}));const t=new x;return this.Iu((()=>this.fu&&this.mu?Promise.resolve():(e().then(t.resolve,t.reject),t.promise))).then((()=>t.promise))}enqueueRetryable(e){this.enqueueAndForget((()=>(this.lu.push(e),this.Eu())))}async Eu(){if(0!==this.lu.length){try{await this.lu[0](),this.lu.shift(),this.ro.reset()}catch(e){if(!Ls(e))throw e;g("AsyncQueue","Operation failed with retryable error: "+e)}this.lu.length>0&&this.ro.Hr((()=>this.Eu()))}}Iu(e){const t=this.hu.then((()=>(this.wu=!0,e().catch((e=>{this._u=e,this.wu=!1;const t=function(e){let t=e.message||"";return e.stack&&(t=e.stack.includes(e.message)?e.stack:e.message+"\n"+e.stack),t}(e);throw p("INTERNAL UNHANDLED ERROR: ",t),e})).then((e=>(this.wu=!1,e))))));return this.hu=t,t}enqueueAfterDelay(e,t,n){this.pu(),this.gu.indexOf(e)>-1&&(t=0);const s=Lo.createAndSchedule(this,e,t,n,(e=>this.Tu(e)));return this.du.push(s),s}pu(){this._u&&v()}verifyOperationInProgress(){}async Au(){let e;do{e=this.hu,await e}while(e!==this.hu)}Ru(e){for(const t of this.du)if(t.timerId===e)return!0;return!1}Pu(e){return this.Au().then((()=>{this.du.sort(((e,t)=>e.targetTimeMs-t.targetTimeMs));for(const t of this.du)if(t.skipDelay(),"all"!==e&&t.timerId===e)break;return this.Au()}))}bu(e){this.gu.push(e)}Tu(e){const t=this.du.indexOf(e);this.du.splice(t,1)}}function vc(e){return function(e,t){if("object"!=typeof e||null===e)return!1;const n=e;for(const s of["next","error","complete"])if(s in n&&"function"==typeof n[s])return!0;return!1}(e)}class Ic{constructor(){this._progressObserver={},this._taskCompletionResolver=new x,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(e,t,n){this._progressObserver={next:e,error:t,complete:n}}catch(e){return this._taskCompletionResolver.promise.catch(e)}then(e,t){return this._taskCompletionResolver.promise.then(e,t)}_completeWith(e){this._updateProgress(e),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(e)}_failWith(e){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(e),this._taskCompletionResolver.reject(e)}_updateProgress(e){this._lastProgress=e,this._progressObserver.next&&this._progressObserver.next(e)}}const Tc=-1;class Ec extends cc{constructor(e,t,n){super(e,t,n),this.type="firestore",this._queue=new wc,this._persistenceKey="name"in e?e.name:"[DEFAULT]"}_terminate(){return this._firestoreClient||Sc(this),this._firestoreClient.terminate()}}function bc(e){return e._firestoreClient||Sc(e),e._firestoreClient.verifyNotTerminated(),e._firestoreClient}function Sc(e){var t;const n=e._freezeSettings(),s=function(e,t,n,s){return new ie(e,t,n,s.host,s.ssl,s.experimentalForceLongPolling,s.experimentalAutoDetectLongPolling,s.useFetchStreams)}(e._databaseId,(null===(t=e._app)||void 0===t?void 0:t.options.appId)||"",e._persistenceKey,n);e._firestoreClient=new Ua(e._authCredentials,e._appCheckCredentials,e._queue,s)}function xc(e,t){Lc(e=ic(e,Ec));const n=bc(e),s=e._freezeSettings(),r=new La;return _c(n,r,new Oa(r,s.cacheSizeBytes,null==t?void 0:t.forceOwnership))}function Nc(e){Lc(e=ic(e,Ec));const t=bc(e),n=e._freezeSettings(),s=new La;return _c(t,s,new Ra(s,n.cacheSizeBytes))}function _c(e,t,n){const s=new x;return e.asyncQueue.enqueue((async()=>{try{await Ba(e,n),await Ka(e,t),s.resolve()}catch(e){if(!function(e){return"FirebaseError"===e.name?e.code===b.FAILED_PRECONDITION||e.code===b.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&e instanceof DOMException)||(22===e.code||20===e.code||11===e.code)}(e))throw e;console.warn("Error enabling offline persistence. Falling back to persistence disabled: "+e),s.reject(e)}})).then((()=>s.promise))}function kc(e){if(e._initialized&&!e._terminated)throw new S(b.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");const t=new x;return e._queue.enqueueAndForgetEvenWhileRestricted((async()=>{try{await async function(e){if(!Cs.Vt())return Promise.resolve();const t=e+"main";await Cs.delete(t)}(oi(e._databaseId,e._persistenceKey)),t.resolve()}catch(e){t.reject(e)}})),t.promise}function Ac(e){return function(e){const t=new x;return e.asyncQueue.enqueueAndForget((async()=>async function(e,t){const n=E(e);mo(n.remoteStore)||g("SyncEngine","The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{const e=await function(e){const t=E(e);return t.persistence.runTransaction("Get highest unacknowledged batch id","readonly",(e=>t.gs.getHighestUnacknowledgedBatchId(e)))}(n.localStore);if(-1===e)return void t.resolve();const s=n.Fc.get(e)||[];s.push(t),n.Fc.set(e,s)}catch(e){const n=Mo(e,"Initialization of waitForPendingWrites() operation failed");t.reject(n)}}(await Wa(e),t))),t.promise}(bc(e=ic(e,Ec)))}function Dc(e){return function(e){return e.asyncQueue.enqueue((async()=>{const t=await ja(e),n=await za(e);return t.setNetworkEnabled(!0),function(e){const t=E(e);return t.Ko.delete(0),io(t)}(n)}))}(bc(e=ic(e,Ec)))}function Cc(e){return function(e){return e.asyncQueue.enqueue((async()=>{const t=await ja(e),n=await za(e);return t.setNetworkEnabled(!1),async function(e){const t=E(e);t.Ko.add(0),await oo(t),t.Qo.set("Offline")}(n)}))}(bc(e=ic(e,Ec)))}function Oc(e,t){const n=bc(e=ic(e,Ec)),s=new Ic;return Xa(n,e._databaseId,t,s),s}function Rc(e,t){return function(e,t){return e.asyncQueue.enqueue((async()=>function(e,t){const n=E(e);return n.persistence.runTransaction("Get named query","readonly",(e=>n.Kn.getNamedQuery(e,t)))}(await Qa(e),t)))}(bc(e=ic(e,Ec)),t).then((t=>t?new lc(e,null,t.query):null))}function Lc(e){if(e._initialized||e._terminated)throw new S(b.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.")}class Mc{constructor(...e){for(let t=0;t<e.length;++t)if(0===e[t].length)throw new S(b.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new W(e)}isEqual(e){return this._internalPath.isEqual(e._internalPath)}}class Pc{constructor(e){this._byteString=e}static fromBase64String(e){try{return new Pc(J.fromBase64String(e))}catch(e){throw new S(b.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+e)}}static fromUint8Array(e){return new Pc(J.fromUint8Array(e))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(e){return this._byteString.isEqual(e._byteString)}}class Vc{constructor(e){this._methodName=e}}class Fc{constructor(e,t){if(!isFinite(e)||e<-90||e>90)throw new S(b.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+e);if(!isFinite(t)||t<-180||t>180)throw new S(b.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+t);this._lat=e,this._long=t}get latitude(){return this._lat}get longitude(){return this._long}isEqual(e){return this._lat===e._lat&&this._long===e._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(e){return V(this._lat,e._lat)||V(this._long,e._long)}}const qc=/^__.*__$/;class Uc{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return null!==this.fieldMask?new Bt(e,this.data,this.fieldMask,t,this.fieldTransforms):new Ut(e,this.data,t,this.fieldTransforms)}}class Bc{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return new Bt(e,this.data,this.fieldMask,t,this.fieldTransforms)}}function Kc(e){switch(e){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw v()}}class Gc{constructor(e,t,n,s,r,i){this.settings=e,this.databaseId=t,this.O=n,this.ignoreUndefinedProperties=s,void 0===r&&this.vu(),this.fieldTransforms=r||[],this.fieldMask=i||[]}get path(){return this.settings.path}get Vu(){return this.settings.Vu}Su(e){return new Gc(Object.assign(Object.assign({},this.settings),e),this.databaseId,this.O,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}Du(e){var t;const n=null===(t=this.path)||void 0===t?void 0:t.child(e),s=this.Su({path:n,Cu:!1});return s.Nu(e),s}xu(e){var t;const n=null===(t=this.path)||void 0===t?void 0:t.child(e),s=this.Su({path:n,Cu:!1});return s.vu(),s}ku(e){return this.Su({path:void 0,Cu:!0})}Ou(e){return uu(e,this.settings.methodName,this.settings.Mu||!1,this.path,this.settings.$u)}contains(e){return void 0!==this.fieldMask.find((t=>e.isPrefixOf(t)))||void 0!==this.fieldTransforms.find((t=>e.isPrefixOf(t.field)))}vu(){if(this.path)for(let e=0;e<this.path.length;e++)this.Nu(this.path.get(e))}Nu(e){if(0===e.length)throw this.Ou("Document fields must not be empty");if(Kc(this.Vu)&&qc.test(e))throw this.Ou('Document fields cannot begin and end with "__"')}}class $c{constructor(e,t,n){this.databaseId=e,this.ignoreUndefinedProperties=t,this.O=n||Ji(e)}Fu(e,t,n,s=!1){return new Gc({Vu:e,methodName:t,$u:n,path:W.emptyPath(),Cu:!1,Mu:s},this.databaseId,this.O,this.ignoreUndefinedProperties)}}function jc(e){const t=e._freezeSettings(),n=Ji(e._databaseId);return new $c(e._databaseId,!!t.ignoreUndefinedProperties,n)}function Qc(e,t,n,s,r,i={}){const o=e.Fu(i.merge||i.mergeFields?2:0,t,n,r);iu("Data must be an object, but it was:",o,s);const a=su(s,o);let c,u;if(i.merge)c=new H(o.fieldMask),u=o.fieldTransforms;else if(i.mergeFields){const e=[];for(const s of i.mergeFields){const r=ou(t,s,n);if(!o.contains(r))throw new S(b.INVALID_ARGUMENT,`Field '${r}' is specified in your field mask but missing from your input data.`);hu(e,r)||e.push(r)}c=new H(e),u=o.fieldTransforms.filter((e=>c.covers(e.field)))}else c=null,u=o.fieldTransforms;return new Uc(new Ne(a),c,u)}class zc extends Vc{_toFieldTransform(e){if(2!==e.Vu)throw 1===e.Vu?e.Ou(`${this._methodName}() can only appear at the top level of your update data`):e.Ou(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return e.fieldMask.push(e.path),null}isEqual(e){return e instanceof zc}}function Wc(e,t,n){return new Gc({Vu:3,$u:t.settings.$u,methodName:e._methodName,Cu:n},t.databaseId,t.O,t.ignoreUndefinedProperties)}class Hc extends Vc{_toFieldTransform(e){return new Dt(e.path,new Et)}isEqual(e){return e instanceof Hc}}class Yc extends Vc{constructor(e,t){super(e),this.Bu=t}_toFieldTransform(e){const t=Wc(this,e,!0),n=this.Bu.map((e=>nu(e,t))),s=new bt(n);return new Dt(e.path,s)}isEqual(e){return this===e}}class Jc extends Vc{constructor(e,t){super(e),this.Bu=t}_toFieldTransform(e){const t=Wc(this,e,!0),n=this.Bu.map((e=>nu(e,t))),s=new xt(n);return new Dt(e.path,s)}isEqual(e){return this===e}}class Xc extends Vc{constructor(e,t){super(e),this.Lu=t}_toFieldTransform(e){const t=new _t(e.O,yt(e.O,this.Lu));return new Dt(e.path,t)}isEqual(e){return this===e}}function Zc(e,t,n,s){const r=e.Fu(1,t,n);iu("Data must be an object, but it was:",r,s);const i=[],a=Ne.empty();G(s,((e,s)=>{const c=cu(t,e,n);s=(0,o.m9)(s);const u=r.xu(c);if(s instanceof zc)i.push(c);else{const e=nu(s,u);null!=e&&(i.push(c),a.set(c,e))}}));const c=new H(i);return new Bc(a,c,r.fieldTransforms)}function eu(e,t,n,s,r,i){const a=e.Fu(1,t,n),c=[ou(t,s,n)],u=[r];if(i.length%2!=0)throw new S(b.INVALID_ARGUMENT,`Function ${t}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let o=0;o<i.length;o+=2)c.push(ou(t,i[o])),u.push(i[o+1]);const h=[],l=Ne.empty();for(let f=c.length-1;f>=0;--f)if(!hu(h,c[f])){const e=c[f];let t=u[f];t=(0,o.m9)(t);const n=a.xu(e);if(t instanceof zc)h.push(e);else{const s=nu(t,n);null!=s&&(h.push(e),l.set(e,s))}}const d=new H(h);return new Bc(l,d,a.fieldTransforms)}function tu(e,t,n,s=!1){return nu(n,e.Fu(s?4:3,t))}function nu(e,t){if(ru(e=(0,o.m9)(e)))return iu("Unsupported field value:",t,e),su(e,t);if(e instanceof Vc)return function(e,t){if(!Kc(t.Vu))throw t.Ou(`${e._methodName}() can only be used with update() and set()`);if(!t.path)throw t.Ou(`${e._methodName}() is not currently supported inside arrays`);const n=e._toFieldTransform(t);n&&t.fieldTransforms.push(n)}(e,t),null;if(void 0===e&&t.ignoreUndefinedProperties)return null;if(t.path&&t.fieldMask.push(t.path),e instanceof Array){if(t.settings.Cu&&4!==t.Vu)throw t.Ou("Nested arrays are not supported");return function(e,t){const n=[];let s=0;for(const r of e){let e=nu(r,t.ku(s));null==e&&(e={nullValue:"NULL_VALUE"}),n.push(e),s++}return{arrayValue:{values:n}}}(e,t)}return function(e,t){if(null===(e=(0,o.m9)(e)))return{nullValue:"NULL_VALUE"};if("number"==typeof e)return yt(t.O,e);if("boolean"==typeof e)return{booleanValue:e};if("string"==typeof e)return{stringValue:e};if(e instanceof Date){const n=U.fromDate(e);return{timestampValue:Nn(t.O,n)}}if(e instanceof U){const n=new U(e.seconds,1e3*Math.floor(e.nanoseconds/1e3));return{timestampValue:Nn(t.O,n)}}if(e instanceof Fc)return{geoPointValue:{latitude:e.latitude,longitude:e.longitude}};if(e instanceof Pc)return{bytesValue:_n(t.O,e._byteString)};if(e instanceof hc){const n=t.databaseId,s=e.firestore._databaseId;if(!s.isEqual(n))throw t.Ou(`Document reference is for database ${s.projectId}/${s.database} but should be for database ${n.projectId}/${n.database}`);return{referenceValue:Dn(e.firestore._databaseId||t.databaseId,e._key.path)}}throw t.Ou(`Unsupported field value: ${rc(e)}`)}(e,t)}function su(e,t){const n={};return $(e)?t.path&&t.path.length>0&&t.fieldMask.push(t.path):G(e,((e,s)=>{const r=nu(s,t.Du(e));null!=r&&(n[e]=r)})),{mapValue:{fields:n}}}function ru(e){return!("object"!=typeof e||null===e||e instanceof Array||e instanceof Date||e instanceof U||e instanceof Fc||e instanceof Pc||e instanceof hc||e instanceof Vc)}function iu(e,t,n){if(!ru(n)||!function(e){return"object"==typeof e&&null!==e&&(Object.getPrototypeOf(e)===Object.prototype||null===Object.getPrototypeOf(e))}(n)){const s=rc(n);throw"an object"===s?t.Ou(e+" a custom object"):t.Ou(e+" "+s)}}function ou(e,t,n){if((t=(0,o.m9)(t))instanceof Mc)return t._internalPath;if("string"==typeof t)return cu(e,t);throw uu("Field path arguments must be of type string or ",e,!1,void 0,n)}const au=new RegExp("[~\\*/\\[\\]]");function cu(e,t,n){if(t.search(au)>=0)throw uu(`Invalid field path (${t}). Paths must not contain '~', '*', '/', '[', or ']'`,e,!1,void 0,n);try{return new Mc(...t.split("."))._internalPath}catch(s){throw uu(`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,e,!1,void 0,n)}}function uu(e,t,n,s,r){const i=s&&!s.isEmpty(),o=void 0!==r;let a=`Function ${t}() called with invalid data`;n&&(a+=" (via `toFirestore()`)"),a+=". ";let c="";return(i||o)&&(c+=" (found",i&&(c+=` in field ${s}`),o&&(c+=` in document ${r}`),c+=")"),new S(b.INVALID_ARGUMENT,a+e+c)}function hu(e,t){return e.some((e=>e.isEqual(t)))}class lu{constructor(e,t,n,s,r){this._firestore=e,this._userDataWriter=t,this._key=n,this._document=s,this._converter=r}get id(){return this._key.path.lastSegment()}get ref(){return new hc(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){const e=new du(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(e)}return this._userDataWriter.convertValue(this._document.data.value)}}get(e){if(this._document){const t=this._document.data.field(fu("DocumentSnapshot.get",e));if(null!==t)return this._userDataWriter.convertValue(t)}}}class du extends lu{data(){return super.data()}}function fu(e,t){return"string"==typeof t?cu(e,t):t instanceof Mc?t._internalPath:t._delegate._internalPath}class mu{constructor(e,t){this.hasPendingWrites=e,this.fromCache=t}isEqual(e){return this.hasPendingWrites===e.hasPendingWrites&&this.fromCache===e.fromCache}}class gu extends lu{constructor(e,t,n,s,r,i){super(e,t,n,s,i),this._firestore=e,this._firestoreImpl=e,this.metadata=r}exists(){return super.exists()}data(e={}){if(this._document){if(this._converter){const t=new pu(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(t,e)}return this._userDataWriter.convertValue(this._document.data.value,e.serverTimestamps)}}get(e,t={}){if(this._document){const n=this._document.data.field(fu("DocumentSnapshot.get",e));if(null!==n)return this._userDataWriter.convertValue(n,t.serverTimestamps)}}}class pu extends gu{data(e={}){return super.data(e)}}class yu{constructor(e,t,n,s){this._firestore=e,this._userDataWriter=t,this._snapshot=s,this.metadata=new mu(s.hasPendingWrites,s.fromCache),this.query=n}get docs(){const e=[];return this.forEach((t=>e.push(t))),e}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(e,t){this._snapshot.docs.forEach((n=>{e.call(t,new pu(this._firestore,this._userDataWriter,n.key,n,new mu(this._snapshot.mutatedKeys.has(n.key),this._snapshot.fromCache),this.query.converter))}))}docChanges(e={}){const t=!!e.includeMetadataChanges;if(t&&this._snapshot.excludesMetadataChanges)throw new S(b.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===t||(this._cachedChanges=function(e,t){if(e._snapshot.oldDocs.isEmpty()){let t=0;return e._snapshot.docChanges.map((n=>({type:"added",doc:new pu(e._firestore,e._userDataWriter,n.doc.key,n.doc,new mu(e._snapshot.mutatedKeys.has(n.doc.key),e._snapshot.fromCache),e.query.converter),oldIndex:-1,newIndex:t++})))}{let n=e._snapshot.oldDocs;return e._snapshot.docChanges.filter((e=>t||3!==e.type)).map((t=>{const s=new pu(e._firestore,e._userDataWriter,t.doc.key,t.doc,new mu(e._snapshot.mutatedKeys.has(t.doc.key),e._snapshot.fromCache),e.query.converter);let r=-1,i=-1;return 0!==t.type&&(r=n.indexOf(t.doc.key),n=n.delete(t.doc.key)),1!==t.type&&(n=n.add(t.doc),i=n.indexOf(t.doc.key)),{type:wu(t.type),doc:s,oldIndex:r,newIndex:i}}))}}(this,t),this._cachedChangesIncludeMetadataChanges=t),this._cachedChanges}}function wu(e){switch(e){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return v()}}function vu(e,t){return e instanceof gu&&t instanceof gu?e._firestore===t._firestore&&e._key.isEqual(t._key)&&(null===e._document?null===t._document:e._document.isEqual(t._document))&&e._converter===t._converter:e instanceof yu&&t instanceof yu&&e._firestore===t._firestore&&yc(e.query,t.query)&&e.metadata.isEqual(t.metadata)&&e._snapshot.isEqual(t._snapshot)}function Iu(e){if(nt(e)&&0===e.explicitOrderBy.length)throw new S(b.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class Tu{}function Eu(e,...t){for(const n of t)e=n._apply(e);return e}class bu extends Tu{constructor(e,t,n){super(),this.Uu=e,this.qu=t,this.Ku=n,this.type="where"}_apply(e){const t=jc(e.firestore),n=function(e,t,n,s,r,i,o){let a;if(r.isKeyField()){if("array-contains"===i||"array-contains-any"===i)throw new S(b.INVALID_ARGUMENT,`Invalid Query. You can't perform '${i}' queries on documentId().`);if("in"===i||"not-in"===i){Fu(o,i);const t=[];for(const n of o)t.push(Vu(s,e,n));a={arrayValue:{values:t}}}else a=Vu(s,e,o)}else"in"!==i&&"not-in"!==i&&"array-contains-any"!==i||Fu(o,i),a=tu(n,"where",o,"in"===i||"not-in"===i);const c=Fe.create(r,i,a);return function(e,t){if(t.S()){const n=rt(e);if(null!==n&&!n.isEqual(t.field))throw new S(b.INVALID_ARGUMENT,`Invalid query. All where filters with an inequality (<, <=, !=, not-in, >, or >=) must be on the same field. But you have inequality filters on '${n.toString()}' and '${t.field.toString()}'`);const s=st(e);null!==s&&qu(e,t.field,s)}const n=function(e,t){for(const n of e.filters)if(t.indexOf(n.op)>=0)return n.op;return null}(e,function(e){switch(e){case"!=":return["!=","not-in"];case"array-contains":return["array-contains","array-contains-any","not-in"];case"in":return["array-contains-any","in","not-in"];case"array-contains-any":return["array-contains","array-contains-any","in","not-in"];case"not-in":return["array-contains","array-contains-any","in","not-in","!="];default:return[]}}(t.op));if(null!==n)throw n===t.op?new S(b.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${t.op.toString()}' filter.`):new S(b.INVALID_ARGUMENT,`Invalid query. You cannot use '${t.op.toString()}' filters with '${n.toString()}' filters.`)}(e,c),c}(e._query,0,t,e.firestore._databaseId,this.Uu,this.qu,this.Ku);return new lc(e.firestore,e.converter,function(e,t){const n=e.filters.concat([t]);return new Xe(e.path,e.collectionGroup,e.explicitOrderBy.slice(),n,e.limit,e.limitType,e.startAt,e.endAt)}(e._query,n))}}function Su(e,t,n){const s=t,r=fu("where",e);return new bu(r,s,n)}class xu extends Tu{constructor(e,t){super(),this.Uu=e,this.Gu=t,this.type="orderBy"}_apply(e){const t=function(e,t,n){if(null!==e.startAt)throw new S(b.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==e.endAt)throw new S(b.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");const s=new We(t,n);return function(e,t){if(null===st(e)){const n=rt(e);null!==n&&qu(e,n,t.field)}}(e,s),s}(e._query,this.Uu,this.Gu);return new lc(e.firestore,e.converter,function(e,t){const n=e.explicitOrderBy.concat([t]);return new Xe(e.path,e.collectionGroup,n,e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)}(e._query,t))}}function Nu(e,t="asc"){const n=t,s=fu("orderBy",e);return new xu(s,n)}class _u extends Tu{constructor(e,t,n){super(),this.type=e,this.ju=t,this.Qu=n}_apply(e){return new lc(e.firestore,e.converter,ct(e._query,this.ju,this.Qu))}}function ku(e){return oc("limit",e),new _u("limit",e,"F")}function Au(e){return oc("limitToLast",e),new _u("limitToLast",e,"L")}class Du extends Tu{constructor(e,t,n){super(),this.type=e,this.Wu=t,this.zu=n}_apply(e){const t=Pu(e,this.type,this.Wu,this.zu);return new lc(e.firestore,e.converter,function(e,t){return new Xe(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,t,e.endAt)}(e._query,t))}}function Cu(...e){return new Du("startAt",e,!0)}function Ou(...e){return new Du("startAfter",e,!1)}class Ru extends Tu{constructor(e,t,n){super(),this.type=e,this.Wu=t,this.zu=n}_apply(e){const t=Pu(e,this.type,this.Wu,this.zu);return new lc(e.firestore,e.converter,function(e,t){return new Xe(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,e.startAt,t)}(e._query,t))}}function Lu(...e){return new Ru("endBefore",e,!1)}function Mu(...e){return new Ru("endAt",e,!0)}function Pu(e,t,n,s){if(n[0]=(0,o.m9)(n[0]),n[0]instanceof lu)return function(e,t,n,s,r){if(!s)throw new S(b.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${n}().`);const i=[];for(const o of ot(e))if(o.field.isKeyField())i.push(ve(t,s.key));else{const e=s.data.field(o.field);if(ne(e))throw new S(b.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+o.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===e){const e=o.field.canonicalString();throw new S(b.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${e}' (used as the orderBy) does not exist.`)}i.push(e)}return new ze(i,r)}(e._query,e.firestore._databaseId,t,n[0]._document,s);{const r=jc(e.firestore);return function(e,t,n,s,r,i){const o=e.explicitOrderBy;if(r.length>o.length)throw new S(b.INVALID_ARGUMENT,`Too many arguments provided to ${s}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);const a=[];for(let c=0;c<r.length;c++){const i=r[c];if(o[c].field.isKeyField()){if("string"!=typeof i)throw new S(b.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${s}(), but got a ${typeof i}`);if(!it(e)&&-1!==i.indexOf("/"))throw new S(b.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${s}() must be a plain document ID, but '${i}' contains a slash.`);const n=e.path.child(Q.fromString(i));if(!he.isDocumentKey(n))throw new S(b.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${s}() must result in a valid document path, but '${n}' is not because it contains an odd number of segments.`);const r=new he(n);a.push(ve(t,r))}else{const e=tu(n,s,i);a.push(e)}}return new ze(a,i)}(e._query,e.firestore._databaseId,r,t,n,s)}}function Vu(e,t,n){if("string"==typeof(n=(0,o.m9)(n))){if(""===n)throw new S(b.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!it(t)&&-1!==n.indexOf("/"))throw new S(b.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${n}' contains a '/' character.`);const s=t.path.child(Q.fromString(n));if(!he.isDocumentKey(s))throw new S(b.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${s}' is not because it has an odd number of segments (${s.length}).`);return ve(e,new he(s))}if(n instanceof hc)return ve(e,n._key);throw new S(b.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${rc(n)}.`)}function Fu(e,t){if(!Array.isArray(e)||0===e.length)throw new S(b.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${t.toString()}' filters.`);if(e.length>10)throw new S(b.INVALID_ARGUMENT,`Invalid Query. '${t.toString()}' filters support a maximum of 10 elements in the value array.`)}function qu(e,t,n){if(!n.isEqual(t))throw new S(b.INVALID_ARGUMENT,`Invalid query. You have a where filter with an inequality (<, <=, !=, not-in, >, or >=) on field '${t.toString()}' and so you must also use '${t.toString()}' as your first argument to orderBy(), but your first orderBy() is on field '${n.toString()}' instead.`)}class Uu{convertValue(e,t="none"){switch(de(e)){case 0:return null;case 1:return e.booleanValue;case 2:return ee(e.integerValue||e.doubleValue);case 3:return this.convertTimestamp(e.timestampValue);case 4:return this.convertServerTimestamp(e,t);case 5:return e.stringValue;case 6:return this.convertBytes(te(e.bytesValue));case 7:return this.convertReference(e.referenceValue);case 8:return this.convertGeoPoint(e.geoPointValue);case 9:return this.convertArray(e.arrayValue,t);case 10:return this.convertObject(e.mapValue,t);default:throw v()}}convertObject(e,t){const n={};return G(e.fields,((e,s)=>{n[e]=this.convertValue(s,t)})),n}convertGeoPoint(e){return new Fc(ee(e.latitude),ee(e.longitude))}convertArray(e,t){return(e.values||[]).map((e=>this.convertValue(e,t)))}convertServerTimestamp(e,t){switch(t){case"previous":const n=se(e);return null==n?null:this.convertValue(n,t);case"estimate":return this.convertTimestamp(re(e));default:return null}}convertTimestamp(e){const t=Z(e);return new U(t.seconds,t.nanos)}convertDocumentKey(e,t){const n=Q.fromString(e);I(Zn(n));const s=new oe(n.get(1),n.get(3)),r=new he(n.popFirst(5));return s.isEqual(t)||p(`Document ${r} contains a document reference within a different database (${s.projectId}/${s.database}) which is not supported. It will be treated as a reference in the current database (${t.projectId}/${t.database}) instead.`),r}}function Bu(e,t,n){let s;return s=e?n&&(n.merge||n.mergeFields)?e.toFirestore(t,n):e.toFirestore(t):t,s}class Ku extends Uu{constructor(e){super(),this.firestore=e}convertBytes(e){return new Pc(e)}convertReference(e){const t=this.convertDocumentKey(e,this.firestore._databaseId);return new hc(this.firestore,null,t)}}class Gu{constructor(e,t){this._firestore=e,this._commitHandler=t,this._mutations=[],this._committed=!1,this._dataReader=jc(e)}set(e,t,n){this._verifyNotCommitted();const s=$u(e,this._firestore),r=Bu(s.converter,t,n),i=Qc(this._dataReader,"WriteBatch.set",s._key,r,null!==s.converter,n);return this._mutations.push(i.toMutation(s._key,Ot.none())),this}update(e,t,n,...s){this._verifyNotCommitted();const r=$u(e,this._firestore);let i;return i="string"==typeof(t=(0,o.m9)(t))||t instanceof Mc?eu(this._dataReader,"WriteBatch.update",r._key,t,n,s):Zc(this._dataReader,"WriteBatch.update",r._key,t),this._mutations.push(i.toMutation(r._key,Ot.exists(!0))),this}delete(e){this._verifyNotCommitted();const t=$u(e,this._firestore);return this._mutations=this._mutations.concat(new jt(t._key,Ot.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,this._mutations.length>0?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new S(b.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}}function $u(e,t){if((e=(0,o.m9)(e)).firestore!==t)throw new S(b.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return e}function ju(e){e=ic(e,hc);const t=ic(e.firestore,Ec);return Ya(bc(t),e._key).then((n=>ih(t,e,n)))}class Qu extends Uu{constructor(e){super(),this.firestore=e}convertBytes(e){return new Pc(e)}convertReference(e){const t=this.convertDocumentKey(e,this.firestore._databaseId);return new hc(this.firestore,null,t)}}function zu(e){e=ic(e,hc);const t=ic(e.firestore,Ec),n=bc(t),s=new Qu(t);return function(e,t){const n=new x;return e.asyncQueue.enqueueAndForget((async()=>async function(e,t,n){try{const s=await function(e,t){const n=E(e);return n.persistence.runTransaction("read document","readonly",(e=>n.Us.ys(e,t)))}(e,t);s.isFoundDocument()?n.resolve(s):s.isNoDocument()?n.resolve(null):n.reject(new S(b.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(e){const s=Mo(e,`Failed to get document '${t} from cache`);n.reject(s)}}(await Qa(e),t,n))),n.promise}(n,e._key).then((n=>new gu(t,s,e._key,n,new mu(null!==n&&n.hasLocalMutations,!0),e.converter)))}function Wu(e){e=ic(e,hc);const t=ic(e.firestore,Ec);return Ya(bc(t),e._key,{source:"server"}).then((n=>ih(t,e,n)))}function Hu(e){e=ic(e,lc);const t=ic(e.firestore,Ec),n=bc(t),s=new Qu(t);return Iu(e._query),Ja(n,e._query).then((n=>new yu(t,s,e,n)))}function Yu(e){e=ic(e,lc);const t=ic(e.firestore,Ec),n=bc(t),s=new Qu(t);return function(e,t){const n=new x;return e.asyncQueue.enqueueAndForget((async()=>async function(e,t,n){try{const s=await vi(e,t,!0),r=new Zo(t,s.Ks),i=r.Ic(s.documents),o=r.applyChanges(i,!1);n.resolve(o.snapshot)}catch(e){const s=Mo(e,`Failed to execute query '${t} against cache`);n.reject(s)}}(await Qa(e),t,n))),n.promise}(n,e._query).then((n=>new yu(t,s,e,n)))}function Ju(e){e=ic(e,lc);const t=ic(e.firestore,Ec),n=bc(t),s=new Qu(t);return Ja(n,e._query,{source:"server"}).then((n=>new yu(t,s,e,n)))}function Xu(e,t,n){e=ic(e,hc);const s=ic(e.firestore,Ec),r=Bu(e.converter,t,n);return rh(s,[Qc(jc(s),"setDoc",e._key,r,null!==e.converter,n).toMutation(e._key,Ot.none())])}function Zu(e,t,n,...s){e=ic(e,hc);const r=ic(e.firestore,Ec),i=jc(r);let a;return a="string"==typeof(t=(0,o.m9)(t))||t instanceof Mc?eu(i,"updateDoc",e._key,t,n,s):Zc(i,"updateDoc",e._key,t),rh(r,[a.toMutation(e._key,Ot.exists(!0))])}function eh(e){return rh(ic(e.firestore,Ec),[new jt(e._key,Ot.none())])}function th(e,t){const n=ic(e.firestore,Ec),s=gc(e),r=Bu(e.converter,t);return rh(n,[Qc(jc(e.firestore),"addDoc",s._key,r,null!==e.converter,{}).toMutation(s._key,Ot.exists(!1))]).then((()=>s))}function nh(e,...t){var n,s,r;e=(0,o.m9)(e);let i={includeMetadataChanges:!1},a=0;"object"!=typeof t[a]||vc(t[a])||(i=t[a],a++);const c={includeMetadataChanges:i.includeMetadataChanges};if(vc(t[a])){const e=t[a];t[a]=null===(n=e.next)||void 0===n?void 0:n.bind(e),t[a+1]=null===(s=e.error)||void 0===s?void 0:s.bind(e),t[a+2]=null===(r=e.complete)||void 0===r?void 0:r.bind(e)}let u,h,l;if(e instanceof hc)h=ic(e.firestore,Ec),l=et(e._key.path),u={next:n=>{t[a]&&t[a](ih(h,e,n))},error:t[a+1],complete:t[a+2]};else{const n=ic(e,lc);h=ic(n.firestore,Ec),l=n._query;const s=new Qu(h);u={next:e=>{t[a]&&t[a](new yu(h,s,n,e))},error:t[a+1],complete:t[a+2]},Iu(e._query)}return function(e,t,n,s){const r=new Pa(s),i=new Qo(t,r,n);return e.asyncQueue.enqueueAndForget((async()=>Bo(await Ha(e),i))),()=>{r.Jc(),e.asyncQueue.enqueueAndForget((async()=>Ko(await Ha(e),i)))}}(bc(h),l,c,u)}function sh(e,t){return function(e,t){const n=new Pa(t);return e.asyncQueue.enqueueAndForget((async()=>function(e,t){E(e).Zo.add(t),t.next()}(await Ha(e),n))),()=>{n.Jc(),e.asyncQueue.enqueueAndForget((async()=>function(e,t){E(e).Zo.delete(t)}(await Ha(e),n)))}}(bc(e=ic(e,Ec)),vc(t)?t:{next:t})}function rh(e,t){return function(e,t){const n=new x;return e.asyncQueue.enqueueAndForget((async()=>async function(e,t,n){const s=Da(e);try{const e=await function(e,t){const n=E(e),s=U.now(),r=t.reduce(((e,t)=>e.add(t.key)),ln());let i;return n.persistence.runTransaction("Locally write mutations","readwrite",(e=>n.Us.Es(e,r).next((r=>{i=r;const o=[];for(const e of t){const t=Vt(e,i.get(e.key));null!=t&&o.push(new Bt(e.key,t,_e(t.value.mapValue),Ot.exists(!0)))}return n.gs.addMutationBatch(e,s,o,t)})))).then((e=>(e.applyToLocalDocumentSet(i),{batchId:e.batchId,changes:i})))}(s.localStore,t);s.sharedClientState.addPendingMutation(e.batchId),function(e,t,n){let s=e.$c[e.currentUser.toKey()];s||(s=new Xt(V)),s=s.insert(t,n),e.$c[e.currentUser.toKey()]=s}(s,e.batchId,n),await wa(s,e.changes),await To(s.remoteStore)}catch(e){const t=Mo(e,"Failed to persist write");n.reject(t)}}(await Wa(e),t,n))),n.promise}(bc(e),t)}function ih(e,t,n){const s=n.docs.get(t._key),r=new Qu(e);return new gu(e,r,t._key,s,new mu(n.hasPendingWrites,n.fromCache),t.converter)}class oh extends class{constructor(e,t){this._firestore=e,this._transaction=t,this._dataReader=jc(e)}get(e){const t=$u(e,this._firestore),n=new Ku(this._firestore);return this._transaction.lookup([t._key]).then((e=>{if(!e||1!==e.length)return v();const s=e[0];if(s.isFoundDocument())return new lu(this._firestore,n,s.key,s,t.converter);if(s.isNoDocument())return new lu(this._firestore,n,t._key,null,t.converter);throw v()}))}set(e,t,n){const s=$u(e,this._firestore),r=Bu(s.converter,t,n),i=Qc(this._dataReader,"Transaction.set",s._key,r,null!==s.converter,n);return this._transaction.set(s._key,i),this}update(e,t,n,...s){const r=$u(e,this._firestore);let i;return i="string"==typeof(t=(0,o.m9)(t))||t instanceof Mc?eu(this._dataReader,"Transaction.update",r._key,t,n,s):Zc(this._dataReader,"Transaction.update",r._key,t),this._transaction.update(r._key,i),this}delete(e){const t=$u(e,this._firestore);return this._transaction.delete(t._key),this}}{constructor(e,t){super(e,t),this._firestore=e}get(e){const t=$u(e,this._firestore),n=new Qu(this._firestore);return super.get(e).then((e=>new gu(this._firestore,n,t._key,e._document,new mu(!1,!1),t.converter)))}}function ah(e,t){return function(e,t){const n=new x;return e.asyncQueue.enqueueAndForget((async()=>{const s=await function(e){return $a(e).then((e=>e.datastore))}(e);new qa(e.asyncQueue,s,t,n).run()})),n.promise}(bc(e=ic(e,Ec)),(n=>t(new oh(e,n))))}function ch(){return new zc("deleteField")}function uh(){return new Hc("serverTimestamp")}function hh(...e){return new Yc("arrayUnion",e)}function lh(...e){return new Jc("arrayRemove",e)}function dh(e){return new Xc("increment",e)}!function(e,t=!0){!function(e){l=e}(s.SDK_VERSION),(0,s._registerComponent)(new r.wA("firestore",((e,{options:n})=>{const s=e.getProvider("app").getImmediate(),r=new Ec(s,new A(e.getProvider("auth-internal")),new R(e.getProvider("app-check-internal")));return n=Object.assign({useFetchStreams:t},n),r._setSettings(n),r}),"PUBLIC")),(0,s.registerVersion)(u,"3.4.5",e),(0,s.registerVersion)(u,"3.4.5","esm2017")}()}}]);